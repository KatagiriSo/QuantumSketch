/*
 * ATTENTION: The "eval" devtool has been used (maybe by default in mode: "development").
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
/******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/******/ 	var __webpack_modules__ = ({

/***/ "./src/Config.ts":
/*!***********************!*\
  !*** ./src/Config.ts ***!
  \***********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"config\": () => (/* binding */ config)\n/* harmony export */ });\nvar config = {\n    /// lattice size\n    scale: 15,\n    log: \"VER\",\n};\n\n\n//# sourceURL=webpack://rdfeyn/./src/Config.ts?");

/***/ }),

/***/ "./src/Core/Elem.ts":
/*!**************************!*\
  !*** ./src/Core/Elem.ts ***!
  \**************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"getElemID\": () => (/* binding */ getElemID),\n/* harmony export */   \"getElemIDCounter\": () => (/* binding */ getElemIDCounter),\n/* harmony export */   \"setElemIDCounter\": () => (/* binding */ setElemIDCounter)\n/* harmony export */ });\nvar elemIDCounter = 0;\n// ElemIDCounter is a global variable that is used to generate unique IDs for\nfunction getElemID() {\n    var id = \"\".concat(elemIDCounter);\n    elemIDCounter++;\n    return id;\n}\nfunction setElemIDCounter(next) {\n    elemIDCounter = Math.max(0, Math.floor(next));\n}\nfunction getElemIDCounter() {\n    return elemIDCounter;\n}\n\n\n//# sourceURL=webpack://rdfeyn/./src/Core/Elem.ts?");

/***/ }),

/***/ "./src/Core/Group.ts":
/*!***************************!*\
  !*** ./src/Core/Group.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"Group\": () => (/* binding */ Group),\n/* harmony export */   \"isGroup\": () => (/* binding */ isGroup)\n/* harmony export */ });\n/* harmony import */ var _Elem__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./Elem */ \"./src/Core/Elem.ts\");\n/* harmony import */ var _Loop__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./Loop */ \"./src/Core/Loop.ts\");\n/* harmony import */ var _MyString__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./MyString */ \"./src/Core/MyString.ts\");\n/* harmony import */ var _Vector__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./Vector */ \"./src/Core/Vector.ts\");\n\n\n\n\nvar Group = /** @class */ (function () {\n    function Group(elements) {\n        this.shape = \"Group\";\n        this.elements = [];\n        this.id = (0,_Elem__WEBPACK_IMPORTED_MODULE_0__.getElemID)();\n        this.elements = elements;\n    }\n    Group.prototype.first = function () {\n        if (this.elements.length === 0) {\n            return undefined;\n        }\n        return this.elements[0];\n    };\n    Group.prototype.formalDistance = function (point) {\n        if (this.elements.length === 0) {\n            return Infinity;\n        }\n        var minDistance = Infinity;\n        for (var _i = 0, _a = this.elements; _i < _a.length; _i++) {\n            var elem = _a[_i];\n            var distance = elem.formalDistance(point);\n            if (distance < minDistance) {\n                minDistance = distance;\n            }\n        }\n        return minDistance;\n    };\n    Group.prototype.move = function (delta) {\n        for (var _i = 0, _a = this.elements; _i < _a.length; _i++) {\n            var elem = _a[_i];\n            elem.move(delta);\n        }\n    };\n    Group.prototype.copy = function () {\n        var elementsCopy = [];\n        for (var _i = 0, _a = this.elements; _i < _a.length; _i++) {\n            var elem = _a[_i];\n            elementsCopy.push(elem.copy());\n        }\n        return new Group(elementsCopy);\n    };\n    Group.prototype.moveAbsolute = function (location) {\n        if (this.elements.length === 0) {\n            return;\n        }\n        var first = this.elements[0];\n        if ((0,_Vector__WEBPACK_IMPORTED_MODULE_3__.isVector)(first)) {\n            var delta = location.minus(first);\n            this.move(delta);\n        }\n        else if ((0,_Loop__WEBPACK_IMPORTED_MODULE_1__.isLoop)(first)) {\n            var delta = location.minus(first.origin);\n            this.move(delta);\n        }\n        else if ((0,_MyString__WEBPACK_IMPORTED_MODULE_2__.isString)(first)) {\n            var delta = location.minus(first.origin);\n            this.move(delta);\n        }\n        else if (isGroup(first)) {\n            first.moveAbsolute(location);\n        }\n        else {\n        }\n    };\n    Group.prototype.description = function () {\n        var desc = \"\".concat(this.shape, \" id:\").concat(this.id, \" elements:\");\n        for (var _i = 0, _a = this.elements; _i < _a.length; _i++) {\n            var elem = _a[_i];\n            desc += elem.description() + \" \";\n        }\n        return desc;\n    };\n    Group.prototype.save = function () {\n        var saveData = {};\n        saveData[\"id\"] = this.id;\n        saveData[\"shape\"] = this.shape;\n        saveData[\"elements\"] = [];\n        for (var _i = 0, _a = this.elements; _i < _a.length; _i++) {\n            var elem = _a[_i];\n            saveData[\"elements\"].push(elem.save());\n        }\n        return saveData;\n    };\n    return Group;\n}());\n\nfunction isGroup(elem) {\n    return elem.shape == \"Group\";\n}\n\n\n//# sourceURL=webpack://rdfeyn/./src/Core/Group.ts?");

/***/ }),

/***/ "./src/Core/Line.ts":
/*!**************************!*\
  !*** ./src/Core/Line.ts ***!
  \**************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"Line\": () => (/* binding */ Line),\n/* harmony export */   \"isLine\": () => (/* binding */ isLine),\n/* harmony export */   \"makeLine\": () => (/* binding */ makeLine)\n/* harmony export */ });\n/* harmony import */ var _Elem__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./Elem */ \"./src/Core/Elem.ts\");\n/* harmony import */ var _Vector__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./Vector */ \"./src/Core/Vector.ts\");\n/* harmony import */ var _Vertex__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./Vertex */ \"./src/Core/Vertex.ts\");\n\n\n\n/**\n * Graph edge. Geometry is resolved from vertex references.\n */\nvar Line = /** @class */ (function () {\n    function Line(label, style) {\n        this.shape = \"Line\";\n        this.label = \"\";\n        this.style = \"normal\";\n        this.labelDiff = 0;\n        this.allow = true;\n        this.control = null;\n        this.arrowRotation = 0;\n        this.startVertexId = \"\";\n        this.endVertexId = \"\";\n        this.fallbackOrigin = new _Vector__WEBPACK_IMPORTED_MODULE_1__.Vector(0, 0);\n        this.fallbackTo = new _Vector__WEBPACK_IMPORTED_MODULE_1__.Vector(0, 0);\n        this.id = (0,_Elem__WEBPACK_IMPORTED_MODULE_0__.getElemID)();\n        if (label) {\n            this.label = label;\n        }\n        if (style) {\n            this.style = style;\n        }\n    }\n    Line.prototype.save = function () {\n        var saveData = {};\n        saveData[\"id\"] = this.id;\n        saveData[\"shape\"] = this.shape;\n        saveData[\"label\"] = this.label;\n        saveData[\"style\"] = this.style;\n        saveData[\"allow\"] = this.allow;\n        saveData[\"labelDiff\"] = this.labelDiff;\n        saveData[\"arrowRotation\"] = this.arrowRotation;\n        saveData[\"control\"] = this.control ? this.control.save() : null;\n        saveData[\"startVertexId\"] = this.startVertexId;\n        saveData[\"endVertexId\"] = this.endVertexId;\n        saveData[\"origin\"] = this.origin.save();\n        saveData[\"to\"] = this.to.save();\n        return saveData;\n    };\n    Line.prototype.copy = function () {\n        var line = new Line();\n        line.id = this.id;\n        line.label = this.label;\n        line.style = this.style;\n        line.labelDiff = this.labelDiff;\n        line.allow = this.allow;\n        line.control = this.control ? this.control.copy() : null;\n        line.arrowRotation = this.arrowRotation;\n        line.startVertexId = this.startVertexId;\n        line.endVertexId = this.endVertexId;\n        line.startVertex = this.startVertex;\n        line.endVertex = this.endVertex;\n        line.fallbackOrigin = this.fallbackOrigin.copy();\n        line.fallbackTo = this.fallbackTo.copy();\n        return line;\n    };\n    Line.prototype.bindVertices = function (start, end) {\n        this.startVertex = start;\n        this.endVertex = end;\n        this.startVertexId = start.id;\n        this.endVertexId = end.id;\n        this.fallbackOrigin = start.copy();\n        this.fallbackTo = end.copy();\n    };\n    Line.prototype.bindStartVertex = function (start) {\n        this.startVertex = start;\n        this.startVertexId = start.id;\n        this.fallbackOrigin = start.copy();\n    };\n    Line.prototype.bindEndVertex = function (end) {\n        this.endVertex = end;\n        this.endVertexId = end.id;\n        this.fallbackTo = end.copy();\n    };\n    Line.prototype.resolveVertices = function (start, end) {\n        if (start) {\n            this.bindStartVertex(start);\n        }\n        if (end) {\n            this.bindEndVertex(end);\n        }\n    };\n    Object.defineProperty(Line.prototype, \"origin\", {\n        get: function () {\n            if (this.startVertex) {\n                return this.startVertex;\n            }\n            var detached = new _Vertex__WEBPACK_IMPORTED_MODULE_2__.Vertex(this.fallbackOrigin.x, this.fallbackOrigin.y);\n            detached.id = this.startVertexId || detached.id;\n            this.startVertex = detached;\n            this.startVertexId = detached.id;\n            return detached;\n        },\n        set: function (value) {\n            if (value instanceof _Vertex__WEBPACK_IMPORTED_MODULE_2__.Vertex) {\n                this.bindStartVertex(value);\n                return;\n            }\n            var detached = new _Vertex__WEBPACK_IMPORTED_MODULE_2__.Vertex(value.x, value.y);\n            this.bindStartVertex(detached);\n        },\n        enumerable: false,\n        configurable: true\n    });\n    Object.defineProperty(Line.prototype, \"to\", {\n        get: function () {\n            if (this.endVertex) {\n                return this.endVertex;\n            }\n            var detached = new _Vertex__WEBPACK_IMPORTED_MODULE_2__.Vertex(this.fallbackTo.x, this.fallbackTo.y);\n            detached.id = this.endVertexId || detached.id;\n            this.endVertex = detached;\n            this.endVertexId = detached.id;\n            return detached;\n        },\n        set: function (value) {\n            if (value instanceof _Vertex__WEBPACK_IMPORTED_MODULE_2__.Vertex) {\n                this.bindEndVertex(value);\n                return;\n            }\n            var detached = new _Vertex__WEBPACK_IMPORTED_MODULE_2__.Vertex(value.x, value.y);\n            this.bindEndVertex(detached);\n        },\n        enumerable: false,\n        configurable: true\n    });\n    Line.prototype.rotation = function (angle) {\n        var center = this.center();\n        var unit = this.directionUnit();\n        var length = this.length();\n        var rotated = unit.rotation(angle);\n        this.origin.moveAbsolute(center.add(rotated.multi(-length / 2)));\n        this.to.moveAbsolute(center.add(rotated.multi(length / 2)));\n    };\n    Line.prototype.move = function (delta) {\n        this.origin.move(delta);\n        this.to.move(delta);\n    };\n    Line.prototype.moveAbsolute = function (location) {\n        var length = this.length();\n        var unit = this.directionUnit();\n        this.origin.moveAbsolute(location.add(unit.multi(-length / 2)));\n        this.to.moveAbsolute(location.add(unit.multi(length / 2)));\n    };\n    Line.prototype.length = function () {\n        return this.to.minus(this.origin).length();\n    };\n    Line.prototype.toggle = function () {\n        var start = this.origin;\n        var end = this.to;\n        this.bindVertices(end, start);\n    };\n    Line.prototype.direction = function () {\n        return this.to.minus(this.origin);\n    };\n    Line.prototype.directionUnit = function () {\n        var length = this.length();\n        if (length === 0) {\n            return new _Vector__WEBPACK_IMPORTED_MODULE_1__.Vector(1, 0);\n        }\n        return this.direction().multi(1 / length);\n    };\n    Line.prototype.addLoopOrigin = function (loop) {\n        loop.origin = this.origin.minus(this.directionUnit().multi(loop.radius));\n    };\n    Line.prototype.addLoopTo = function (loop) {\n        loop.origin = this.to.add(this.directionUnit().multi(loop.radius));\n    };\n    Line.prototype.between = function (loop1, loop2) {\n        this.to = loop1.origin.copy();\n        this.origin = loop2.origin.copy();\n        loop1.addLineTo(this);\n        loop2.addLineOrigin(this);\n    };\n    Line.prototype.center = function () {\n        if (this.control) {\n            return this.pointAt(0.5);\n        }\n        return this.origin.add(this.to).multi(0.5);\n    };\n    Line.prototype.formalDistance = function (point) {\n        var closest = this.closestPoint(point);\n        return point.minus(closest).length();\n    };\n    Line.prototype.vector = function () {\n        return this.to.minus(this.origin);\n    };\n    Line.prototype.description = function () {\n        return \"\".concat(this.shape, \" id:\").concat(this.id, \" (\").concat(this.origin.x, \",\").concat(this.origin.y, \") -> (\").concat(this.to.x, \", \").concat(this.to.y, \") style:\").concat(this.style);\n    };\n    Line.prototype.closestPoint = function (point) {\n        if (!this.control) {\n            var direction = this.direction();\n            var lengthSquared = direction.prod(direction);\n            if (lengthSquared === 0) {\n                return this.origin.copy();\n            }\n            var t = Math.max(0, Math.min(1, point.minus(this.origin).prod(direction) / lengthSquared));\n            return new _Vector__WEBPACK_IMPORTED_MODULE_1__.Vector(this.origin.x + direction.x * t, this.origin.y + direction.y * t);\n        }\n        var closest = this.origin.copy();\n        var minDistance = Number.POSITIVE_INFINITY;\n        var segments = 64;\n        for (var i = 0; i <= segments; i++) {\n            var t = i / segments;\n            var sample = this.pointAt(t);\n            var distance = point.minus(sample).length();\n            if (distance < minDistance) {\n                minDistance = distance;\n                closest = sample;\n            }\n        }\n        return closest;\n    };\n    Line.prototype.pointAt = function (t) {\n        var clamped = Math.max(0, Math.min(1, t));\n        if (this.control) {\n            var oneMinusT = 1 - clamped;\n            var term1 = this.origin.multi(oneMinusT * oneMinusT);\n            var term2 = this.control.multi(2 * oneMinusT * clamped);\n            var term3 = this.to.multi(clamped * clamped);\n            return term1.add(term2).add(term3);\n        }\n        return this.origin.add(this.direction().multi(clamped));\n    };\n    Line.prototype.tangentAt = function (t) {\n        var clamped = Math.max(0, Math.min(1, t));\n        if (this.control) {\n            var term1 = this.control.minus(this.origin).multi(2 * (1 - clamped));\n            var term2 = this.to.minus(this.control).multi(2 * clamped);\n            return term1.add(term2);\n        }\n        return this.direction();\n    };\n    return Line;\n}());\n\nfunction isLine(elem) {\n    return elem.shape == \"Line\";\n}\nfunction makeLine(data) {\n    var _a, _b, _c, _d, _e, _f, _g;\n    var shape = data[\"shape\"];\n    if (shape && shape !== \"Line\") {\n        return undefined;\n    }\n    var line = new Line();\n    line.id = (_a = data[\"id\"]) !== null && _a !== void 0 ? _a : line.id;\n    line.label = (_b = data[\"label\"]) !== null && _b !== void 0 ? _b : \"\";\n    line.style = (_c = data[\"style\"]) !== null && _c !== void 0 ? _c : \"normal\";\n    line.allow = (_d = data[\"allow\"]) !== null && _d !== void 0 ? _d : true;\n    line.labelDiff = (_e = data[\"labelDiff\"]) !== null && _e !== void 0 ? _e : 0;\n    line.arrowRotation = typeof data[\"arrowRotation\"] === \"number\" ? data[\"arrowRotation\"] : 0;\n    var origin = data[\"origin\"];\n    var to = data[\"to\"];\n    if (origin && typeof origin.x === \"number\" && typeof origin.y === \"number\") {\n        line.origin = new _Vertex__WEBPACK_IMPORTED_MODULE_2__.Vertex(origin.x, origin.y);\n    }\n    if (to && typeof to.x === \"number\" && typeof to.y === \"number\") {\n        line.to = new _Vertex__WEBPACK_IMPORTED_MODULE_2__.Vertex(to.x, to.y);\n    }\n    line.startVertexId = (_f = data[\"startVertexId\"]) !== null && _f !== void 0 ? _f : line.startVertexId;\n    line.endVertexId = (_g = data[\"endVertexId\"]) !== null && _g !== void 0 ? _g : line.endVertexId;\n    var control = data[\"control\"];\n    if (control && typeof control.x === \"number\" && typeof control.y === \"number\") {\n        line.control = new _Vector__WEBPACK_IMPORTED_MODULE_1__.Vector(control.x, control.y);\n    }\n    else {\n        line.control = null;\n    }\n    return line;\n}\n\n\n//# sourceURL=webpack://rdfeyn/./src/Core/Line.ts?");

/***/ }),

/***/ "./src/Core/Loop.ts":
/*!**************************!*\
  !*** ./src/Core/Loop.ts ***!
  \**************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"Loop\": () => (/* binding */ Loop),\n/* harmony export */   \"isLoop\": () => (/* binding */ isLoop),\n/* harmony export */   \"makeLoop\": () => (/* binding */ makeLoop)\n/* harmony export */ });\n/* harmony import */ var _Elem__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./Elem */ \"./src/Core/Elem.ts\");\n/* harmony import */ var _Vector__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./Vector */ \"./src/Core/Vector.ts\");\n/* harmony import */ var _Vertex__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./Vertex */ \"./src/Core/Vertex.ts\");\nvar __spreadArray = (undefined && undefined.__spreadArray) || function (to, from, pack) {\n    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {\n        if (ar || !(i in from)) {\n            if (!ar) ar = Array.prototype.slice.call(from, 0, i);\n            ar[i] = from[i];\n        }\n    }\n    return to.concat(ar || Array.prototype.slice.call(from));\n};\n\n\n\n/**\n * Loop bound to a center vertex (graph node).\n */\nvar Loop = /** @class */ (function () {\n    function Loop(label, origin) {\n        this.shape = \"Loop\";\n        this.style = \"normal\";\n        this.allow = false;\n        this.fill = false;\n        this.radius = 1;\n        this.label = \"\";\n        this.labels = [];\n        this.loopBeginAngle = 0;\n        this.loopEndAngle = Math.PI * 2;\n        this.centerVertexId = \"\";\n        this.fallbackOrigin = new _Vector__WEBPACK_IMPORTED_MODULE_1__.Vector(0, 0);\n        this.id = (0,_Elem__WEBPACK_IMPORTED_MODULE_0__.getElemID)();\n        if (label) {\n            this.label = label;\n        }\n        if (origin) {\n            this.origin = origin;\n        }\n    }\n    Object.defineProperty(Loop.prototype, \"origin\", {\n        get: function () {\n            if (this.centerVertex) {\n                return this.centerVertex;\n            }\n            var detached = new _Vertex__WEBPACK_IMPORTED_MODULE_2__.Vertex(this.fallbackOrigin.x, this.fallbackOrigin.y);\n            detached.id = this.centerVertexId || detached.id;\n            this.centerVertex = detached;\n            this.centerVertexId = detached.id;\n            return detached;\n        },\n        set: function (value) {\n            if (value instanceof _Vertex__WEBPACK_IMPORTED_MODULE_2__.Vertex) {\n                this.centerVertex = value;\n                this.centerVertexId = value.id;\n                this.fallbackOrigin = value.copy();\n                return;\n            }\n            var detached = new _Vertex__WEBPACK_IMPORTED_MODULE_2__.Vertex(value.x, value.y);\n            this.centerVertex = detached;\n            this.centerVertexId = detached.id;\n            this.fallbackOrigin = detached.copy();\n        },\n        enumerable: false,\n        configurable: true\n    });\n    Loop.prototype.bindCenterVertex = function (vertex) {\n        this.centerVertex = vertex;\n        this.centerVertexId = vertex.id;\n        this.fallbackOrigin = vertex.copy();\n    };\n    Loop.prototype.save = function () {\n        var saveData = {};\n        saveData[\"id\"] = this.id;\n        saveData[\"label\"] = this.label;\n        saveData[\"labels\"] = this.labels;\n        saveData[\"shape\"] = this.shape;\n        saveData[\"style\"] = this.style;\n        saveData[\"allow\"] = this.allow;\n        saveData[\"fill\"] = this.fill;\n        saveData[\"origin\"] = this.origin.save();\n        saveData[\"radius\"] = this.radius;\n        saveData[\"loopBeginAngle\"] = this.loopBeginAngle;\n        saveData[\"loopEndAngle\"] = this.loopEndAngle;\n        saveData[\"centerVertexId\"] = this.centerVertexId;\n        return saveData;\n    };\n    Loop.prototype.copy = function () {\n        var loop = new Loop();\n        loop.id = this.id;\n        loop.fill = this.fill;\n        loop.radius = this.radius;\n        loop.label = this.label;\n        loop.labels = __spreadArray([], this.labels, true);\n        loop.style = this.style;\n        loop.allow = this.allow;\n        loop.loopBeginAngle = this.loopBeginAngle;\n        loop.loopEndAngle = this.loopEndAngle;\n        loop.centerVertexId = this.centerVertexId;\n        loop.centerVertex = this.centerVertex;\n        loop.fallbackOrigin = this.fallbackOrigin.copy();\n        return loop;\n    };\n    Loop.prototype.setLoopBeginAngle = function (angle) {\n        if (angle >= 2 * Math.PI)\n            angle -= 2 * Math.PI;\n        if (angle < 0.0)\n            angle += 2 * Math.PI;\n        this.loopBeginAngle = angle;\n    };\n    Loop.prototype.setLoopEndAngle = function (angle) {\n        if (angle >= 2 * Math.PI)\n            angle -= 2 * Math.PI;\n        if (angle < 0)\n            angle += 2 * Math.PI;\n        this.loopEndAngle = angle;\n    };\n    Loop.prototype.setRadius = function (radius) {\n        if (radius < 1)\n            radius = 1;\n        this.radius = radius;\n    };\n    Loop.prototype.move = function (delta) {\n        this.origin.move(delta);\n    };\n    Loop.prototype.moveAbsolute = function (location) {\n        this.origin.moveAbsolute(location);\n    };\n    Loop.prototype.rotation = function (delta) {\n        this.setLoopBeginAngle(this.loopBeginAngle + delta);\n        this.setLoopEndAngle(this.loopEndAngle + delta);\n    };\n    Loop.prototype.addLineTo = function (line) {\n        line.to = this.origin.add((0,_Vector__WEBPACK_IMPORTED_MODULE_1__.direction)(line.origin, this.origin).unit().multi(this.radius));\n    };\n    Loop.prototype.addLineOrigin = function (line) {\n        line.origin = this.origin.add((0,_Vector__WEBPACK_IMPORTED_MODULE_1__.direction)(line.to, this.origin).unit().multi(this.radius));\n    };\n    Loop.prototype.addLoop = function (loop) {\n        loop.origin = this.origin.add((0,_Vector__WEBPACK_IMPORTED_MODULE_1__.direction)(loop.origin, this.origin).unit().multi(this.radius));\n    };\n    Loop.prototype.formalDistance = function (point) {\n        var length = this.origin.minus(point).length();\n        if (length < this.radius) {\n            return 0;\n        }\n        return Number.MAX_VALUE;\n    };\n    Loop.prototype.description = function () {\n        return \"\".concat(this.shape, \" id:\").concat(this.id, \" (\").concat(this.origin.x, \",\").concat(this.origin.y, \") radius = \").concat(this.radius, \" angle = (\").concat(this.loopBeginAngle * (360 / (2 * Math.PI)), \", \").concat(this.loopEndAngle * (360 / (2 * Math.PI)), \") style:\").concat(this.style);\n    };\n    return Loop;\n}());\n\nfunction isLoop(elem) {\n    return elem.shape == \"Loop\";\n}\nfunction makeLoop(data) {\n    var _a, _b, _c, _d, _e, _f, _g, _h;\n    var shape = data[\"shape\"];\n    if (shape && shape !== \"Loop\") {\n        return undefined;\n    }\n    var loop = new Loop(undefined, undefined);\n    loop.id = (_a = data[\"id\"]) !== null && _a !== void 0 ? _a : loop.id;\n    loop.label = (_b = data[\"label\"]) !== null && _b !== void 0 ? _b : \"\";\n    loop.style = (_c = data[\"style\"]) !== null && _c !== void 0 ? _c : \"normal\";\n    loop.allow = (_d = data[\"allow\"]) !== null && _d !== void 0 ? _d : false;\n    loop.fill = (_e = data[\"fill\"]) !== null && _e !== void 0 ? _e : false;\n    loop.radius = (_f = data[\"radius\"]) !== null && _f !== void 0 ? _f : 1;\n    loop.loopBeginAngle = (_g = data[\"loopBeginAngle\"]) !== null && _g !== void 0 ? _g : 0;\n    loop.loopEndAngle = (_h = data[\"loopEndAngle\"]) !== null && _h !== void 0 ? _h : Math.PI * 2;\n    var centerId = data[\"centerVertexId\"];\n    if (typeof centerId === \"string\") {\n        loop.centerVertexId = centerId;\n    }\n    var origin = (0,_Vector__WEBPACK_IMPORTED_MODULE_1__.makeVector)(data[\"origin\"]);\n    if (origin) {\n        loop.origin = new _Vertex__WEBPACK_IMPORTED_MODULE_2__.Vertex(origin.x, origin.y);\n    }\n    return loop;\n}\n\n\n//# sourceURL=webpack://rdfeyn/./src/Core/Loop.ts?");

/***/ }),

/***/ "./src/Core/MyString.ts":
/*!******************************!*\
  !*** ./src/Core/MyString.ts ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"MyString\": () => (/* binding */ MyString),\n/* harmony export */   \"isString\": () => (/* binding */ isString),\n/* harmony export */   \"makeMyString\": () => (/* binding */ makeMyString)\n/* harmony export */ });\n/* harmony import */ var _Elem__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./Elem */ \"./src/Core/Elem.ts\");\n/* harmony import */ var _Vector__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./Vector */ \"./src/Core/Vector.ts\");\n\n\n/**\n * A MyString is a String that can be moved around the screen.\n * It has a unique ID, a Shape, and a location.\n * It can be moved by a delta, or moved to an absolute location.\n * It can be copied, and it can be saved to a JSON object.\n * It can also be described as a string.\n */\nvar MyString = /** @class */ (function () {\n    function MyString(label) {\n        this.shape = \"String\";\n        this.origin = new _Vector__WEBPACK_IMPORTED_MODULE_1__.Vector(0, 0);\n        this.id = (0,_Elem__WEBPACK_IMPORTED_MODULE_0__.getElemID)();\n        this.label = label;\n    }\n    MyString.prototype.save = function () {\n        var saveData = {};\n        saveData[\"id\"] = this.id;\n        saveData[\"label\"] = this.label;\n        saveData[\"shape\"] = this.shape;\n        saveData[\"origin\"] = this.origin.save();\n        return saveData;\n    };\n    MyString.prototype.copy = function () {\n        var str = new MyString(this.label);\n        str.origin = this.origin;\n        return str;\n    };\n    MyString.prototype.move = function (delta) {\n        this.origin = this.origin.add(delta);\n    };\n    MyString.prototype.moveAbsolute = function (location) {\n        this.origin = location;\n    };\n    MyString.prototype.formalDistance = function (point) {\n        return this.origin.minus(point).length();\n    };\n    MyString.prototype.description = function () {\n        return \"\".concat(this.shape, \" id:\").concat(this.id, \" x:\").concat(this.origin.x, \" y:\").concat(this.origin.y, \" label:\").concat(this.label);\n    };\n    return MyString;\n}());\n\nfunction isString(elem) {\n    return elem.shape == \"String\";\n}\nfunction makeMyString(data) {\n    var shape = data[\"shape\"];\n    if (shape) {\n        return undefined;\n    }\n    var elm = new MyString(\"\");\n    elm.id = data[\"id\"];\n    elm.label = data[\"label\"];\n    return elm;\n}\n\n\n//# sourceURL=webpack://rdfeyn/./src/Core/MyString.ts?");

/***/ }),

/***/ "./src/Core/TextPosition.ts":
/*!**********************************!*\
  !*** ./src/Core/TextPosition.ts ***!
  \**********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"textPosition\": () => (/* binding */ textPosition)\n/* harmony export */ });\n/* harmony import */ var _Vector__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./Vector */ \"./src/Core/Vector.ts\");\n\n/**\n * Position of text\n */\nfunction textPosition(text, position, config) {\n    //TODO\n    return position.add(new _Vector__WEBPACK_IMPORTED_MODULE_0__.Vector(-3, +3)); // font 仮定\n}\n\n\n//# sourceURL=webpack://rdfeyn/./src/Core/TextPosition.ts?");

/***/ }),

/***/ "./src/Core/Vector.ts":
/*!****************************!*\
  !*** ./src/Core/Vector.ts ***!
  \****************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"Vector\": () => (/* binding */ Vector),\n/* harmony export */   \"direction\": () => (/* binding */ direction),\n/* harmony export */   \"isVector\": () => (/* binding */ isVector),\n/* harmony export */   \"makeVector\": () => (/* binding */ makeVector)\n/* harmony export */ });\n/* harmony import */ var _Elem__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./Elem */ \"./src/Core/Elem.ts\");\n\n/**\n * A Vector is a point in 2D space.\n * It has a unique ID, a Shape, and a location.\n * It can be moved by a delta, or moved to an absolute location.\n * It can be copied, and it can be saved to a JSON object.\n * It can also be described as a string.\n * It can be added to another Vector, or subtracted from another Vector.\n * It can be multiplied by a number.\n * It can be rotated by an angle.\n * It can be converted to a unit vector.\n * It can be converted to a floor vector.\n * It can be converted to a vector with integer coordinates.\n */\nvar Vector = /** @class */ (function () {\n    function Vector(x, y) {\n        this.shape = \"Point\";\n        this.x = 0;\n        this.y = 0;\n        this.id = (0,_Elem__WEBPACK_IMPORTED_MODULE_0__.getElemID)();\n        this.x = x;\n        this.y = y;\n    }\n    Vector.prototype.save = function () {\n        var saveData = {};\n        saveData[\"id\"] = this.id;\n        saveData[\"shape\"] = this.shape;\n        saveData[\"x\"] = this.x;\n        saveData[\"y\"] = this.y;\n        return saveData;\n    };\n    Vector.prototype.add = function (vec) {\n        return new Vector(this.x + vec.x, this.y + vec.y);\n    };\n    Vector.prototype.minus = function (vec) {\n        return new Vector(this.x - vec.x, this.y - vec.y);\n    };\n    Vector.prototype.length = function () {\n        return Math.pow((Math.pow(this.x, 2) + Math.pow(this.y, 2)), (1 / 2));\n    };\n    Vector.prototype.multi = function (num) {\n        return new Vector(this.x * num, this.y * num);\n    };\n    Vector.prototype.floor = function () {\n        return new Vector(Math.floor(this.x), Math.floor(this.y));\n    };\n    Vector.prototype.prod = function (vec) {\n        return this.x * vec.x + this.y * vec.y;\n    };\n    Vector.prototype.unit = function () {\n        return new Vector(this.x * (1 / this.length()), this.y * (1 / this.length()));\n    };\n    Vector.prototype.copy = function () {\n        var vector = new Vector(this.x, this.y);\n        vector.id = this.id;\n        vector.shape = this.shape;\n        return vector;\n    };\n    Vector.prototype.rotation = function (angle) {\n        return new Vector(this.x * Math.cos(angle) - this.y * Math.sin(angle), this.x * Math.sin(angle) + this.y * Math.cos(angle));\n    };\n    Vector.prototype.formalDistance = function (point) {\n        return (length = this.minus(point).length());\n        // if (length > 0.3) {\n        //   return Number.MAX_VALUE;\n        // }\n        // return 0;\n    };\n    Vector.prototype.move = function (delta) {\n        var vector = this.add(delta);\n        this.x = vector.x;\n        this.y = vector.y;\n    };\n    Vector.prototype.moveAbsolute = function (location) {\n        this.x = location.x;\n        this.y = location.y;\n    };\n    Vector.prototype.description = function () {\n        return \"\".concat(this.shape, \" id:\").concat(this.id, \" x:\").concat(this.x, \" y:\").concat(this.y);\n    };\n    return Vector;\n}());\n\nfunction isVector(elem) {\n    return elem.shape == \"Point\";\n}\nfunction direction(v1, v2) {\n    return v1.minus(v2);\n}\nfunction makeVector(data) {\n    var shape = data[\"shape\"];\n    if (shape) {\n        return undefined;\n    }\n    var elm = new Vector(0, 0);\n    elm.id = data[\"id\"];\n    elm.x = data[\"x\"];\n    elm.y = data[\"y\"];\n    return elm;\n}\n\n\n//# sourceURL=webpack://rdfeyn/./src/Core/Vector.ts?");

/***/ }),

/***/ "./src/Core/Vertex.ts":
/*!****************************!*\
  !*** ./src/Core/Vertex.ts ***!
  \****************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"Vertex\": () => (/* binding */ Vertex)\n/* harmony export */ });\n/* harmony import */ var _Vector__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./Vector */ \"./src/Core/Vector.ts\");\nvar __extends = (undefined && undefined.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        if (typeof b !== \"function\" && b !== null)\n            throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\n\n/**\n * Graph node used by lines/loops.\n * Keeps small adjacency hints for UI workflows.\n */\nvar Vertex = /** @class */ (function (_super) {\n    __extends(Vertex, _super);\n    function Vertex(xOrLabel, yOrOrigin) {\n        if (xOrLabel === void 0) { xOrLabel = 0; }\n        if (yOrOrigin === void 0) { yOrOrigin = 0; }\n        var _this = this;\n        var x = 0;\n        var y = 0;\n        if (typeof xOrLabel === \"number\" && typeof yOrOrigin === \"number\") {\n            x = xOrLabel;\n            y = yOrOrigin;\n        }\n        else if (yOrOrigin instanceof _Vector__WEBPACK_IMPORTED_MODULE_0__.Vector) {\n            x = yOrOrigin.x;\n            y = yOrOrigin.y;\n        }\n        _this = _super.call(this, x, y) || this;\n        _this.kind = \"vertex\";\n        _this.connectedLineIds = new Set();\n        _this.connectedLoopIds = new Set();\n        return _this;\n    }\n    Vertex.prototype.copy = function () {\n        var vertex = new Vertex(this.x, this.y);\n        vertex.id = this.id;\n        vertex.connectedLineIds = new Set(this.connectedLineIds);\n        vertex.connectedLoopIds = new Set(this.connectedLoopIds);\n        return vertex;\n    };\n    Vertex.prototype.attachLine = function (lineId) {\n        this.connectedLineIds.add(lineId);\n    };\n    Vertex.prototype.detachLine = function (lineId) {\n        this.connectedLineIds.delete(lineId);\n    };\n    Vertex.prototype.attachLoop = function (loopId) {\n        this.connectedLoopIds.add(loopId);\n    };\n    Vertex.prototype.detachLoop = function (loopId) {\n        this.connectedLoopIds.delete(loopId);\n    };\n    Vertex.prototype.connectionCount = function () {\n        return this.connectedLineIds.size + this.connectedLoopIds.size;\n    };\n    Vertex.prototype.hasConnections = function () {\n        return this.connectionCount() > 0;\n    };\n    Vertex.prototype.clearConnections = function () {\n        this.connectedLineIds.clear();\n        this.connectedLoopIds.clear();\n    };\n    Object.defineProperty(Vertex.prototype, \"origin\", {\n        // Backward-compatible alias used in old sample/UI code.\n        get: function () {\n            return this;\n        },\n        set: function (value) {\n            this.moveAbsolute(value);\n        },\n        enumerable: false,\n        configurable: true\n    });\n    Vertex.prototype.addLineTo = function (line) {\n        line.to = this;\n    };\n    Vertex.prototype.addLineOrigin = function (line) {\n        line.origin = this;\n    };\n    Vertex.prototype.addLoop = function (loop) {\n        loop.origin = this;\n    };\n    return Vertex;\n}(_Vector__WEBPACK_IMPORTED_MODULE_0__.Vector));\n\n\n\n//# sourceURL=webpack://rdfeyn/./src/Core/Vertex.ts?");

/***/ }),

/***/ "./src/Scripting/ScriptEngine.ts":
/*!***************************************!*\
  !*** ./src/Scripting/ScriptEngine.ts ***!
  \***************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"ScriptEngine\": () => (/* binding */ ScriptEngine)\n/* harmony export */ });\n/* harmony import */ var _Core_Line__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../Core/Line */ \"./src/Core/Line.ts\");\n/* harmony import */ var _Core_Loop__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../Core/Loop */ \"./src/Core/Loop.ts\");\n/* harmony import */ var _Core_Vector__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../Core/Vector */ \"./src/Core/Vector.ts\");\n/* harmony import */ var _Core_Vertex__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../Core/Vertex */ \"./src/Core/Vertex.ts\");\n/* harmony import */ var _UI_RepositoryCommand__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../UI/RepositoryCommand */ \"./src/UI/RepositoryCommand.ts\");\nvar __assign = (undefined && undefined.__assign) || function () {\n    __assign = Object.assign || function(t) {\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\n            s = arguments[i];\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n                t[p] = s[p];\n        }\n        return t;\n    };\n    return __assign.apply(this, arguments);\n};\n\n\n\n\n\nvar LINE_STYLES = [\"normal\", \"dash\", \"wave\", \"coil\", \"double\"];\nvar DIRECTION_VECTORS = {\n    right: new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(1, 0),\n    left: new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(-1, 0),\n    up: new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(0, -1),\n    down: new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(0, 1),\n    ur: new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(1, -1),\n    ul: new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(-1, -1),\n    dr: new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(1, 1),\n    dl: new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(-1, 1),\n    upright: new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(1, -1),\n    upleft: new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(-1, -1),\n    downright: new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(1, 1),\n    downleft: new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(-1, 1),\n};\nfunction isLineStyle(style) {\n    return LINE_STYLES.includes(style);\n}\nfunction particleToStyle(raw) {\n    if (!raw) {\n        return \"normal\";\n    }\n    var token = raw.toLowerCase();\n    if (isLineStyle(token)) {\n        return token;\n    }\n    if (token === \"photon\") {\n        return \"wave\";\n    }\n    if (token === \"gluon\") {\n        return \"coil\";\n    }\n    if (token === \"electron\" || token === \"fermion\") {\n        return \"normal\";\n    }\n    return \"normal\";\n}\nvar ScriptEngine = /** @class */ (function () {\n    function ScriptEngine(repository) {\n        this.branchStack = [];\n        this.forceJoinCleanupMode = false;\n        this.repository = repository;\n    }\n    ScriptEngine.prototype.getTemplateCatalog = function () {\n        return ScriptEngine.TEMPLATE_CATALOG.map(function (item) { return (__assign({}, item)); });\n    };\n    ScriptEngine.prototype.buildTemplateMacro = function (templateName, x, y) {\n        if (x === void 0) { x = 20; }\n        if (y === void 0) { y = 20; }\n        var name = templateName.toLowerCase();\n        var xRounded = Number(x.toFixed(2));\n        var yRounded = Number(y.toFixed(2));\n        switch (name) {\n            case \"qed_box\":\n            case \"qed_vertex\":\n            case \"qed_vac\":\n            case \"qed_vacuum\":\n            case \"penguin\":\n            case \"compton\":\n            case \"s_channel\":\n            case \"schannel\":\n            case \"triangle\":\n            case \"anomaly_triangle\":\n            case \"t_channel\":\n            case \"tchannel\":\n            case \"w_exchange\":\n            case \"bhabha_t\":\n            case \"sunset\":\n            case \"double_box\":\n                return \"# Template macro (editable)\\nstart \".concat(xRounded, \" \").concat(yRounded, \"\\ntemplate \").concat(name);\n            default:\n                return null;\n        }\n    };\n    ScriptEngine.prototype.execute = function (input) {\n        var command = input.trim();\n        if (!command) {\n            return { success: false, command: \"\", message: \"Command is empty.\" };\n        }\n        var error = this.executeCommand(command);\n        if (error) {\n            return { success: false, command: command, message: error };\n        }\n        return { success: true, command: command, message: \"Command executed.\" };\n    };\n    ScriptEngine.prototype.executeScript = function (input, stopOnError) {\n        if (stopOnError === void 0) { stopOnError = true; }\n        var commands = this.parseScriptLines(input);\n        if (commands.length === 0) {\n            return { success: false, message: \"No executable commands found.\", executed: 0, total: 0, results: [] };\n        }\n        var results = [];\n        var executed = 0;\n        for (var i = 0; i < commands.length; i++) {\n            var lineInfo = commands[i];\n            var error = this.executeCommand(lineInfo.command);\n            if (error) {\n                var failure = {\n                    success: false,\n                    command: lineInfo.command,\n                    line: lineInfo.line,\n                    message: error,\n                };\n                results.push(failure);\n                if (stopOnError) {\n                    return {\n                        success: false,\n                        message: \"Failed at line \".concat(lineInfo.line, \": \").concat(error),\n                        executed: executed,\n                        total: commands.length,\n                        failedLine: lineInfo.line,\n                        results: results,\n                    };\n                }\n                continue;\n            }\n            executed += 1;\n            results.push({\n                success: true,\n                command: lineInfo.command,\n                line: lineInfo.line,\n                message: \"Command executed.\",\n            });\n        }\n        var allSuccess = results.every(function (result) { return result.success; });\n        if (!allSuccess) {\n            return {\n                success: false,\n                message: \"Executed \".concat(executed, \"/\").concat(commands.length, \" commands with errors.\"),\n                executed: executed,\n                total: commands.length,\n                results: results,\n            };\n        }\n        return {\n            success: true,\n            message: \"Executed \".concat(executed, \"/\").concat(commands.length, \" commands.\"),\n            executed: executed,\n            total: commands.length,\n            results: results,\n        };\n    };\n    ScriptEngine.prototype.parseScriptLines = function (input) {\n        var _this = this;\n        var lines = input.split(/\\r?\\n/);\n        var commands = [];\n        lines.forEach(function (sourceLine, index) {\n            var lineNumber = index + 1;\n            var chunks = sourceLine.split(\";\");\n            chunks.forEach(function (chunk) {\n                var command = _this.stripComments(chunk).trim();\n                if (!command) {\n                    return;\n                }\n                commands.push({ line: lineNumber, command: command });\n            });\n        });\n        return commands;\n    };\n    ScriptEngine.prototype.stripComments = function (text) {\n        var hashIndex = text.indexOf(\"#\");\n        var slashIndex = text.indexOf(\"//\");\n        var cutIndex = -1;\n        if (hashIndex >= 0) {\n            cutIndex = hashIndex;\n        }\n        if (slashIndex >= 0 && (cutIndex < 0 || slashIndex < cutIndex)) {\n            cutIndex = slashIndex;\n        }\n        if (cutIndex < 0) {\n            return text;\n        }\n        return text.slice(0, cutIndex);\n    };\n    ScriptEngine.prototype.executeCommand = function (commandText) {\n        var tokens = commandText.split(/\\s+/);\n        if (tokens.length === 0) {\n            return \"Command is empty.\";\n        }\n        var command = tokens[0].toLowerCase();\n        switch (command) {\n            case \"move\":\n            case \"start\":\n                return this.executeMove(tokens);\n            case \"line\":\n            case \"prop\":\n                return this.executeLineCommand(tokens);\n            case \"loop\":\n                return this.executeLoop(tokens);\n            case \"branch\":\n                return this.executeBranch();\n            case \"next\":\n                return this.executeNext();\n            case \"join\":\n                return this.executeJoin(tokens);\n            case \"join_mode\":\n            case \"join_cleanup\":\n                return this.executeJoinMode(tokens);\n            case \"template\":\n                return this.executeTemplate(tokens);\n            case \"qed_se\":\n                return this.executeQEDSelfEnergy(tokens);\n            case \"qed_vp\":\n                return this.executeQEDVacuumPolarization(tokens);\n            default:\n                return \"Unknown command '\".concat(command, \"'.\");\n        }\n    };\n    ScriptEngine.prototype.executeMove = function (tokens) {\n        if (tokens.length !== 3) {\n            return \"Usage: move x y\";\n        }\n        var x = Number(tokens[1]);\n        var y = Number(tokens[2]);\n        if (![x, y].every(function (value) { return Number.isFinite(value); })) {\n            return \"move arguments must be numeric.\";\n        }\n        var vertex = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(x, y));\n        this.cursorVertexId = vertex.id;\n        return null;\n    };\n    ScriptEngine.prototype.executeLineCommand = function (tokens) {\n        if (tokens.length >= 5) {\n            var maybeX1 = Number(tokens[1]);\n            var maybeY1 = Number(tokens[2]);\n            var maybeX2 = Number(tokens[3]);\n            var maybeY2 = Number(tokens[4]);\n            if ([maybeX1, maybeY1, maybeX2, maybeY2].every(function (value) { return Number.isFinite(value); })) {\n                return this.executeAbsoluteLine(tokens, maybeX1, maybeY1, maybeX2, maybeY2);\n            }\n        }\n        return this.executeRelativeLine(tokens);\n    };\n    ScriptEngine.prototype.executeAbsoluteLine = function (tokens, x1, y1, x2, y2) {\n        if (tokens.length < 5 || tokens.length > 6) {\n            return \"Usage: line|prop x1 y1 x2 y2 [particle|style]\";\n        }\n        var start = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(x1, y1), 0.25);\n        var end = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(x2, y2), 0.25);\n        var line = new _Core_Line__WEBPACK_IMPORTED_MODULE_0__.Line();\n        line.style = particleToStyle(tokens[5]);\n        this.repository.bindLineToVertices(line, start, end);\n        this.repository.doCommand(new _UI_RepositoryCommand__WEBPACK_IMPORTED_MODULE_4__.SetLine(line));\n        this.cursorVertexId = end.id;\n        return null;\n    };\n    ScriptEngine.prototype.executeRelativeLine = function (tokens) {\n        if (tokens.length < 3 || tokens.length > 4) {\n            return \"Usage: line|prop direction length [particle|style]\";\n        }\n        var current = this.getCursorVertex();\n        if (!current) {\n            return \"Cursor is not set. Use 'move x y' or 'start x y' first.\";\n        }\n        var directionRaw = tokens[1].toLowerCase();\n        var unit = DIRECTION_VECTORS[directionRaw];\n        if (!unit) {\n            return \"Unknown direction '\".concat(tokens[1], \"'. Use right/left/up/down/ur/ul/dr/dl.\");\n        }\n        var length = Number(tokens[2]);\n        if (!Number.isFinite(length) || length <= 0) {\n            return \"length must be a positive number.\";\n        }\n        var targetPoint = current.add(unit.unit().multi(length));\n        var nextVertex = this.getOrCreateVertex(targetPoint, 0.45);\n        var line = new _Core_Line__WEBPACK_IMPORTED_MODULE_0__.Line();\n        line.style = particleToStyle(tokens[3]);\n        this.repository.bindLineToVertices(line, current, nextVertex);\n        this.repository.doCommand(new _UI_RepositoryCommand__WEBPACK_IMPORTED_MODULE_4__.SetLine(line));\n        this.cursorVertexId = nextVertex.id;\n        return null;\n    };\n    ScriptEngine.prototype.executeLoop = function (tokens) {\n        if (tokens.length >= 4) {\n            var x = Number(tokens[1]);\n            var y = Number(tokens[2]);\n            var radius_1 = Number(tokens[3]);\n            if ([x, y, radius_1].every(function (value) { return Number.isFinite(value); })) {\n                return this.executeAbsoluteLoop(tokens, x, y, radius_1);\n            }\n        }\n        if (tokens.length < 2 || tokens.length > 5) {\n            return \"Usage: loop radius [style] [beginAngle] [endAngle] | loop x y radius [style] [beginAngle] [endAngle]\";\n        }\n        var current = this.getCursorVertex();\n        if (!current) {\n            return \"Cursor is not set. Use 'move x y' first.\";\n        }\n        var radius = Number(tokens[1]);\n        if (!Number.isFinite(radius) || radius <= 0) {\n            return \"loop radius must be a positive number.\";\n        }\n        var loop = new _Core_Loop__WEBPACK_IMPORTED_MODULE_1__.Loop();\n        loop.setRadius(radius);\n        loop.origin = current;\n        this.applyLoopOptionTokens(loop, tokens.slice(2));\n        this.repository.doCommand(new _UI_RepositoryCommand__WEBPACK_IMPORTED_MODULE_4__.SetLoop(loop));\n        return null;\n    };\n    ScriptEngine.prototype.executeAbsoluteLoop = function (tokens, x, y, radius) {\n        if (tokens.length < 4 || tokens.length > 7) {\n            return \"Usage: loop x y radius [style] [beginAngle] [endAngle]\";\n        }\n        if (radius <= 0) {\n            return \"loop radius must be a positive number.\";\n        }\n        var center = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(x, y), 0.25);\n        var loop = new _Core_Loop__WEBPACK_IMPORTED_MODULE_1__.Loop();\n        loop.origin = center;\n        loop.setRadius(radius);\n        this.applyLoopOptionTokens(loop, tokens.slice(4));\n        this.repository.doCommand(new _UI_RepositoryCommand__WEBPACK_IMPORTED_MODULE_4__.SetLoop(loop));\n        this.cursorVertexId = center.id;\n        return null;\n    };\n    ScriptEngine.prototype.applyLoopOptionTokens = function (loop, options) {\n        var _a;\n        if (options.length === 0) {\n            return;\n        }\n        var styleToken = (_a = options[0]) === null || _a === void 0 ? void 0 : _a.toLowerCase();\n        if (styleToken && isLineStyle(styleToken)) {\n            loop.style = styleToken;\n        }\n        if (options.length >= 3) {\n            var begin = Number(options[1]);\n            var end = Number(options[2]);\n            if (Number.isFinite(begin) && Number.isFinite(end)) {\n                loop.loopBeginAngle = begin;\n                loop.loopEndAngle = end;\n            }\n        }\n    };\n    ScriptEngine.prototype.executeBranch = function () {\n        var current = this.getCursorVertex();\n        if (!current) {\n            return \"Cursor is not set. Use 'move x y' first.\";\n        }\n        this.branchStack.push(current.id);\n        return null;\n    };\n    ScriptEngine.prototype.executeNext = function () {\n        if (this.branchStack.length === 0) {\n            return \"No branch anchor. Use 'branch' first.\";\n        }\n        var id = this.branchStack[this.branchStack.length - 1];\n        var vertex = this.repository.getVertex(id);\n        if (!vertex) {\n            return \"Branch anchor vertex no longer exists.\";\n        }\n        this.cursorVertexId = vertex.id;\n        return null;\n    };\n    ScriptEngine.prototype.executeJoin = function (tokens) {\n        var current = this.getCursorVertex();\n        if (!current) {\n            return \"Cursor is not set. Use 'move x y' first.\";\n        }\n        var tolerance = 1.2;\n        var forceCleanup = this.forceJoinCleanupMode;\n        for (var i = 1; i < tokens.length; i++) {\n            var token = tokens[i].toLowerCase();\n            var numeric = Number(token);\n            if (Number.isFinite(numeric)) {\n                if (numeric <= 0) {\n                    return \"join tolerance must be a positive number.\";\n                }\n                tolerance = numeric;\n                continue;\n            }\n            if (token === \"force\" || token === \"strict\" || token === \"cleanup\") {\n                forceCleanup = true;\n                continue;\n            }\n            if (token === \"soft\" || token === \"normal\") {\n                forceCleanup = false;\n                continue;\n            }\n            return \"Usage: join [tolerance] [force|soft]\";\n        }\n        var near = this.repository.findNearestVertex(current, tolerance, current.id);\n        if (!near) {\n            return \"No nearby vertex to join.\";\n        }\n        this.repository.mergeVertexInto(current, near);\n        if (forceCleanup) {\n            this.repository.cleanupDanglingVertices();\n        }\n        this.cursorVertexId = near.id;\n        return null;\n    };\n    ScriptEngine.prototype.executeJoinMode = function (tokens) {\n        if (tokens.length !== 2) {\n            return \"Usage: join_mode on|off (alias: join_cleanup on|off)\";\n        }\n        var value = tokens[1].toLowerCase();\n        if (value === \"on\" || value === \"true\" || value === \"force\" || value === \"strict\") {\n            this.forceJoinCleanupMode = true;\n            return null;\n        }\n        if (value === \"off\" || value === \"false\" || value === \"soft\" || value === \"normal\") {\n            this.forceJoinCleanupMode = false;\n            return null;\n        }\n        return \"join_mode expects on|off.\";\n    };\n    ScriptEngine.prototype.executeTemplate = function (tokens) {\n        var _a;\n        if (tokens.length < 2) {\n            return \"Usage: template qed_box|qed_vertex|qed_vac|penguin|compton|s_channel|triangle|t_channel|w_exchange|bhabha_t|sunset|double_box\";\n        }\n        var name = tokens[1].toLowerCase();\n        var anchor = (_a = this.getCursorVertex()) !== null && _a !== void 0 ? _a : this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(20, 20), 0.0);\n        switch (name) {\n            case \"qed_box\":\n                this.createTemplateQEDBox(anchor);\n                return null;\n            case \"qed_vertex\":\n                this.createTemplateQEDVertex(anchor);\n                return null;\n            case \"qed_vac\":\n            case \"qed_vacuum\":\n                this.createTemplateQEDVacuum(anchor);\n                return null;\n            case \"penguin\":\n                this.createTemplatePenguin(anchor);\n                return null;\n            case \"compton\":\n                this.createTemplateCompton(anchor);\n                return null;\n            case \"s_channel\":\n            case \"schannel\":\n                this.createTemplateSChannel(anchor);\n                return null;\n            case \"triangle\":\n            case \"anomaly_triangle\":\n                this.createTemplateTriangle(anchor);\n                return null;\n            case \"t_channel\":\n            case \"tchannel\":\n                this.createTemplateTChannel(anchor);\n                return null;\n            case \"w_exchange\":\n                this.createTemplateWExchange(anchor);\n                return null;\n            case \"bhabha_t\":\n                this.createTemplateBhabhaT(anchor);\n                return null;\n            case \"sunset\":\n                this.createTemplateSunset(anchor);\n                return null;\n            case \"double_box\":\n                this.createTemplateDoubleBox(anchor);\n                return null;\n            default:\n                return \"Unknown template '\".concat(name, \"'.\");\n        }\n    };\n    ScriptEngine.prototype.createTemplateQEDBox = function (anchor) {\n        var size = 8;\n        var arm = 6;\n        var half = size / 2;\n        var v1 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - half, anchor.y - half), 0.01);\n        var v2 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + half, anchor.y - half), 0.01);\n        var v3 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + half, anchor.y + half), 0.01);\n        var v4 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - half, anchor.y + half), 0.01);\n        this.createLine(v1, v2, \"normal\");\n        this.createLine(v2, v3, \"normal\");\n        this.createLine(v3, v4, \"normal\");\n        this.createLine(v4, v1, \"normal\");\n        var o1 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(v1.x - arm, v1.y - arm), 0.01);\n        var o2 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(v2.x + arm, v2.y - arm), 0.01);\n        var o3 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(v3.x + arm, v3.y + arm), 0.01);\n        var o4 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(v4.x - arm, v4.y + arm), 0.01);\n        this.createLine(o1, v1, \"wave\");\n        this.createLine(o2, v2, \"wave\");\n        this.createLine(v3, o3, \"wave\");\n        this.createLine(v4, o4, \"wave\");\n        this.cursorVertexId = v3.id;\n    };\n    ScriptEngine.prototype.createTemplateQEDVertex = function (anchor) {\n        var span = 12;\n        var uplift = 9;\n        var loopRadius = 2.8;\n        var left = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - span / 2, anchor.y), 0.01);\n        var right = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + span / 2, anchor.y), 0.01);\n        var mid = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x, anchor.y), 0.01);\n        var photonTip = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x, anchor.y - uplift), 0.01);\n        var extIn = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(left.x - 8, left.y), 0.01);\n        var extOut = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(right.x + 8, right.y), 0.01);\n        this.createLine(extIn, left, \"normal\");\n        this.createLine(left, mid, \"normal\");\n        this.createLine(mid, right, \"normal\");\n        this.createLine(right, extOut, \"normal\");\n        this.createLine(mid, photonTip, \"wave\");\n        var loopCenter = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x, anchor.y - 2.6), 0.01);\n        var loop = new _Core_Loop__WEBPACK_IMPORTED_MODULE_1__.Loop();\n        loop.origin = loopCenter;\n        loop.setRadius(loopRadius);\n        loop.style = \"wave\";\n        loop.loopBeginAngle = Math.PI * 0.1;\n        loop.loopEndAngle = Math.PI * 0.9;\n        this.repository.doCommand(new _UI_RepositoryCommand__WEBPACK_IMPORTED_MODULE_4__.SetLoop(loop));\n        this.cursorVertexId = mid.id;\n    };\n    ScriptEngine.prototype.createTemplateQEDVacuum = function (anchor) {\n        var length = 24;\n        var radius = 4.2;\n        var left = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - length / 2, anchor.y), 0.01);\n        var right = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + length / 2, anchor.y), 0.01);\n        var midL = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - radius, anchor.y), 0.01);\n        var midR = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + radius, anchor.y), 0.01);\n        var center = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x, anchor.y), 0.01);\n        this.createLine(left, midL, \"wave\");\n        this.createLine(midR, right, \"wave\");\n        var loop = new _Core_Loop__WEBPACK_IMPORTED_MODULE_1__.Loop();\n        loop.origin = center;\n        loop.setRadius(radius);\n        loop.style = \"normal\";\n        this.repository.doCommand(new _UI_RepositoryCommand__WEBPACK_IMPORTED_MODULE_4__.SetLoop(loop));\n        this.cursorVertexId = right.id;\n    };\n    ScriptEngine.prototype.createTemplatePenguin = function (anchor) {\n        var leftIn = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 16, anchor.y + 2), 0.01);\n        var weakIn = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 9, anchor.y + 1.2), 0.01);\n        var weakCore = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 3, anchor.y), 0.01);\n        var weakOut = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 8, anchor.y + 1.2), 0.01);\n        var rightOut = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 16, anchor.y + 2), 0.01);\n        // Keep the fermion loop above the weak line so the emitted boson reads clearly.\n        var loopCenter = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 2, anchor.y - 4.8), 0.01);\n        var loopRadius = 4.1;\n        var loopLeft = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(loopCenter.x - loopRadius, loopCenter.y), 0.01);\n        var loopRight = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(loopCenter.x + loopRadius, loopCenter.y), 0.01);\n        var loopTop = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(loopCenter.x, loopCenter.y - loopRadius), 0.01);\n        var emittedBoson = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(loopTop.x + 8.5, loopTop.y - 4), 0.01);\n        this.createLine(leftIn, weakIn, \"normal\");\n        this.createLine(weakIn, weakCore, \"normal\");\n        this.createLine(weakCore, weakOut, \"normal\");\n        this.createLine(weakOut, rightOut, \"normal\");\n        this.createLine(weakCore, loopLeft, \"normal\");\n        this.createLine(loopRight, weakOut, \"normal\");\n        this.createLine(loopTop, emittedBoson, \"coil\");\n        var loop = new _Core_Loop__WEBPACK_IMPORTED_MODULE_1__.Loop();\n        loop.origin = loopCenter;\n        loop.setRadius(loopRadius);\n        loop.style = \"normal\";\n        this.repository.doCommand(new _UI_RepositoryCommand__WEBPACK_IMPORTED_MODULE_4__.SetLoop(loop));\n        this.cursorVertexId = weakOut.id;\n    };\n    ScriptEngine.prototype.createTemplateCompton = function (anchor) {\n        var eIn = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 13, anchor.y + 2), 0.01);\n        var v1 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 4, anchor.y + 2), 0.01);\n        var v2 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 4, anchor.y + 2), 0.01);\n        var eOut = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 13, anchor.y + 2), 0.01);\n        var gIn = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 10, anchor.y - 6), 0.01);\n        var gOut = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 10, anchor.y - 6), 0.01);\n        this.createLine(eIn, v1, \"normal\");\n        this.createLine(v1, v2, \"normal\");\n        this.createLine(v2, eOut, \"normal\");\n        this.createLine(gIn, v1, \"wave\");\n        this.createLine(v2, gOut, \"wave\");\n        this.cursorVertexId = eOut.id;\n    };\n    ScriptEngine.prototype.createTemplateSChannel = function (anchor) {\n        var inL = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 12, anchor.y - 4.5), 0.01);\n        var inR = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 12, anchor.y + 4.5), 0.01);\n        var midL = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 3, anchor.y), 0.01);\n        var midR = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 3, anchor.y), 0.01);\n        var outL = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 12, anchor.y - 4.5), 0.01);\n        var outR = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 12, anchor.y + 4.5), 0.01);\n        this.createLine(inL, midL, \"normal\");\n        this.createLine(inR, midL, \"normal\");\n        this.createLine(midL, midR, \"wave\");\n        this.createLine(midR, outL, \"normal\");\n        this.createLine(midR, outR, \"normal\");\n        this.cursorVertexId = midR.id;\n    };\n    ScriptEngine.prototype.createTemplateTriangle = function (anchor) {\n        var v1 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x, anchor.y - 5), 0.01);\n        var v2 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 5.5, anchor.y + 4), 0.01);\n        var v3 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 5.5, anchor.y + 4), 0.01);\n        var extTop = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x, anchor.y - 11), 0.01);\n        var extLeft = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 11, anchor.y + 5), 0.01);\n        var extRight = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 11, anchor.y + 5), 0.01);\n        this.createLine(v1, v2, \"normal\");\n        this.createLine(v2, v3, \"normal\");\n        this.createLine(v3, v1, \"normal\");\n        this.createLine(extTop, v1, \"wave\");\n        this.createLine(extLeft, v2, \"wave\");\n        this.createLine(v3, extRight, \"wave\");\n        this.cursorVertexId = v1.id;\n    };\n    ScriptEngine.prototype.createTemplateTChannel = function (anchor) {\n        var inTop = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 11, anchor.y - 5), 0.01);\n        var inBottom = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 11, anchor.y + 5), 0.01);\n        var leftTop = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 3, anchor.y - 3), 0.01);\n        var leftBottom = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 3, anchor.y + 3), 0.01);\n        var rightTop = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 3, anchor.y - 3), 0.01);\n        var rightBottom = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 3, anchor.y + 3), 0.01);\n        var outTop = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 11, anchor.y - 5), 0.01);\n        var outBottom = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 11, anchor.y + 5), 0.01);\n        this.createLine(inTop, leftTop, \"normal\");\n        this.createLine(inBottom, leftBottom, \"normal\");\n        this.createLine(leftTop, rightTop, \"normal\");\n        this.createLine(leftBottom, rightBottom, \"normal\");\n        this.createLine(leftTop, leftBottom, \"wave\");\n        this.createLine(rightTop, outTop, \"normal\");\n        this.createLine(rightBottom, outBottom, \"normal\");\n        this.cursorVertexId = rightTop.id;\n    };\n    ScriptEngine.prototype.createTemplateWExchange = function (anchor) {\n        var inA = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 14, anchor.y - 5), 0.01);\n        var inB = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 14, anchor.y + 5), 0.01);\n        var weakL = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 4, anchor.y), 0.01);\n        var weakR = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 4, anchor.y), 0.01);\n        var outA = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 14, anchor.y - 5), 0.01);\n        var outB = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 14, anchor.y + 5), 0.01);\n        this.createLine(inA, weakL, \"normal\");\n        this.createLine(inB, weakL, \"normal\");\n        this.createLine(weakL, weakR, \"wave\");\n        this.createLine(weakR, outA, \"normal\");\n        this.createLine(weakR, outB, \"normal\");\n        this.cursorVertexId = weakR.id;\n    };\n    ScriptEngine.prototype.createTemplateBhabhaT = function (anchor) {\n        var inElectron = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 13, anchor.y - 4), 0.01);\n        var outElectron = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 13, anchor.y - 4), 0.01);\n        var inPositron = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 13, anchor.y + 4), 0.01);\n        var outPositron = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 13, anchor.y + 4), 0.01);\n        var topLeft = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 3, anchor.y - 4), 0.01);\n        var topRight = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 3, anchor.y - 4), 0.01);\n        var bottomLeft = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 3, anchor.y + 4), 0.01);\n        var bottomRight = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 3, anchor.y + 4), 0.01);\n        this.createLine(inElectron, topLeft, \"normal\");\n        this.createLine(topLeft, topRight, \"normal\");\n        this.createLine(topRight, outElectron, \"normal\");\n        this.createLine(inPositron, bottomLeft, \"normal\");\n        this.createLine(bottomLeft, bottomRight, \"normal\");\n        this.createLine(bottomRight, outPositron, \"normal\");\n        this.createLine(topLeft, bottomRight, \"wave\");\n        this.cursorVertexId = topRight.id;\n    };\n    ScriptEngine.prototype.createTemplateSunset = function (anchor) {\n        var left = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 12, anchor.y), 0.01);\n        var midLeft = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 5, anchor.y), 0.01);\n        var midRight = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 5, anchor.y), 0.01);\n        var right = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 12, anchor.y), 0.01);\n        var upperLeftCenter = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - 2.5, anchor.y - 4), 0.01);\n        var upperRightCenter = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + 2.5, anchor.y - 4), 0.01);\n        this.createLine(left, midLeft, \"normal\");\n        this.createLine(midLeft, midRight, \"normal\");\n        this.createLine(midRight, right, \"normal\");\n        var loopA = new _Core_Loop__WEBPACK_IMPORTED_MODULE_1__.Loop();\n        loopA.origin = upperLeftCenter;\n        loopA.setRadius(3.2);\n        loopA.style = \"wave\";\n        this.repository.doCommand(new _UI_RepositoryCommand__WEBPACK_IMPORTED_MODULE_4__.SetLoop(loopA));\n        var loopB = new _Core_Loop__WEBPACK_IMPORTED_MODULE_1__.Loop();\n        loopB.origin = upperRightCenter;\n        loopB.setRadius(3.2);\n        loopB.style = \"wave\";\n        this.repository.doCommand(new _UI_RepositoryCommand__WEBPACK_IMPORTED_MODULE_4__.SetLoop(loopB));\n        this.cursorVertexId = midRight.id;\n    };\n    ScriptEngine.prototype.createTemplateDoubleBox = function (anchor) {\n        var size = 6;\n        var gap = 2;\n        var arm = 5;\n        var l1 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - size - gap, anchor.y - size), 0.01);\n        var l2 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - gap, anchor.y - size), 0.01);\n        var l3 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - gap, anchor.y + size), 0.01);\n        var l4 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x - size - gap, anchor.y + size), 0.01);\n        var r1 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + gap, anchor.y - size), 0.01);\n        var r2 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + size + gap, anchor.y - size), 0.01);\n        var r3 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + size + gap, anchor.y + size), 0.01);\n        var r4 = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(anchor.x + gap, anchor.y + size), 0.01);\n        this.createLine(l1, l2, \"normal\");\n        this.createLine(l2, l3, \"normal\");\n        this.createLine(l3, l4, \"normal\");\n        this.createLine(l4, l1, \"normal\");\n        this.createLine(r1, r2, \"normal\");\n        this.createLine(r2, r3, \"normal\");\n        this.createLine(r3, r4, \"normal\");\n        this.createLine(r4, r1, \"normal\");\n        this.createLine(l2, r1, \"normal\");\n        this.createLine(l3, r4, \"normal\");\n        var inTop = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(l1.x - arm, l1.y - arm), 0.01);\n        var inBottom = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(l4.x - arm, l4.y + arm), 0.01);\n        var outTop = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(r2.x + arm, r2.y - arm), 0.01);\n        var outBottom = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(r3.x + arm, r3.y + arm), 0.01);\n        this.createLine(inTop, l1, \"wave\");\n        this.createLine(inBottom, l4, \"wave\");\n        this.createLine(r2, outTop, \"wave\");\n        this.createLine(r3, outBottom, \"wave\");\n        this.cursorVertexId = r2.id;\n    };\n    ScriptEngine.prototype.createLine = function (start, end, style) {\n        var line = new _Core_Line__WEBPACK_IMPORTED_MODULE_0__.Line();\n        line.style = style;\n        this.repository.bindLineToVertices(line, start, end);\n        this.repository.doCommand(new _UI_RepositoryCommand__WEBPACK_IMPORTED_MODULE_4__.SetLine(line));\n    };\n    ScriptEngine.prototype.executeQEDSelfEnergy = function (tokens) {\n        if (tokens.length !== 4) {\n            return \"Usage: qed_se x y length\";\n        }\n        var x = Number(tokens[1]);\n        var y = Number(tokens[2]);\n        var length = Number(tokens[3]);\n        if (![x, y, length].every(function (value) { return Number.isFinite(value); }) || length <= 0) {\n            return \"qed_se arguments must be numeric and length > 0.\";\n        }\n        var start = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(x, y));\n        var end = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(x + length, y));\n        var radius = Math.max(1, length * 0.15);\n        var centerX = x + length / 2;\n        var midL = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(centerX - radius, y));\n        var midR = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(centerX + radius, y));\n        var inLine = new _Core_Line__WEBPACK_IMPORTED_MODULE_0__.Line();\n        this.repository.bindLineToVertices(inLine, start, midL);\n        inLine.style = \"normal\";\n        this.repository.doCommand(new _UI_RepositoryCommand__WEBPACK_IMPORTED_MODULE_4__.SetLine(inLine));\n        var outLine = new _Core_Line__WEBPACK_IMPORTED_MODULE_0__.Line();\n        this.repository.bindLineToVertices(outLine, midR, end);\n        outLine.style = \"normal\";\n        this.repository.doCommand(new _UI_RepositoryCommand__WEBPACK_IMPORTED_MODULE_4__.SetLine(outLine));\n        var loop = new _Core_Loop__WEBPACK_IMPORTED_MODULE_1__.Loop();\n        loop.origin = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(centerX, y));\n        loop.setRadius(radius);\n        loop.style = \"wave\";\n        loop.loopBeginAngle = 0;\n        loop.loopEndAngle = Math.PI;\n        this.repository.doCommand(new _UI_RepositoryCommand__WEBPACK_IMPORTED_MODULE_4__.SetLoop(loop));\n        this.cursorVertexId = end.id;\n        return null;\n    };\n    ScriptEngine.prototype.executeQEDVacuumPolarization = function (tokens) {\n        if (tokens.length !== 4) {\n            return \"Usage: qed_vp x y length\";\n        }\n        var x = Number(tokens[1]);\n        var y = Number(tokens[2]);\n        var length = Number(tokens[3]);\n        if (![x, y, length].every(function (value) { return Number.isFinite(value); }) || length <= 0) {\n            return \"qed_vp arguments must be numeric and length > 0.\";\n        }\n        var start = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(x, y));\n        var end = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(x + length, y));\n        var radius = Math.max(1, length * 0.15);\n        var centerX = x + length / 2;\n        var midL = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(centerX - radius, y));\n        var midR = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(centerX + radius, y));\n        var inPhoton = new _Core_Line__WEBPACK_IMPORTED_MODULE_0__.Line();\n        this.repository.bindLineToVertices(inPhoton, start, midL);\n        inPhoton.style = \"wave\";\n        this.repository.doCommand(new _UI_RepositoryCommand__WEBPACK_IMPORTED_MODULE_4__.SetLine(inPhoton));\n        var outPhoton = new _Core_Line__WEBPACK_IMPORTED_MODULE_0__.Line();\n        this.repository.bindLineToVertices(outPhoton, midR, end);\n        outPhoton.style = \"wave\";\n        this.repository.doCommand(new _UI_RepositoryCommand__WEBPACK_IMPORTED_MODULE_4__.SetLine(outPhoton));\n        var loop = new _Core_Loop__WEBPACK_IMPORTED_MODULE_1__.Loop();\n        loop.origin = this.getOrCreateVertex(new _Core_Vector__WEBPACK_IMPORTED_MODULE_2__.Vector(centerX, y));\n        loop.setRadius(radius);\n        loop.style = \"normal\";\n        this.repository.doCommand(new _UI_RepositoryCommand__WEBPACK_IMPORTED_MODULE_4__.SetLoop(loop));\n        this.cursorVertexId = end.id;\n        return null;\n    };\n    ScriptEngine.prototype.getCursorVertex = function () {\n        if (!this.cursorVertexId) {\n            return undefined;\n        }\n        return this.repository.getVertex(this.cursorVertexId);\n    };\n    ScriptEngine.prototype.getOrCreateVertex = function (point, tolerance) {\n        if (tolerance === void 0) { tolerance = 0.15; }\n        var existing = this.repository.findNearestVertex(point, tolerance);\n        if (existing) {\n            return existing;\n        }\n        var vertex = new _Core_Vertex__WEBPACK_IMPORTED_MODULE_3__.Vertex(point.x, point.y);\n        this.repository.doCommand(new _UI_RepositoryCommand__WEBPACK_IMPORTED_MODULE_4__.SetVertex(vertex));\n        var created = this.repository.getVertex(vertex.id);\n        if (created) {\n            return created;\n        }\n        return vertex;\n    };\n    ScriptEngine.TEMPLATE_CATALOG = [\n        { name: \"qed_box\", label: \"QED Box\", description: \"1-loop 4-point box scattering with four external photons.\" },\n        { name: \"qed_vertex\", label: \"QED Vertex\", description: \"One-loop vertex correction with external photon leg.\" },\n        { name: \"qed_vac\", label: \"QED Vacuum\", description: \"Vacuum polarization: photon line with fermion loop insertion.\" },\n        { name: \"penguin\", label: \"Penguin\", description: \"Flavor-changing penguin-like topology with emitted gluon.\" },\n        { name: \"compton\", label: \"Compton\", description: \"Tree-level Compton-like electron-photon scattering.\" },\n        { name: \"s_channel\", label: \"s-channel\", description: \"Two-into-two scattering through s-channel propagator.\" },\n        { name: \"triangle\", label: \"Triangle\", description: \"Triangle loop with three external boson legs.\" },\n        { name: \"t_channel\", label: \"t-channel\", description: \"Two-into-two scattering through t-channel mediator.\" },\n        { name: \"w_exchange\", label: \"W Exchange\", description: \"Charged-current style exchange skeleton.\" },\n        { name: \"bhabha_t\", label: \"Bhabha t\", description: \"Bhabha-like t-channel exchange topology.\" },\n        { name: \"sunset\", label: \"Sunset\", description: \"Two-loop self-energy inspired sunset motif.\" },\n        { name: \"double_box\", label: \"Double Box\", description: \"Two adjacent loop boxes for higher-order amplitudes.\" },\n    ];\n    return ScriptEngine;\n}());\n\n\n\n//# sourceURL=webpack://rdfeyn/./src/Scripting/ScriptEngine.ts?");

/***/ }),

/***/ "./src/UI/CommandRegistry.ts":
/*!***********************************!*\
  !*** ./src/UI/CommandRegistry.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"CommandRegistry\": () => (/* binding */ CommandRegistry)\n/* harmony export */ });\n/**\n * Central registry for UI commands. The registry knows how to add, retrieve,\n * and execute command definitions, enabling us to keep the main UI class\n * focused on high-level orchestration instead of switch statements.\n */\nvar CommandRegistry = /** @class */ (function () {\n    function CommandRegistry() {\n        this.commands = new Map();\n    }\n    CommandRegistry.prototype.register = function (command) {\n        this.commands.set(command.id, command);\n    };\n    /**\n     * Executes a command if it has been registered. Returns `false` when a\n     * command identifier is unknown so callers can decide how to react.\n     */\n    CommandRegistry.prototype.execute = function (id, host, pointer) {\n        var command = this.commands.get(id);\n        if (!command) {\n            return false;\n        }\n        if (command.requiresPointer && !pointer) {\n            throw new Error(\"Command '\".concat(id, \"' requires a pointer position.\"));\n        }\n        command.execute({ host: host, pointer: pointer });\n        return true;\n    };\n    CommandRegistry.prototype.list = function () {\n        return Array.from(this.commands.values());\n    };\n    return CommandRegistry;\n}());\n\n\n\n//# sourceURL=webpack://rdfeyn/./src/UI/CommandRegistry.ts?");

/***/ }),

/***/ "./src/UI/DrawContext.ts":
/*!*******************************!*\
  !*** ./src/UI/DrawContext.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"DrawContext\": () => (/* binding */ DrawContext)\n/* harmony export */ });\n/* harmony import */ var _Config__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../Config */ \"./src/Config.ts\");\n/* harmony import */ var _Core_Vector__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../Core/Vector */ \"./src/Core/Vector.ts\");\n/* harmony import */ var _looger__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../looger */ \"./src/looger.ts\");\n/* harmony import */ var _UIColor__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./UIColor */ \"./src/UI/UIColor.ts\");\n\n\n\n\n/**\n * DrawContext\n *\n * This class is used to draw on canvas.\n */\nvar DrawContext = /** @class */ (function () {\n    function DrawContext(context) {\n        this.exportType = \"canvas\";\n        this.exportString = \"\";\n        this.coordinate = new _Core_Vector__WEBPACK_IMPORTED_MODULE_1__.Vector(0, 0);\n        this.scale = _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale;\n        this.viewOffset = new _Core_Vector__WEBPACK_IMPORTED_MODULE_1__.Vector(0, 0);\n        this.canvasContext = context;\n        this.canvasContext.font = \"25px Arial\";\n    }\n    DrawContext.prototype.setViewOffset = function (offset) {\n        this.viewOffset = new _Core_Vector__WEBPACK_IMPORTED_MODULE_1__.Vector(offset.x, offset.y);\n    };\n    DrawContext.prototype.getViewOffset = function () {\n        return new _Core_Vector__WEBPACK_IMPORTED_MODULE_1__.Vector(this.viewOffset.x, this.viewOffset.y);\n    };\n    DrawContext.prototype.canvasX = function (x) {\n        return (x + this.viewOffset.x) * this.scale;\n    };\n    DrawContext.prototype.canvasY = function (y) {\n        return (y + this.viewOffset.y) * this.scale;\n    };\n    /**\n     * output is used to output the result of drawing.\n     */\n    DrawContext.prototype.output = function (desc, exportType, id) {\n        if (this.exportType == \"canvas\") {\n            if (id == \"sub\") {\n                var selector = document.querySelector(\"div#sub\");\n                selector.textContent = desc;\n                return;\n            }\n            if (id == \"current\") {\n                var selector = document.querySelector(\"div#current\");\n                selector.textContent = desc;\n                return;\n            }\n            if (id == \"mode\") {\n                var selector = document.querySelector(\"div#mode\");\n                selector.textContent = desc;\n                return;\n            }\n        }\n    };\n    /**\n     * set the color of stroke.\n     */\n    DrawContext.prototype.setStrokeColor = function (color) {\n        if (this.exportType == \"canvas\") {\n            this.canvasContext.strokeStyle = (0,_UIColor__WEBPACK_IMPORTED_MODULE_3__.getColor)(color);\n            return;\n        }\n    };\n    /**\n     * set the color of fill.\n     */\n    DrawContext.prototype.setFillColor = function (color) {\n        if (this.exportType == \"canvas\") {\n            this.canvasContext.fillStyle = (0,_UIColor__WEBPACK_IMPORTED_MODULE_3__.getColor)(color);\n            return;\n        }\n    };\n    /**\n     * set export type.\n     */\n    DrawContext.prototype.setExportType = function (exportType) {\n        this.exportType = exportType;\n        if (exportType == \"canvas\") {\n            this.scale = _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale;\n        }\n        if (exportType == \"tikz\") {\n            this.scale = _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale / _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale;\n        }\n        if (exportType == \"svg\") {\n            this.scale = _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale;\n        }\n        if (exportType !== \"canvas\") {\n            this.viewOffset = new _Core_Vector__WEBPACK_IMPORTED_MODULE_1__.Vector(0, 0);\n        }\n    };\n    /**\n     * begin path.\n     */\n    DrawContext.prototype.beginPath = function () {\n        if (this.exportType == \"canvas\") {\n            this.canvasContext.beginPath();\n            return;\n        }\n    };\n    /**\n     * move to a point.\n     */\n    DrawContext.prototype.moveTo = function (x, y) {\n        this.coordinate = new _Core_Vector__WEBPACK_IMPORTED_MODULE_1__.Vector(x, y);\n    };\n    /**\n     * close path.\n     */\n    DrawContext.prototype.closePath = function () {\n        if (this.exportType == \"canvas\") {\n            this.canvasContext.closePath();\n            return;\n        }\n    };\n    // setLineDash(style: LineStyle) {\n    //     loggerVer(\"setLineDash:\" + style)\n    //     this.lineDashStyle = style\n    // }\n    // setLoopDash(style: LineStyle) {\n    //     loggerVer(\"setLoopDash:\" + style)\n    //     this.loopDashStyle = style\n    // }\n    /**\n     * add string for export.\n     */\n    DrawContext.prototype.addExport = function (txt) {\n        this.exportString += txt;\n    };\n    /**\n     * set line into point (x,y).\n     */\n    DrawContext.prototype.lineTo = function (x, y_, linestyle) {\n        if (this.exportType == \"canvas\") {\n            var y = y_;\n            if (linestyle == \"dash\") {\n                this.canvasContext.setLineDash([2, 2]);\n            }\n            else {\n                this.canvasContext.setLineDash([]);\n            }\n            this.canvasContext.moveTo(this.canvasX(this.coordinate.x), this.canvasY(this.coordinate.y));\n            this.canvasContext.lineTo(this.canvasX(x), this.canvasY(y));\n            this.coordinate = new _Core_Vector__WEBPACK_IMPORTED_MODULE_1__.Vector(x, y);\n            return;\n        }\n        if (this.exportType == \"tikz\") {\n            var y = -y_;\n            if (linestyle == \"wave\") {\n                this.addExport(\"\\\\draw [snake=snake, segment amplitude=0.2mm,segment length=1mm](\".concat(this.coordinate.x, \",\").concat(-this.coordinate.y, \") -- (\").concat(x, \",\").concat(y, \");\\n\"));\n                return;\n            }\n            if (linestyle == \"coil\") {\n                // コイル線のパラメータ\n                var segmentLength = 1.0;\n                var aspect = 0.9;\n                var amplitude = 0.5;\n                var from = void 0, to = void 0;\n                var pathLength = void 0;\n                from = new _Core_Vector__WEBPACK_IMPORTED_MODULE_1__.Vector(this.coordinate.x, -this.coordinate.y);\n                to = new _Core_Vector__WEBPACK_IMPORTED_MODULE_1__.Vector(x, -y_);\n                pathLength = to.minus(from).length();\n                // 経路の長さが1波長(segmentLength)よりも短い場合、線の装飾をしない。\n                if (pathLength < segmentLength) {\n                    this.addExport(\"\\\\draw(\".concat(from.x, \",\").concat(from.y, \") -- (\").concat(to.x, \",\").concat(to.y, \");\\n\"));\n                }\n                else {\n                    var n = void 0;\n                    var coilNTimesLength = void 0;\n                    var effectiveSegmentLength = void 0;\n                    n = Math.floor(pathLength / segmentLength);\n                    coilNTimesLength =\n                        2 * aspect * amplitude + (n - 1 / 2) * segmentLength;\n                    effectiveSegmentLength =\n                        segmentLength + (pathLength - coilNTimesLength) / (n - 1 / 2);\n                    this.addExport(\"\\\\draw[decorate, decoration={coil,\" +\n                        \"amplitude = \".concat(amplitude, \"mm,\") +\n                        \"segment length = \".concat(effectiveSegmentLength, \"mm,\") +\n                        \"aspect = \".concat(aspect) +\n                        \"}]\" +\n                        \"(\".concat(from.x, \",\").concat(from.y, \") -- (\").concat(to.x, \",\").concat(to.y, \");\\n\"));\n                }\n                return;\n            }\n            if (linestyle == \"dash\") {\n                this.addExport(\"\\\\draw [dashed](\".concat(this.coordinate.x, \",\").concat(-this.coordinate\n                    .y, \") -- (\").concat(x, \",\").concat(y, \");\\n\"));\n            }\n            else {\n                this.addExport(\"\\\\draw (\".concat(this.coordinate.x, \",\").concat(-this.coordinate\n                    .y, \") -- (\").concat(x, \",\").concat(y, \");\\n\"));\n            }\n            this.coordinate = new _Core_Vector__WEBPACK_IMPORTED_MODULE_1__.Vector(x, y_);\n            return;\n        }\n        if (this.exportType === \"svg\") {\n            var dash = \"\";\n            if (linestyle === \"dash\") {\n                dash = 'stroke-dasharray=\"4\"';\n            }\n            this.addExport(\"<line x1=\\\"\".concat(this.coordinate.x * this.scale, \"\\\" y1=\\\"\").concat(this.coordinate.y * this.scale, \"\\\" x2=\\\"\").concat(x * this.scale, \"\\\" y2=\\\"\").concat(y_ * this.scale, \"\\\" stroke=\\\"black\\\" \").concat(dash, \"/>\"));\n            this.coordinate = new _Core_Vector__WEBPACK_IMPORTED_MODULE_1__.Vector(x, y_);\n            return;\n        }\n    };\n    // fill() {\n    //     if (this.exportType == \"canvas\") {\n    //         this.canvasContext.fill()\n    //         return\n    //     }\n    // }\n    /**\n     * fill rectangle.\n     */\n    DrawContext.prototype.fillRect = function (x, y_, w, h) {\n        if (this.exportType == \"canvas\") {\n            var y = y_;\n            // loggerVer(`fillRect${x} ${y} ${w} ${h}`);\n            this.canvasContext.fillRect(this.canvasX(x), this.canvasY(y), w * this.scale, h * this.scale);\n            return;\n        }\n    };\n    /**\n     * clear rectangle.\n     */\n    DrawContext.prototype.clearRect = function () {\n        if (this.exportType == \"canvas\") {\n            this.canvasContext.clearRect(0, 0, this.canvasContext.canvas.width, this.canvasContext.canvas.height);\n            return;\n        }\n        if (this.exportType == \"tikz\") {\n            this.exportString = \"\";\n        }\n        if (this.exportType == \"svg\") {\n            this.exportString = \"\";\n        }\n    };\n    /**\n     * stroke.\n     */\n    DrawContext.prototype.stroke = function () {\n        if (this.exportType == \"canvas\") {\n            this.canvasContext.stroke();\n            return;\n        }\n    };\n    /**\n     * fill text\n     */\n    DrawContext.prototype.fillText = function (txt, x, y) {\n        if (this.exportType == \"canvas\") {\n            this.canvasContext.fillText(txt, this.canvasX(x), this.canvasY(y));\n            return;\n        }\n        if (this.exportType == \"tikz\") {\n            // \\node[align=left] at (19,19) {\\tiny $\\int dx y^2$};\n            this.addExport(\"\\\\node[align=left] at (\".concat(x, \",\").concat(-y, \") {\\\\scalebox{0.3} { $\").concat(txt, \"$}};\"));\n            return;\n        }\n        if (this.exportType == \"svg\") {\n            this.addExport(\"<text x=\\\"\".concat(x * this.scale, \"\\\" y=\\\"\").concat(y * this.scale, \"\\\" font-family=\\\"Verdana\\\" font-size=\\\"35\\\">\\n        \").concat(txt, \"</text>\"));\n            return;\n        }\n    };\n    /**\n     * draw arc\n     */\n    DrawContext.prototype.arc = function (x, y_, radius, startAngle, endAngle, loopStyle, fill) {\n        if (this.exportType == \"canvas\") {\n            var y = y_;\n            if (loopStyle == \"dash\") {\n                this.canvasContext.setLineDash([2, 2]);\n            }\n            else {\n                this.canvasContext.setLineDash([]);\n            }\n            this.canvasContext.arc(this.canvasX(x), this.canvasY(y), radius * this.scale, startAngle, endAngle);\n            if (fill) {\n                this.canvasContext.fill();\n            }\n            return;\n        }\n        if (this.exportType == \"tikz\") {\n            var y = -y_;\n            var ea = (-startAngle / (2 * Math.PI)) * 360;\n            var sa = (-endAngle / (2 * Math.PI)) * 360;\n            for (var n = 0; n < 2; n++) {\n                if (sa < 0) {\n                    sa += 360;\n                }\n                if (sa > 360) {\n                    sa -= 360;\n                }\n                if (ea < 0) {\n                    ea += 360;\n                }\n                if (ea > 360) {\n                    ea -= 360;\n                }\n                if (sa > ea) {\n                    ea += 360;\n                }\n            }\n            var option = \"\";\n            if (loopStyle == \"dash\") {\n                option = \"[dashed]\";\n            }\n            if (loopStyle == \"wave\") {\n                option = \"[decorate, decoration={snake, amplitude = 0.2mm, segment length = 1mm}]\";\n            }\n            if (loopStyle == \"coil\") {\n                // コイル線のパラメータ\n                var segmentLength = 1.0;\n                var aspect = 0.9;\n                var amplitude = 0.5;\n                var pathLength = void 0;\n                pathLength = radius * (endAngle - startAngle);\n                // 経路の長さが1波長(segmentLength)よりも短い場合、線の装飾をしない。\n                if (pathLength < segmentLength) {\n                    option = \"\";\n                }\n                else {\n                    var n = void 0;\n                    var effectiveSegmentLength = void 0;\n                    var coilNTimesLength = void 0;\n                    n = Math.floor(pathLength / segmentLength);\n                    coilNTimesLength =\n                        2 * aspect * amplitude + (n - 1 / 2) * segmentLength;\n                    effectiveSegmentLength =\n                        segmentLength + (pathLength - coilNTimesLength) / (n - 1 / 2);\n                    option =\n                        \"[decorate, decoration={coil,\" +\n                            \"amplitude = \".concat(amplitude, \"mm,\") +\n                            \"segment length = \".concat(effectiveSegmentLength, \"mm,\") +\n                            \"aspect = \".concat(aspect) +\n                            \"}]\";\n                }\n            }\n            var command = \"\\\\draw\";\n            if (fill) {\n                command = \"\\\\fill\";\n            }\n            if (Math.abs(endAngle - startAngle) == 2 * Math.PI) {\n                this.addExport(\"\".concat(command, \" \").concat(option, \" (\").concat(x, \",\").concat(y, \") circle [radius=\").concat(radius, \"];\"));\n            }\n            else {\n                this.addExport(\"\".concat(command, \" \").concat(option, \" ([shift=(\").concat(sa, \":\").concat(radius, \")]\").concat(x, \", \").concat(y, \") arc [radius=\").concat(radius, \", start angle=\").concat(sa, \", end angle=\").concat(ea, \"];\"));\n            }\n            return;\n        }\n        if (this.exportType == \"svg\") {\n            var y = y_;\n            var dash = \"\";\n            if (loopStyle == \"dash\") {\n                dash = 'stroke-dasharray=\"4\"';\n            }\n            if (Math.abs(startAngle - endAngle) <= (Math.PI / 1) * 360) {\n                var fillStr = \"fill=\\\"none\\\"\";\n                if (fill) {\n                    fillStr = \"fill=\\\"black\\\"\";\n                }\n                this.addExport(\"<circle cx=\\\"\".concat(x * this.scale, \"\\\" cy=\\\"\").concat(y * this.scale, \"\\\" r=\\\"\").concat(radius * this.scale, \"\\\" stroke=\\\"black\\\" \").concat(dash, \" \").concat(fillStr, \"/>\"));\n                return;\n            }\n            // TODO cole, wave\n            var sx = x + radius * Math.cos(startAngle);\n            var sy = y + radius * Math.sin(startAngle);\n            var ex = x + radius * Math.cos(endAngle);\n            var ey = y + radius * Math.sin(endAngle);\n            var angle = (360 * (endAngle - startAngle)) / (2 * Math.PI);\n            var lx = 0;\n            var ly = 0;\n            if (angle > 0) {\n                ly = 1;\n            }\n            this.addExport(\"<path d=\\\"M \".concat(sx * this.scale, \", \").concat(sy * this.scale, \" A \").concat(radius * this.scale, \" \").concat(radius * this.scale, \" \").concat(angle, \" \").concat(lx, \" \").concat(ly, \" \").concat(ex * this.scale, \", \").concat(ey * this.scale, \"\\\" stroke=\\\"black\\\" \").concat(dash, \" fill=\\\"none\\\"/>\"));\n        }\n    };\n    DrawContext.prototype.startExport = function () {\n        if (this.exportType == \"tikz\") {\n            this.addExport(\"\\\\newcommand{\\\\myDiagram}{\");\n            this.addExport(\"\\\\begin{tikzpicture}[scale=0.1, baseline=(current bounding box.center)]\\n\");\n            return;\n        }\n        if (this.exportType == \"svg\") {\n            this.addExport(\"<svg viewBox=\\\"0 0 \".concat(50 * this.scale, \" \").concat(50 * this.scale, \"\\\">\"));\n        }\n        return;\n    };\n    /**\n     * return export string\n     */\n    DrawContext.prototype.endExport = function () {\n        if (this.exportType == \"tikz\") {\n            this.addExport(\"\\\\end{tikzpicture}\\n \");\n            this.addExport(\"}\\n \");\n            var selector = document.querySelector(\"div#output-tikz\");\n            selector.textContent = this.exportString;\n            var ret = this.exportString;\n            (0,_looger__WEBPACK_IMPORTED_MODULE_2__.loggerVer)(this.exportString);\n            this.exportString = \"\";\n            return ret;\n        }\n        if (this.exportType == \"svg\") {\n            this.addExport(\"</svg>\");\n            var selector = document.querySelector(\"div#output-svg\");\n            selector.textContent = this.exportString;\n            this.fildDownload(this.exportString);\n            var ret = this.exportString;\n            (0,_looger__WEBPACK_IMPORTED_MODULE_2__.loggerVer)(this.exportString);\n            this.exportString = \"\";\n            return ret;\n        }\n        return \"\";\n    };\n    /**\n     *  save data\n     */\n    DrawContext.prototype.insertsavedata = function (saveData) {\n        if (this.exportType == \"svg\") {\n            this.addExport(\"<!-- QuantumSketchSaveDataStart@\".concat(saveData, \"@ -->\"));\n        }\n    };\n    /**\n     * file download\n     */\n    DrawContext.prototype.fildDownload = function (content) {\n        var blob = new Blob([content], { type: \"text/plain\" });\n        var link = document.getElementById(\"download\");\n        if (link) {\n            link.href = window.URL.createObjectURL(blob);\n            var dateStr = new Date().toISOString();\n            var fileName = \"\".concat(dateStr, \".svg\");\n            link.download = fileName;\n            link.hidden = false;\n        }\n    };\n    return DrawContext;\n}());\n\n\n\n//# sourceURL=webpack://rdfeyn/./src/UI/DrawContext.ts?");

/***/ }),

/***/ "./src/UI/RDDraw.ts":
/*!**************************!*\
  !*** ./src/UI/RDDraw.ts ***!
  \**************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"RDDraw\": () => (/* binding */ RDDraw)\n/* harmony export */ });\n/* harmony import */ var _Config__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../Config */ \"./src/Config.ts\");\n/* harmony import */ var _Core_Line__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../Core/Line */ \"./src/Core/Line.ts\");\n/* harmony import */ var _Core_Loop__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../Core/Loop */ \"./src/Core/Loop.ts\");\n/* harmony import */ var _Core_MyString__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../Core/MyString */ \"./src/Core/MyString.ts\");\n/* harmony import */ var _Core_Vector__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../Core/Vector */ \"./src/Core/Vector.ts\");\n/* harmony import */ var _Core_Vertex__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../Core/Vertex */ \"./src/Core/Vertex.ts\");\n/* harmony import */ var _Core_Group__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ../Core/Group */ \"./src/Core/Group.ts\");\n/* harmony import */ var _looger__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ../looger */ \"./src/looger.ts\");\n/* harmony import */ var _Scripting_ScriptEngine__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ../Scripting/ScriptEngine */ \"./src/Scripting/ScriptEngine.ts\");\n/* harmony import */ var _draw__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ./draw */ \"./src/UI/draw.ts\");\n/* harmony import */ var _RDRepository__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./RDRepository */ \"./src/UI/RDRepository.ts\");\n/* harmony import */ var _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./RepositoryCommand */ \"./src/UI/RepositoryCommand.ts\");\n/* harmony import */ var _CommandRegistry__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! ./CommandRegistry */ \"./src/UI/CommandRegistry.ts\");\n\n\n\n\n\n\n\n\n\n\n\n\n\n/**\n * Central UI orchestrator for the editor. This class owns the canvas draw\n * loop, manages repository mutations, and routes all user input (clicks,\n * keyboard, command buttons) through a command registry so that new features\n * can be added without editing a monolithic switch statement.\n */\nvar RDDraw = /** @class */ (function () {\n    function RDDraw(canvas, drawContext) {\n        this.repository = new _RDRepository__WEBPACK_IMPORTED_MODULE_10__.RDRepository();\n        // private prevX: number = 0;\n        // private prevY: number = 0;\n        this.pointerPrev = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(0, 0);\n        this.rawPointer = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(0, 0);\n        this.drawMode = \"normal\";\n        this.isNoSelectMode = false;\n        this.contextMenuElement = null;\n        this.commandRegistry = new _CommandRegistry__WEBPACK_IMPORTED_MODULE_12__.CommandRegistry();\n        this.loopControls = {\n            container: null,\n            radiusSlider: null,\n            startSlider: null,\n            endSlider: null,\n            radiusValue: null,\n            startValue: null,\n            endValue: null,\n            arcValue: null,\n            gapValue: null,\n        };\n        this.interactionState = { type: \"idle\" };\n        this.spacePanActive = false;\n        this.dslScriptElement = null;\n        this.dslStatusElement = null;\n        this.dslLogElement = null;\n        this.selectionMacroEditMode = false;\n        this.canvas = canvas;\n        this.context = canvas.getContext(\"2d\");\n        this.drawContext = drawContext;\n        this.scriptEngine = new _Scripting_ScriptEngine__WEBPACK_IMPORTED_MODULE_8__.ScriptEngine(this.repository);\n        this.registerCommands();\n        this.bind();\n        this.drawAll();\n    }\n    RDDraw.prototype.bind = function () {\n        var _this = this;\n        var _a, _b, _c, _d, _e;\n        this.canvas.addEventListener(\"dblclick\", function (ev) {\n            _this.onCanvasDoubleClick(ev);\n        });\n        this.canvas.addEventListener(\"mousedown\", function (ev) {\n            _this.mouseDown(ev);\n        });\n        this.canvas.addEventListener(\"mouseup\", function (ev) {\n            _this.mouseUp(ev);\n        });\n        this.canvas.addEventListener(\"mousemove\", function (ev) {\n            _this.move(ev);\n        });\n        document.addEventListener(\"keydown\", function (ev) {\n            _this.onKeyDown(ev);\n        });\n        document.addEventListener(\"keyup\", function (ev) {\n            _this.onKeyUp(ev);\n        });\n        this.canvas.addEventListener(\"wheel\", function (ev) {\n            _this.onCanvasWheel(ev);\n        }, { passive: false });\n        window.addEventListener(\"resize\", function () {\n            _this.resizeCanvasToViewport();\n        });\n        (_a = (document.getElementById(\"nav-redo\"))) === null || _a === void 0 ? void 0 : _a.addEventListener(\"click\", function (ev) {\n            ev.preventDefault();\n            _this.redo();\n        });\n        (_b = (document.getElementById(\"nav-undo\"))) === null || _b === void 0 ? void 0 : _b.addEventListener(\"click\", function (ev) {\n            ev.preventDefault();\n            _this.undo();\n        });\n        (_c = (document.getElementById(\"nav-export-tikz\"))) === null || _c === void 0 ? void 0 : _c.addEventListener(\"click\", function (ev) {\n            ev.preventDefault();\n            _this.drawAll(\"tikz\");\n        });\n        (_d = (document.getElementById(\"nav-export-svg\"))) === null || _d === void 0 ? void 0 : _d.addEventListener(\"click\", function (ev) {\n            ev.preventDefault();\n            _this.drawAll(\"svg\");\n        });\n        (_e = (document.getElementById(\"download\"))) === null || _e === void 0 ? void 0 : _e.addEventListener(\"click\", function (ev) {\n            _this.drawAll(\"svg\");\n        });\n        this.initializeCommandTriggers();\n        this.setupContextMenu();\n        this.setupLoopControls();\n        this.setupScriptInput();\n        this.setupTemplatePresets();\n        this.resizeCanvasToViewport();\n    };\n    RDDraw.prototype.setupTemplatePresets = function () {\n        var _this = this;\n        var _a;\n        var dslScript = document.getElementById(\"dsl-script\");\n        var templateCatalog = document.getElementById(\"dsl-template-catalog\");\n        var templateHelp = document.getElementById(\"dsl-template-help\");\n        var loadMacroButton = document.getElementById(\"dsl-load-template-macro\");\n        var runMacroButton = document.getElementById(\"dsl-run-template-macro\");\n        var dslStatus = document.getElementById(\"dsl-status\");\n        var dslLog = document.getElementById(\"dsl-log\");\n        var templateCatalogItems = this.scriptEngine.getTemplateCatalog();\n        var setStatus = function (message, type) {\n            if (type === void 0) { type = \"neutral\"; }\n            if (!dslStatus) {\n                return;\n            }\n            dslStatus.textContent = message;\n            dslStatus.classList.remove(\"text-secondary\", \"text-success\", \"text-danger\");\n            if (type === \"ok\") {\n                dslStatus.classList.add(\"text-success\");\n                return;\n            }\n            if (type === \"error\") {\n                dslStatus.classList.add(\"text-danger\");\n                return;\n            }\n            dslStatus.classList.add(\"text-secondary\");\n        };\n        var appendLog = function (text, kind) {\n            if (kind === void 0) { kind = \"info\"; }\n            if (!dslLog) {\n                return;\n            }\n            var stamp = new Date().toLocaleTimeString();\n            var prefix = kind === \"ok\" ? \"OK\" : kind === \"error\" ? \"ERR\" : \"INFO\";\n            var line = \"[\".concat(stamp, \"] \").concat(prefix, \" \").concat(text);\n            var previous = dslLog.textContent;\n            if (!previous || previous === \"Execution log is empty.\") {\n                dslLog.textContent = line;\n                return;\n            }\n            dslLog.textContent = \"\".concat(line, \"\\n\").concat(previous);\n        };\n        var updateTemplateHelp = function (templateName) {\n            if (!templateHelp) {\n                return;\n            }\n            var matched = templateCatalogItems.find(function (item) { return item.name === templateName; });\n            if (!matched) {\n                templateHelp.textContent = \"Select a preset to load its macro into the script editor.\";\n                return;\n            }\n            templateHelp.textContent = \"\".concat(matched.label, \": \").concat(matched.description);\n        };\n        var loadTemplateMacro = function (templateName, runNow) {\n            var macro = _this.scriptEngine.buildTemplateMacro(templateName);\n            if (!macro) {\n                setStatus(\"Unknown template '\".concat(templateName, \"'.\"), \"error\");\n                appendLog(\"Template macro failed: unknown '\".concat(templateName, \"'.\"), \"error\");\n                return false;\n            }\n            if (dslScript) {\n                dslScript.value = macro;\n                dslScript.focus();\n                dslScript.setSelectionRange(0, dslScript.value.length);\n            }\n            updateTemplateHelp(templateName);\n            setStatus(\"Template macro loaded into script editor.\", \"ok\");\n            appendLog(\"Template macro loaded: \".concat(templateName), \"info\");\n            if (!runNow) {\n                return true;\n            }\n            var batch = _this.scriptEngine.executeScript(macro, true);\n            if (batch.executed > 0) {\n                _this.drawAll();\n            }\n            if (!batch.success) {\n                setStatus(batch.message, \"error\");\n                appendLog(batch.message, \"error\");\n                return false;\n            }\n            setStatus(\"Template executed: \".concat(templateName), \"ok\");\n            appendLog(\"Template executed: \".concat(templateName), \"ok\");\n            return true;\n        };\n        templateCatalog === null || templateCatalog === void 0 ? void 0 : templateCatalog.addEventListener(\"change\", function () {\n            if (!templateCatalog.value) {\n                updateTemplateHelp(\"\");\n                return;\n            }\n            loadTemplateMacro(templateCatalog.value, false);\n        });\n        loadMacroButton === null || loadMacroButton === void 0 ? void 0 : loadMacroButton.addEventListener(\"click\", function (ev) {\n            ev.preventDefault();\n            var selected = (templateCatalog === null || templateCatalog === void 0 ? void 0 : templateCatalog.value) || \"\";\n            if (!selected) {\n                setStatus(\"Choose a template from the catalog first.\", \"neutral\");\n                return;\n            }\n            loadTemplateMacro(selected, false);\n        });\n        runMacroButton === null || runMacroButton === void 0 ? void 0 : runMacroButton.addEventListener(\"click\", function (ev) {\n            ev.preventDefault();\n            var selected = (templateCatalog === null || templateCatalog === void 0 ? void 0 : templateCatalog.value) || \"\";\n            if (!selected) {\n                setStatus(\"Choose a template from the catalog first.\", \"neutral\");\n                return;\n            }\n            loadTemplateMacro(selected, true);\n        });\n        var presetButtons = document.querySelectorAll(\"[data-template]\");\n        presetButtons.forEach(function (button) {\n            button.addEventListener(\"click\", function (ev) {\n                ev.preventDefault();\n                var template = button.dataset.template;\n                if (!template) {\n                    return;\n                }\n                if (templateCatalog) {\n                    templateCatalog.value = template;\n                }\n                var executed = loadTemplateMacro(template, true);\n                if (!executed) {\n                    (0,_looger__WEBPACK_IMPORTED_MODULE_7__.loggerVer)(\"template '\".concat(template, \"' failed.\"));\n                }\n            });\n        });\n        updateTemplateHelp((_a = templateCatalog === null || templateCatalog === void 0 ? void 0 : templateCatalog.value) !== null && _a !== void 0 ? _a : \"\");\n    };\n    RDDraw.prototype.setupScriptInput = function () {\n        var _this = this;\n        var dslInput = document.getElementById(\"dsl-input\");\n        if (!dslInput) {\n            return;\n        }\n        var dslRun = document.getElementById(\"dsl-run\");\n        var dslClear = document.getElementById(\"dsl-clear\");\n        var dslExampleSelect = document.getElementById(\"dsl-example-select\");\n        var dslInsertExample = document.getElementById(\"dsl-insert-example\");\n        var dslScript = document.getElementById(\"dsl-script\");\n        var dslRunScript = document.getElementById(\"dsl-run-script\");\n        var dslCopyScript = document.getElementById(\"dsl-copy-script\");\n        var dslMacroKind = document.getElementById(\"dsl-macro-kind\");\n        var dslMacroX = document.getElementById(\"dsl-macro-x\");\n        var dslMacroY = document.getElementById(\"dsl-macro-y\");\n        var dslMacroLength = document.getElementById(\"dsl-macro-length\");\n        var dslBuildMacro = document.getElementById(\"dsl-build-macro\");\n        var dslStatus = document.getElementById(\"dsl-status\");\n        var dslLog = document.getElementById(\"dsl-log\");\n        this.dslScriptElement = dslScript;\n        this.dslStatusElement = dslStatus;\n        this.dslLogElement = dslLog;\n        var appendLog = function (text, kind) {\n            if (kind === void 0) { kind = \"info\"; }\n            return _this.appendDslLog(text, kind);\n        };\n        var setStatus = function (message, type) {\n            if (type === void 0) { type = \"neutral\"; }\n            return _this.setDslStatus(message, type);\n        };\n        var runCommand = function (command) {\n            if (!command) {\n                setStatus(\"Enter a DSL command to run.\", \"neutral\");\n                return false;\n            }\n            if (command.includes(\";\") || command.includes(\"\\n\")) {\n                var batch = _this.scriptEngine.executeScript(command, true);\n                if (batch.executed > 0) {\n                    _this.drawAll();\n                }\n                if (batch.success) {\n                    setStatus(batch.message, \"ok\");\n                    appendLog(batch.message, \"ok\");\n                    dslInput.classList.remove(\"is-invalid\");\n                    return true;\n                }\n                setStatus(batch.message, \"error\");\n                appendLog(batch.message, \"error\");\n                dslInput.classList.add(\"is-invalid\");\n                return false;\n            }\n            var result = _this.scriptEngine.execute(command);\n            if (result.success) {\n                _this.drawAll();\n                setStatus(\"Executed: \".concat(command), \"ok\");\n                appendLog(command, \"ok\");\n                dslInput.classList.remove(\"is-invalid\");\n                return true;\n            }\n            else {\n                setStatus(result.message, \"error\");\n                appendLog(\"Command failed: \".concat(command, \" (\").concat(result.message, \")\"), \"error\");\n                dslInput.classList.add(\"is-invalid\");\n                return false;\n            }\n        };\n        dslInput.addEventListener(\"keydown\", function (ev) {\n            ev.stopPropagation();\n            if (ev.key === \"Enter\") {\n                ev.preventDefault();\n                var command = dslInput.value.trim();\n                if (runCommand(command)) {\n                    dslInput.value = \"\";\n                }\n                return;\n            }\n            if (ev.key === \"Escape\") {\n                ev.preventDefault();\n                dslInput.blur();\n            }\n        });\n        dslInput.addEventListener(\"input\", function () {\n            dslInput.classList.remove(\"is-invalid\");\n            setStatus(\"\", \"neutral\");\n        });\n        dslRun === null || dslRun === void 0 ? void 0 : dslRun.addEventListener(\"click\", function () {\n            var command = dslInput.value.trim();\n            if (runCommand(command)) {\n                dslInput.value = \"\";\n            }\n            dslInput.focus();\n        });\n        dslClear === null || dslClear === void 0 ? void 0 : dslClear.addEventListener(\"click\", function () {\n            dslInput.value = \"\";\n            dslInput.classList.remove(\"is-invalid\");\n            setStatus(\"\", \"neutral\");\n            dslInput.focus();\n            appendLog(\"Command input cleared.\", \"info\");\n        });\n        dslInsertExample === null || dslInsertExample === void 0 ? void 0 : dslInsertExample.addEventListener(\"click\", function () {\n            if (!dslExampleSelect || !dslExampleSelect.value) {\n                setStatus(\"Select an example command first.\", \"neutral\");\n                return;\n            }\n            dslInput.value = dslExampleSelect.value;\n            dslInput.classList.remove(\"is-invalid\");\n            setStatus(\"Example inserted. Press Run or Enter.\", \"neutral\");\n            dslInput.focus();\n            dslInput.select();\n            appendLog(\"Example loaded: \".concat(dslExampleSelect.value), \"info\");\n        });\n        dslExampleSelect === null || dslExampleSelect === void 0 ? void 0 : dslExampleSelect.addEventListener(\"change\", function () {\n            if (!dslExampleSelect.value) {\n                return;\n            }\n            dslInput.value = dslExampleSelect.value;\n            dslInput.classList.remove(\"is-invalid\");\n            setStatus(\"Example loaded to input.\", \"neutral\");\n        });\n        dslBuildMacro === null || dslBuildMacro === void 0 ? void 0 : dslBuildMacro.addEventListener(\"click\", function () {\n            var _a, _b, _c;\n            var kind = (dslMacroKind === null || dslMacroKind === void 0 ? void 0 : dslMacroKind.value) || \"qed_se\";\n            var x = Number((_a = dslMacroX === null || dslMacroX === void 0 ? void 0 : dslMacroX.value) !== null && _a !== void 0 ? _a : \"10\");\n            var y = Number((_b = dslMacroY === null || dslMacroY === void 0 ? void 0 : dslMacroY.value) !== null && _b !== void 0 ? _b : \"15\");\n            var length = Number((_c = dslMacroLength === null || dslMacroLength === void 0 ? void 0 : dslMacroLength.value) !== null && _c !== void 0 ? _c : \"40\");\n            if (![x, y, length].every(function (value) { return Number.isFinite(value); })) {\n                setStatus(\"Macro parameters must be numeric.\", \"error\");\n                appendLog(\"Macro build failed: invalid numeric parameter.\", \"error\");\n                return;\n            }\n            var command = \"\".concat(kind, \" \").concat(x, \" \").concat(y, \" \").concat(length);\n            dslInput.value = command;\n            dslInput.classList.remove(\"is-invalid\");\n            setStatus(\"Macro command created in quick command box.\", \"ok\");\n            appendLog(\"Macro created: \".concat(command), \"info\");\n            dslInput.focus();\n            dslInput.select();\n        });\n        var focusScriptLine = function (line) {\n            var _a, _b;\n            if (!dslScript || line < 1) {\n                return;\n            }\n            var rows = dslScript.value.split(/\\r?\\n/);\n            var start = 0;\n            for (var index = 0; index < line - 1 && index < rows.length; index++) {\n                start += rows[index].length + 1;\n            }\n            var end = start + ((_b = (_a = rows[line - 1]) === null || _a === void 0 ? void 0 : _a.length) !== null && _b !== void 0 ? _b : 0);\n            dslScript.focus();\n            dslScript.setSelectionRange(start, end);\n        };\n        var runScript = function () {\n            if (!dslScript) {\n                return;\n            }\n            if (_this.selectionMacroEditMode) {\n                var applied = _this.applySelectionMacroScript(dslScript.value);\n                if (applied) {\n                    setStatus(\"Selection replaced from macro.\", \"ok\");\n                    appendLog(\"Selection macro applied.\", \"ok\");\n                }\n                return;\n            }\n            var batch = _this.scriptEngine.executeScript(dslScript.value, true);\n            if (batch.total === 0) {\n                setStatus(batch.message, \"neutral\");\n                appendLog(batch.message, \"info\");\n                return;\n            }\n            if (batch.executed > 0) {\n                _this.drawAll();\n            }\n            if (batch.success) {\n                setStatus(batch.message, \"ok\");\n                appendLog(batch.message, \"ok\");\n            }\n            else {\n                setStatus(batch.message, \"error\");\n                appendLog(batch.message, \"error\");\n                if (batch.failedLine) {\n                    focusScriptLine(batch.failedLine);\n                }\n            }\n        };\n        dslRunScript === null || dslRunScript === void 0 ? void 0 : dslRunScript.addEventListener(\"click\", function () {\n            runScript();\n        });\n        dslScript === null || dslScript === void 0 ? void 0 : dslScript.addEventListener(\"keydown\", function (ev) {\n            ev.stopPropagation();\n            var isMeta = ev.ctrlKey || ev.metaKey;\n            if (isMeta && ev.key === \"Enter\") {\n                ev.preventDefault();\n                runScript();\n            }\n        });\n        dslCopyScript === null || dslCopyScript === void 0 ? void 0 : dslCopyScript.addEventListener(\"click\", function () {\n            if (!dslScript) {\n                return;\n            }\n            var text = dslScript.value;\n            if (!text.trim()) {\n                setStatus(\"Script editor is empty.\", \"neutral\");\n                return;\n            }\n            if (navigator.clipboard && navigator.clipboard.writeText) {\n                navigator.clipboard.writeText(text).then(function () {\n                    setStatus(\"Script copied to clipboard.\", \"ok\");\n                    appendLog(\"Script copied to clipboard.\", \"info\");\n                }).catch(function () {\n                    dslScript.focus();\n                    dslScript.select();\n                    setStatus(\"Clipboard API unavailable. Selected script text instead.\", \"neutral\");\n                    appendLog(\"Clipboard API unavailable; selected script text.\", \"info\");\n                });\n            }\n            else {\n                dslScript.focus();\n                dslScript.select();\n                setStatus(\"Clipboard API unavailable. Selected script text instead.\", \"neutral\");\n                appendLog(\"Clipboard API unavailable; selected script text.\", \"info\");\n            }\n        });\n        document.addEventListener(\"keydown\", function (ev) {\n            if (ev.key !== \"/\") {\n                return;\n            }\n            if (ev.metaKey || ev.ctrlKey || ev.altKey || ev.shiftKey) {\n                return;\n            }\n            var target = ev.target;\n            if (target === dslInput) {\n                return;\n            }\n            if (target && (target.tagName === \"INPUT\" || target.tagName === \"TEXTAREA\" || target.isContentEditable)) {\n                return;\n            }\n            ev.preventDefault();\n            dslInput.focus();\n            dslInput.select();\n            setStatus(\"DSL input focused.\", \"neutral\");\n        });\n    };\n    /**\n     * Registers the default set of UI commands. Having a dedicated registry\n      * keeps the mapping between command identifiers and their behaviour in one\n     * place, which makes it much simpler to add, remove, or reuse commands in\n     * other UI surfaces (shortcut keys, palette, context menu, etc.).\n     */\n    RDDraw.prototype.registerCommands = function () {\n        var registry = this.commandRegistry;\n        registry.register({\n            id: \"select-here\",\n            description: \"Select the element closest to the pointer location\",\n            requiresPointer: true,\n            execute: function (_a) {\n                var host = _a.host, pointer = _a.pointer;\n                return host.selectAt(pointer, false);\n            },\n        });\n        registry.register({\n            id: \"sub-select-here\",\n            description: \"Set the sub-selection using the pointer location\",\n            requiresPointer: true,\n            execute: function (_a) {\n                var host = _a.host, pointer = _a.pointer;\n                return host.selectAt(pointer, true);\n            },\n        });\n        registry.register({\n            id: \"mode-normal\",\n            description: \"Switch to selection mode\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.setDrawMode(\"normal\");\n            },\n        });\n        registry.register({\n            id: \"mode-line\",\n            description: \"Switch to propagator drawing mode\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.setDrawMode(\"line\");\n            },\n        });\n        registry.register({\n            id: \"mode-loop\",\n            description: \"Switch to loop drawing mode\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.setDrawMode(\"loop\");\n            },\n        });\n        registry.register({\n            id: \"mode-point\",\n            description: \"Switch to vertex drawing mode\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.setDrawMode(\"point\");\n            },\n        });\n        registry.register({\n            id: \"mode-string\",\n            description: \"Switch to text placement mode\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.setDrawMode(\"string\");\n            },\n        });\n        registry.register({\n            id: \"add-vertex\",\n            description: \"Place a vertex at the pointer position\",\n            requiresPointer: true,\n            execute: function (_a) {\n                var host = _a.host, pointer = _a.pointer;\n                return host.insertVertex(pointer);\n            },\n        });\n        registry.register({\n            id: \"add-loop\",\n            description: \"Create a loop centred at the pointer position\",\n            requiresPointer: true,\n            execute: function (_a) {\n                var host = _a.host, pointer = _a.pointer;\n                return host.putLoop(pointer.x, pointer.y);\n            },\n        });\n        registry.register({\n            id: \"add-line-from-pointer\",\n            description: \"Create a propagator ending at the pointer position\",\n            requiresPointer: true,\n            execute: function (_a) {\n                var host = _a.host, pointer = _a.pointer;\n                return host.advanceLineTool(pointer);\n            },\n        });\n        registry.register({\n            id: \"add-text\",\n            description: \"Insert a text label at the pointer position\",\n            requiresPointer: true,\n            execute: function (_a) {\n                var host = _a.host, pointer = _a.pointer;\n                return host.setString(pointer.x, pointer.y);\n            },\n        });\n        registry.register({\n            id: \"fill\",\n            description: \"Fill the currently selected loop\",\n            requiresPointer: true,\n            execute: function (_a) {\n                var host = _a.host, pointer = _a.pointer;\n                return host.fill(pointer.x, pointer.y);\n            },\n        });\n        registry.register({\n            id: \"toggle-arrow\",\n            description: \"Toggle arrow direction on the selected propagator\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.allowToggle();\n            },\n        });\n        registry.register({\n            id: \"arrow-rotate-left\",\n            description: \"Rotate the propagator arrow counter-clockwise\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.rotateArrow(-Math.PI / 12);\n            },\n        });\n        registry.register({\n            id: \"arrow-rotate-right\",\n            description: \"Rotate the propagator arrow clockwise\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.rotateArrow(Math.PI / 12);\n            },\n        });\n        registry.register({\n            id: \"arrow-reset\",\n            description: \"Reset the propagator arrow rotation\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.resetArrowRotation();\n            },\n        });\n        registry.register({\n            id: \"change-type\",\n            description: \"Cycle the selected propagator's particle type\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.changeType();\n            },\n        });\n        registry.register({\n            id: \"change-style\",\n            description: \"Cycle the selected propagator's visual style\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.changeStyle();\n            },\n        });\n        registry.register({\n            id: \"delete\",\n            description: \"Delete the currently selected element\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.delete();\n            },\n        });\n        registry.register({\n            id: \"select-all\",\n            description: \"Select all elements on the canvas\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.selectAll();\n            },\n        });\n        registry.register({\n            id: \"copy-selection\",\n            description: \"Copy selected elements\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.copySelection();\n            },\n        });\n        registry.register({\n            id: \"cut-selection\",\n            description: \"Cut selected elements\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.cutSelection();\n            },\n        });\n        registry.register({\n            id: \"paste-selection\",\n            description: \"Paste copied elements\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.pasteSelection();\n            },\n        });\n        registry.register({\n            id: \"group-selection\",\n            description: \"Group selected elements\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.groupSelection();\n            },\n        });\n        registry.register({\n            id: \"ungroup-selection\",\n            description: \"Ungroup selected group element\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.ungroupSelection();\n            },\n        });\n        registry.register({\n            id: \"edit-selection-macro\",\n            description: \"Export the selection to editable DSL macro text\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.openSelectionMacroEditor();\n            },\n        });\n        registry.register({\n            id: \"undo\",\n            description: \"Undo the last change\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.undo();\n            },\n        });\n        registry.register({\n            id: \"redo\",\n            description: \"Redo the previously undone change\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.redo();\n            },\n        });\n        registry.register({\n            id: \"rotation\",\n            description: \"Rotate the selection clockwise\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.rotation();\n            },\n        });\n        registry.register({\n            id: \"anti-rotation\",\n            description: \"Rotate the selection counter-clockwise\",\n            execute: function (_a) {\n                var host = _a.host;\n                return host.antiRotation();\n            },\n        });\n    };\n    /**\n     * Registers click handlers for every `data-command` element. Any new button\n     * or menu entry simply needs the attribute and will automatically route\n     * through the command registry.\n     */\n    RDDraw.prototype.initializeCommandTriggers = function () {\n        var _this = this;\n        var triggers = document.querySelectorAll(\"[data-command]\");\n        triggers.forEach(function (trigger) {\n            trigger.addEventListener(\"click\", function (ev) {\n                ev.preventDefault();\n                ev.stopPropagation();\n                var element = ev.currentTarget;\n                var command = element.dataset.command;\n                if (!command) {\n                    return;\n                }\n                _this.handleCommand(command);\n            });\n        });\n    };\n    /**\n     * Runs a command from UI surfaces. Centralising the clutch of ancillary\n     * work (closing menus, logging, pointer handling) keeps the event handlers\n     * trivial and consistent.\n     */\n    RDDraw.prototype.handleCommand = function (commandId) {\n        var executed = this.runCommand(commandId);\n        if (executed) {\n            this.hideContextMenu();\n        }\n    };\n    RDDraw.prototype.runCommand = function (commandId) {\n        try {\n            return this.commandRegistry.execute(commandId, this, this.getPointer());\n        }\n        catch (error) {\n            (0,_looger__WEBPACK_IMPORTED_MODULE_7__.loggerVer)(\"command '\".concat(commandId, \"' failed: \").concat(error));\n            return false;\n        }\n    };\n    RDDraw.prototype.selectAt = function (point, additive) {\n        var _a;\n        this.resetLoopPreview();\n        var currentId = (_a = this.repository.currentElement()) === null || _a === void 0 ? void 0 : _a.id;\n        var hit = this.repository.findElement(point, currentId, this.worldTolerance(12));\n        if (!hit) {\n            if (!additive) {\n                this.repository.clearSelectMode();\n                this.drawAll();\n            }\n            return;\n        }\n        if (additive) {\n            this.repository.toggleSelection(hit);\n        }\n        else {\n            this.repository.setCurrentElement(hit);\n        }\n        this.drawAll();\n    };\n    RDDraw.prototype.performMoveDrag = function (pointer) {\n        if (!this.dragSession || this.dragSession.type !== \"move\") {\n            return;\n        }\n        var deltaStep = pointer.minus(this.dragSession.lastPointer);\n        if (deltaStep.x === 0 && deltaStep.y === 0) {\n            return;\n        }\n        this.dragSession.lastPointer = pointer;\n        this.dragSession.totalDelta = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(this.dragSession.totalDelta.x + deltaStep.x, this.dragSession.totalDelta.y + deltaStep.y);\n        this.dragSession.elements.forEach(function (elem) {\n            elem.move(deltaStep);\n        });\n        this.drawAll();\n    };\n    RDDraw.prototype.performHandleDrag = function (pointer) {\n        if (!this.dragSession || this.dragSession.type !== \"handle\") {\n            return;\n        }\n        var session = this.dragSession;\n        var line = session.line;\n        var initial = session.initial;\n        this.dragSession.lastPointer = pointer;\n        if (session.handle === \"origin\") {\n            if (session.detachMode) {\n                line.origin = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(pointer.x, pointer.y);\n            }\n            else {\n                line.origin.moveAbsolute(pointer);\n            }\n            if (initial.control) {\n                var delta = pointer.minus(initial.origin);\n                var newControl = initial.control.add(delta);\n                if (!line.control) {\n                    line.control = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(newControl.x, newControl.y);\n                }\n                else {\n                    line.control.moveAbsolute(newControl);\n                }\n            }\n        }\n        else if (session.handle === \"to\") {\n            if (session.detachMode) {\n                line.to = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(pointer.x, pointer.y);\n            }\n            else {\n                line.to.moveAbsolute(pointer);\n            }\n            if (initial.control) {\n                var delta = pointer.minus(initial.to);\n                var newControl = initial.control.add(delta);\n                if (!line.control) {\n                    line.control = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(newControl.x, newControl.y);\n                }\n                else {\n                    line.control.moveAbsolute(newControl);\n                }\n            }\n        }\n        else {\n            if (!line.control) {\n                line.control = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(pointer.x, pointer.y);\n            }\n            else {\n                line.control.moveAbsolute(pointer);\n            }\n        }\n        this.drawAll();\n    };\n    RDDraw.prototype.insertVertex = function (point) {\n        var vertex = this.ensureVertex(point);\n        this.repository.setCurrentElement(vertex);\n        this.setDrawMode(\"normal\");\n        return vertex;\n    };\n    RDDraw.prototype.ensureVertex = function (point) {\n        var tolerance = this.worldTolerance(10);\n        var existing = this.findNearestVertex(point, tolerance);\n        if (existing) {\n            this.repository.setCurrentElement(existing);\n            return existing;\n        }\n        var vertex = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(point.x, point.y);\n        this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetVertex(vertex));\n        var created = this.repository.currentElement();\n        if (created && (0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(created)) {\n            return created;\n        }\n        return vertex;\n    };\n    RDDraw.prototype.findNearestVertex = function (point, tolerance) {\n        var nearest = undefined;\n        var minDistance = Number.POSITIVE_INFINITY;\n        var vertices = this.repository.getAllVertex();\n        vertices.forEach(function (vertex) {\n            var distance = vertex.formalDistance(point);\n            if (distance < minDistance) {\n                minDistance = distance;\n                nearest = vertex;\n            }\n        });\n        if (nearest && minDistance <= tolerance) {\n            return nearest;\n        }\n        return undefined;\n    };\n    RDDraw.prototype.findNearestLine = function (point, tolerance) {\n        var nearest = undefined;\n        var minDistance = Number.POSITIVE_INFINITY;\n        var lines = this.repository.getAllLine();\n        lines.forEach(function (line) {\n            var distance = line.formalDistance(point);\n            if (distance < minDistance) {\n                minDistance = distance;\n                nearest = line;\n            }\n        });\n        if (nearest && minDistance <= tolerance) {\n            return nearest;\n        }\n        return undefined;\n    };\n    RDDraw.prototype.advanceLineTool = function (point) {\n        if (this.drawMode !== \"line\") {\n            this.drawMode = \"line\";\n        }\n        var startPoint = this.resolveLinePoint(point);\n        if (!this.lineDraftStart) {\n            this.lineDraftStart = startPoint;\n            this.linePreviewEnd = startPoint.copy();\n            this.repository.setCurrentElement(startPoint);\n            this.drawAll();\n            return;\n        }\n        var endPoint = this.resolveLinePoint(point);\n        if (startPoint === this.lineDraftStart && endPoint === this.lineDraftStart) {\n            this.lineDraftStart = undefined;\n            this.drawAll();\n            return;\n        }\n        var line = new _Core_Line__WEBPACK_IMPORTED_MODULE_1__.Line();\n        line.origin = this.lineDraftStart;\n        line.to = endPoint;\n        this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLine(line));\n        this.lineDraftStart = undefined;\n        this.linePreviewEnd = undefined;\n        this.repository.clearSelectMode();\n        this.setDrawMode(\"normal\");\n    };\n    RDDraw.prototype.resolveLinePoint = function (point) {\n        var tolerance = this.worldTolerance(10);\n        var existingVertex = this.findNearestVertex(point, tolerance);\n        if (existingVertex) {\n            return existingVertex;\n        }\n        var existingLine = this.findNearestLine(point, tolerance * 1.6);\n        if (existingLine) {\n            var projected = existingLine.closestPoint(point);\n            var snap = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(projected.x, projected.y);\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetVertex(snap));\n            return this.repository.currentElement();\n        }\n        var snapPoint = this.snapToGrid(point);\n        this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetVertex(snapPoint));\n        return this.repository.currentElement();\n    };\n    RDDraw.prototype.resolveLineHoverPoint = function (point) {\n        var tolerance = this.worldTolerance(12);\n        var existingVertex = this.findNearestVertex(point, tolerance);\n        if (existingVertex) {\n            return existingVertex.copy();\n        }\n        return this.snapToGrid(point);\n    };\n    RDDraw.prototype.snapToGrid = function (point) {\n        var grid = 0.5;\n        var snapped = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(Math.round(point.x / grid) * grid, Math.round(point.y / grid) * grid);\n        return snapped;\n    };\n    RDDraw.prototype.handleLoopTool = function (point) {\n        var current = this.repository.currentElement();\n        if (!current) {\n            this.putLoop(point.x, point.y);\n            this.setDrawMode(\"normal\");\n            return;\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(current)) {\n            var loop = new _Core_Loop__WEBPACK_IMPORTED_MODULE_2__.Loop();\n            loop.origin = point;\n            current.addLoop(loop);\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLoop(loop));\n            this.setDrawMode(\"normal\");\n            return;\n        }\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(current)) {\n            var loop = new _Core_Loop__WEBPACK_IMPORTED_MODULE_2__.Loop();\n            loop.origin = current.to.add(current.directionUnit().multi(loop.radius * 2));\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLoop(loop));\n            this.setDrawMode(\"normal\");\n            return;\n        }\n        if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(current)) {\n            var loop = new _Core_Loop__WEBPACK_IMPORTED_MODULE_2__.Loop();\n            loop.origin = current;\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLoop(loop));\n            this.setDrawMode(\"normal\");\n            return;\n        }\n        this.putLoop(point.x, point.y);\n        this.setDrawMode(\"normal\");\n    };\n    RDDraw.prototype.cancelLineDraft = function () {\n        if (!this.lineDraftStart) {\n            return;\n        }\n        this.lineDraftStart = undefined;\n        this.linePreviewEnd = undefined;\n        this.drawAll();\n    };\n    /**\n     * Wires up the custom context menu so right-click behaves consistently with\n     * the command palette. The menu is lightweight and hides whenever the user\n     * clicks elsewhere or the viewport changes.\n     */\n    RDDraw.prototype.setupContextMenu = function () {\n        var _this = this;\n        this.contextMenuElement = document.getElementById(\"canvas-context-menu\");\n        if (!this.contextMenuElement) {\n            return;\n        }\n        this.canvas.addEventListener(\"contextmenu\", function (ev) {\n            var _a;\n            ev.preventDefault();\n            _this.setPrevXY(ev.offsetX, ev.offsetY);\n            var point = _this.getPointer();\n            var hit = _this.repository.findElement(point, (_a = _this.repository.currentElement()) === null || _a === void 0 ? void 0 : _a.id, _this.worldTolerance(12));\n            if (hit && !_this.repository.isSelected(hit)) {\n                _this.repository.setCurrentElement(hit);\n                _this.drawAll();\n            }\n            _this.updateContextMenuBySelection();\n            _this.showContextMenu(ev.clientX, ev.clientY);\n        });\n        document.addEventListener(\"click\", function (ev) {\n            if (!_this.contextMenuElement) {\n                return;\n            }\n            if (_this.contextMenuElement.contains(ev.target)) {\n                return;\n            }\n            _this.hideContextMenu();\n        });\n        document.addEventListener(\"keydown\", function (ev) {\n            if (ev.key === \"Escape\") {\n                _this.hideContextMenu();\n            }\n        });\n        window.addEventListener(\"resize\", function () {\n            _this.hideContextMenu();\n        });\n        window.addEventListener(\"scroll\", function () {\n            _this.hideContextMenu();\n        });\n    };\n    RDDraw.prototype.setupLoopControls = function () {\n        var _this = this;\n        var _a, _b;\n        this.loopControls.container = document.getElementById(\"loop-controls\");\n        this.loopControls.radiusSlider = document.getElementById(\"loop-radius\");\n        this.loopControls.startSlider = document.getElementById(\"loop-gap-start\");\n        this.loopControls.endSlider = document.getElementById(\"loop-gap-end\");\n        this.loopControls.radiusValue = document.getElementById(\"loop-radius-value\");\n        this.loopControls.startValue = document.getElementById(\"loop-start-value\");\n        this.loopControls.endValue = document.getElementById(\"loop-end-value\");\n        this.loopControls.arcValue = document.getElementById(\"loop-arc-value\");\n        this.loopControls.gapValue = document.getElementById(\"loop-gap-value\");\n        var radiusSlider = this.loopControls.radiusSlider;\n        if (radiusSlider) {\n            radiusSlider.addEventListener(\"input\", function (ev) {\n                var value = Number(ev.target.value);\n                _this.previewLoopRadius(value);\n            });\n            radiusSlider.addEventListener(\"change\", function (ev) {\n                var value = Number(ev.target.value);\n                _this.commitLoopRadius(value);\n            });\n        }\n        var startSlider = this.loopControls.startSlider;\n        if (startSlider) {\n            startSlider.addEventListener(\"input\", function (ev) {\n                var value = Number(ev.target.value);\n                _this.previewLoopStart(value);\n            });\n            startSlider.addEventListener(\"change\", function (ev) {\n                var value = Number(ev.target.value);\n                _this.commitLoopStart(value);\n            });\n        }\n        var endSlider = this.loopControls.endSlider;\n        if (endSlider) {\n            endSlider.addEventListener(\"input\", function (ev) {\n                var value = Number(ev.target.value);\n                _this.previewLoopEnd(value);\n            });\n            endSlider.addEventListener(\"change\", function (ev) {\n                var value = Number(ev.target.value);\n                _this.commitLoopEnd(value);\n            });\n        }\n        (_a = this.loopControls.container) === null || _a === void 0 ? void 0 : _a.querySelectorAll(\"[data-loop-step]\").forEach(function (button) {\n            button.addEventListener(\"click\", function () {\n                var _a;\n                var property = button.dataset.loopStep;\n                var step = Number((_a = button.dataset.step) !== null && _a !== void 0 ? _a : \"0\");\n                if (!property || Number.isNaN(step)) {\n                    return;\n                }\n                _this.adjustLoop(property, step);\n            });\n        });\n        (_b = this.loopControls.container) === null || _b === void 0 ? void 0 : _b.querySelectorAll(\"[data-loop-action]\").forEach(function (button) {\n            button.addEventListener(\"click\", function () {\n                var action = button.dataset.loopAction;\n                if (!action) {\n                    return;\n                }\n                _this.handleLoopAction(action);\n            });\n        });\n    };\n    RDDraw.prototype.showContextMenu = function (clientX, clientY) {\n        if (!this.contextMenuElement) {\n            return;\n        }\n        var menu = this.contextMenuElement;\n        menu.style.visibility = \"hidden\";\n        menu.style.display = \"block\";\n        var menuWidth = menu.offsetWidth;\n        var menuHeight = menu.offsetHeight;\n        var viewportWidth = window.innerWidth;\n        var viewportHeight = window.innerHeight;\n        var left = Math.min(clientX, viewportWidth - menuWidth - 8);\n        var top = Math.min(clientY, viewportHeight - menuHeight - 8);\n        menu.style.left = \"\".concat(Math.max(0, left), \"px\");\n        menu.style.top = \"\".concat(Math.max(0, top), \"px\");\n        menu.style.visibility = \"visible\";\n    };\n    RDDraw.prototype.updateContextMenuBySelection = function () {\n        if (!this.contextMenuElement) {\n            return;\n        }\n        var hasSelection = this.repository.getSelectedElements().length > 0;\n        this.contextMenuElement\n            .querySelectorAll(\"[data-selection-required]\")\n            .forEach(function (element) {\n            var requireSelection = element.dataset.selectionRequired === \"true\";\n            if (requireSelection && !hasSelection) {\n                element.classList.add(\"d-none\");\n            }\n            else {\n                element.classList.remove(\"d-none\");\n            }\n        });\n    };\n    RDDraw.prototype.hideContextMenu = function () {\n        if (!this.contextMenuElement) {\n            return;\n        }\n        this.contextMenuElement.style.display = \"none\";\n        this.contextMenuElement.style.visibility = \"hidden\";\n    };\n    /**\n     * Sets the active drawing mode and refreshes the UI. This wrapper is used by\n     * both keyboard shortcuts and command buttons to ensure we always reset line\n     * staging state and highlight the currently active tool.\n     */\n    RDDraw.prototype.setDrawMode = function (mode) {\n        this.resetLoopPreview();\n        this.drawMode = mode;\n        if (mode !== \"line\") {\n            this.lineDraftStart = undefined;\n            this.linePreviewEnd = undefined;\n        }\n        this.drawAll();\n    };\n    /**\n     * Keeps the button panel in sync with the active draw mode. Using a helper\n     * avoids sprinkling DOM-manipulation logic around the codebase.\n     */\n    RDDraw.prototype.updateModeButtons = function () {\n        var _this = this;\n        var modeButtons = document.querySelectorAll(\"[data-mode]\");\n        modeButtons.forEach(function (button) {\n            var buttonMode = button.dataset.mode;\n            if (!buttonMode) {\n                return;\n            }\n            if (buttonMode === _this.drawMode) {\n                button.classList.add(\"active\");\n                button.setAttribute(\"aria-pressed\", \"true\");\n            }\n            else {\n                button.classList.remove(\"active\");\n                button.setAttribute(\"aria-pressed\", \"false\");\n            }\n        });\n    };\n    /**\n     * Helper for comparing vectors when the pointer interaction introduces minor\n     * floating point noise. Keeps handle drags from enqueuing no-op commands.\n     */\n    RDDraw.prototype.vectorsAlmostEqual = function (a, b, epsilon) {\n        if (epsilon === void 0) { epsilon = 1e-6; }\n        if (!a && !b) {\n            return true;\n        }\n        if (!a || !b) {\n            return false;\n        }\n        return Math.abs(a.x - b.x) < epsilon && Math.abs(a.y - b.y) < epsilon;\n    };\n    RDDraw.prototype.hitTestLineHandle = function (point) {\n        var candidates = [];\n        var current = this.repository.currentElement();\n        if (current && (0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(current)) {\n            candidates.push(current);\n        }\n        this.repository.getSelectedElements().forEach(function (elem) {\n            if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(elem) && !candidates.includes(elem)) {\n                candidates.push(elem);\n            }\n        });\n        if (candidates.length === 0) {\n            return null;\n        }\n        var tolerance = this.worldTolerance(10);\n        var bestMatch = null;\n        var bestDistance = Number.POSITIVE_INFINITY;\n        candidates.forEach(function (line) {\n            var handleSpecs = [\n                { handle: \"origin\", position: line.origin, createControl: false },\n                { handle: \"to\", position: line.to, createControl: false },\n            ];\n            if (line.control) {\n                handleSpecs.push({ handle: \"control\", position: line.control, createControl: false });\n            }\n            else {\n                handleSpecs.push({ handle: \"control\", position: line.pointAt(0.5), createControl: true });\n            }\n            handleSpecs.forEach(function (spec) {\n                var distance = point.minus(spec.position).length();\n                if (distance < tolerance && distance < bestDistance) {\n                    bestMatch = { line: line, handle: spec.handle, position: spec.position, createControl: spec.createControl };\n                    bestDistance = distance;\n                }\n            });\n        });\n        return bestMatch;\n    };\n    RDDraw.prototype.activeLoop = function () {\n        var current = this.repository.currentElement();\n        if (current && (0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(current)) {\n            return current;\n        }\n        var selectedLoop = this.repository\n            .getSelectedElements()\n            .find(function (elem) { return (0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(elem); });\n        return selectedLoop;\n    };\n    RDDraw.prototype.loopRadiusHandlePoint = function (loop) {\n        return new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(loop.origin.x + loop.radius, loop.origin.y);\n    };\n    RDDraw.prototype.hitTestLoopHandle = function (point) {\n        var loop = this.activeLoop();\n        if (!loop) {\n            return null;\n        }\n        var handlePoint = this.loopRadiusHandlePoint(loop);\n        var distance = point.minus(handlePoint).length();\n        if (distance <= this.worldTolerance(10)) {\n            return { loop: loop, handle: \"radius\" };\n        }\n        return null;\n    };\n    RDDraw.prototype.drawLineHandles = function (lines) {\n        if (lines.length === 0) {\n            return;\n        }\n        var ctx = this.context;\n        var scale = _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale;\n        var offset = this.drawContext.getViewOffset();\n        var baseRadius = Math.max(4, Math.min(6, scale * 0.35));\n        lines.forEach(function (line) {\n            var controlPoint = line.control ? line.control : line.pointAt(0.5);\n            var hasControl = !!line.control;\n            ctx.save();\n            ctx.strokeStyle = \"rgba(30, 144, 255, 0.6)\";\n            ctx.lineWidth = 1;\n            ctx.setLineDash(hasControl ? [4, 4] : [6, 6]);\n            ctx.beginPath();\n            ctx.moveTo((line.origin.x + offset.x) * scale, (line.origin.y + offset.y) * scale);\n            ctx.lineTo((controlPoint.x + offset.x) * scale, (controlPoint.y + offset.y) * scale);\n            ctx.lineTo((line.to.x + offset.x) * scale, (line.to.y + offset.y) * scale);\n            ctx.stroke();\n            ctx.restore();\n            var handles = [\n                { point: line.origin, ghost: false },\n                { point: line.to, ghost: false },\n                { point: controlPoint, ghost: !hasControl },\n            ];\n            handles.forEach(function (handle) {\n                ctx.save();\n                var px = (handle.point.x + offset.x) * scale;\n                var py = (handle.point.y + offset.y) * scale;\n                var radius = handle.ghost ? baseRadius + 2 : baseRadius;\n                ctx.beginPath();\n                ctx.arc(px, py, radius, 0, Math.PI * 2);\n                if (handle.ghost) {\n                    ctx.fillStyle = \"rgba(30, 144, 255, 0.15)\";\n                    ctx.strokeStyle = \"rgba(30, 144, 255, 0.9)\";\n                    ctx.lineWidth = 1.5;\n                    ctx.fill();\n                }\n                else {\n                    ctx.fillStyle = \"rgba(30, 144, 255, 0.9)\";\n                    ctx.strokeStyle = \"white\";\n                    ctx.lineWidth = 1.5;\n                    ctx.fill();\n                }\n                ctx.stroke();\n                ctx.restore();\n            });\n        });\n    };\n    RDDraw.prototype.drawLoopHandles = function (loop) {\n        if (!loop) {\n            return;\n        }\n        var ctx = this.context;\n        var scale = _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale;\n        var offset = this.drawContext.getViewOffset();\n        var point = this.loopRadiusHandlePoint(loop);\n        var px = (point.x + offset.x) * scale;\n        var py = (point.y + offset.y) * scale;\n        ctx.save();\n        ctx.beginPath();\n        ctx.arc(px, py, 6, 0, Math.PI * 2);\n        ctx.fillStyle = \"rgba(220, 53, 69, 0.85)\";\n        ctx.strokeStyle = \"white\";\n        ctx.lineWidth = 1.5;\n        ctx.fill();\n        ctx.stroke();\n        ctx.restore();\n    };\n    RDDraw.prototype.setPrevXY = function (eventX, eventY) {\n        this.rawPointer = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(eventX, eventY);\n        // loggerVer(`rawPointer ${this.rawPointer.x}  ${this.rawPointer.y}`);\n    };\n    RDDraw.prototype.worldTolerance = function (px) {\n        if (px === void 0) { px = 10; }\n        return px / Math.max(_Config__WEBPACK_IMPORTED_MODULE_0__.config.scale, 0.0001);\n    };\n    RDDraw.prototype.resizeCanvasToViewport = function () {\n        var parent = this.canvas.parentElement;\n        if (!parent) {\n            return;\n        }\n        var rect = parent.getBoundingClientRect();\n        var width = Math.max(320, Math.floor(rect.width));\n        var height = Math.max(240, Math.floor(rect.height));\n        if (this.canvas.width !== width || this.canvas.height !== height) {\n            this.canvas.width = width;\n            this.canvas.height = height;\n            this.drawAll();\n        }\n    };\n    RDDraw.prototype.onCanvasWheel = function (ev) {\n        ev.preventDefault();\n        var before = this.getPointerPrecise();\n        var factor = ev.deltaY < 0 ? 1.08 : 1 / 1.08;\n        var nextScale = Math.max(4, Math.min(80, _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale * factor));\n        if (Math.abs(nextScale - _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale) < 1e-6) {\n            return;\n        }\n        _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale = nextScale;\n        var after = this.getPointerPrecise();\n        var delta = before.minus(after);\n        var offset = this.drawContext.getViewOffset();\n        this.drawContext.setViewOffset(offset.add(delta));\n        this.drawAll();\n    };\n    /**\n     * Returns the last pointer position in canvas coordinates. Centralises\n     * scaling logic so every command receives consistent values regardless of\n     * the current zoom level.\n     */\n    RDDraw.prototype.getPointer = function () {\n        var scale = _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale;\n        var offset = this.drawContext.getViewOffset();\n        var p = this.rawPointer.multi(1 / scale).minus(offset).floor();\n        // loggerVer(`p ${p.x}  ${p.y}`);\n        return p;\n    };\n    RDDraw.prototype.getPointerPrecise = function () {\n        var scale = _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale;\n        var offset = this.drawContext.getViewOffset();\n        return this.rawPointer.multi(1 / scale).minus(offset);\n    };\n    RDDraw.prototype.handleCanvasClick = function (point, ev) {\n        this.resetLoopPreview();\n        switch (this.drawMode) {\n            case \"normal\":\n                this.selectAt(point, ev.shiftKey || ev.metaKey || ev.ctrlKey);\n                break;\n            case \"point\":\n                this.insertVertex(point);\n                break;\n            case \"line\":\n                this.advanceLineTool(point);\n                break;\n            case \"loop\":\n                this.handleLoopTool(point);\n                break;\n            case \"string\":\n                this.setString(point.x, point.y);\n                break;\n        }\n    };\n    RDDraw.prototype.onCanvasDoubleClick = function (ev) {\n        this.resetLoopPreview();\n        this.interactionState = { type: \"idle\" };\n        this.dragSession = undefined;\n        this.selectionRect = undefined;\n        this.setPrevXY(ev.offsetX, ev.offsetY);\n        var point = this.getPointer();\n        var precisePoint = this.getPointerPrecise();\n        if (this.drawMode === \"normal\") {\n            var handleHit = this.hitTestLineHandle(precisePoint);\n            if (handleHit && handleHit.handle === \"control\" && handleHit.createControl) {\n                var controlPoint = handleHit.position.copy();\n                this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLineControlPoint(handleHit.line, controlPoint));\n                this.repository.setCurrentElement(handleHit.line);\n                this.drawAll();\n                return;\n            }\n        }\n        if (this.drawMode !== \"normal\") {\n            this.setDrawMode(\"normal\");\n        }\n        var additive = ev.shiftKey || ev.metaKey || ev.ctrlKey;\n        var tolerance = this.worldTolerance(12);\n        var candidates = this.repository.findAllNear(point, tolerance);\n        if (candidates.length === 0) {\n            return;\n        }\n        var lastContext = this.lastHitContext;\n        var nextIndex = 0;\n        if (lastContext &&\n            Math.abs(lastContext.point.x - point.x) < 1e-6 &&\n            Math.abs(lastContext.point.y - point.y) < 1e-6 &&\n            lastContext.tolerance === tolerance) {\n            var current_1 = this.repository.currentElement();\n            var currentIndex = current_1\n                ? candidates.findIndex(function (elem) { return elem.id === current_1.id; })\n                : -1;\n            nextIndex = currentIndex >= 0 ? (currentIndex + 1) % candidates.length : 0;\n        }\n        var hit = candidates[nextIndex];\n        if (additive) {\n            this.repository.toggleSelection(hit);\n        }\n        else {\n            this.repository.setCurrentElement(hit);\n        }\n        this.lastHitContext = { point: point.copy(), tolerance: tolerance };\n        this.drawAll();\n    };\n    RDDraw.prototype.dragThresholdCanvas = function () {\n        return 3 / Math.max(_Config__WEBPACK_IMPORTED_MODULE_0__.config.scale, 0.0001);\n    };\n    RDDraw.prototype.beginPotentialInteraction = function (point, ev) {\n        var _a;\n        if (this.drawMode !== \"normal\") {\n            this.interactionState = {\n                type: \"potentialClick\",\n                startPointer: point,\n                hit: undefined,\n                additive: ev.shiftKey || ev.metaKey || ev.ctrlKey,\n                forceRect: false,\n            };\n            return;\n        }\n        var additive = ev.shiftKey || ev.metaKey || ev.ctrlKey;\n        var forceRect = ev.altKey;\n        var hit = this.repository.findElement(point, (_a = this.repository.currentElement()) === null || _a === void 0 ? void 0 : _a.id, this.worldTolerance(12));\n        if (hit && !this.repository.isSelected(hit)) {\n            if (additive) {\n                this.repository.toggleSelection(hit);\n            }\n            else {\n                this.repository.setCurrentElement(hit);\n            }\n            this.drawAll();\n        }\n        else if (!hit && !additive) {\n            this.repository.clearSelectMode();\n            this.drawAll();\n        }\n        this.interactionState = {\n            type: \"potentialClick\",\n            startPointer: point,\n            hit: hit,\n            additive: additive,\n            forceRect: forceRect,\n        };\n    };\n    RDDraw.prototype.mouseDown = function (ev) {\n        this.setPrevXY(ev.offsetX, ev.offsetY);\n        var point = this.getPointer();\n        var precisePoint = this.getPointerPrecise();\n        this.interactionState = { type: \"idle\" };\n        this.selectionRect = undefined;\n        if (this.spacePanActive || ev.button === 1) {\n            this.panDragLast = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(ev.offsetX, ev.offsetY);\n            this.interactionState = { type: \"dragging\" };\n            this.dragSession = undefined;\n            return;\n        }\n        if (this.drawMode === \"normal\") {\n            var loopHandle = this.hitTestLoopHandle(precisePoint);\n            if (loopHandle) {\n                this.dragSession = {\n                    type: \"loop-handle\",\n                    loop: loopHandle.loop,\n                    handle: \"radius\",\n                    startPointer: point,\n                    startRadius: loopHandle.loop.radius,\n                };\n                this.interactionState = { type: \"dragging\" };\n                return;\n            }\n            var nearVertex = this.findNearestVertex(point, this.worldTolerance(12));\n            if (nearVertex) {\n                if (!this.repository.isSelected(nearVertex)) {\n                    this.repository.setCurrentElement(nearVertex);\n                    this.drawAll();\n                }\n                var selected = this.repository.getSelectedElements();\n                this.dragSession = {\n                    type: \"move\",\n                    elements: selected.length > 0 ? selected : [nearVertex],\n                    startPointer: point,\n                    lastPointer: point,\n                    totalDelta: new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(0, 0),\n                };\n                this.interactionState = { type: \"dragging\" };\n                return;\n            }\n            var handleHit = this.hitTestLineHandle(precisePoint);\n            if (handleHit) {\n                var line = handleHit.line, handle = handleHit.handle, createControl = handleHit.createControl;\n                if (!this.repository.isSelected(line)) {\n                    this.repository.setCurrentElement(line);\n                    this.drawAll();\n                }\n                this.dragSession = {\n                    type: \"handle\",\n                    line: line,\n                    handle: handle,\n                    startPointer: point,\n                    lastPointer: point,\n                    initial: {\n                        origin: line.origin.copy(),\n                        to: line.to.copy(),\n                        control: line.control ? line.control.copy() : null,\n                    },\n                    createdControl: createControl,\n                    detachMode: ev.altKey,\n                };\n                this.interactionState = { type: \"dragging\" };\n                return;\n            }\n        }\n        this.beginPotentialInteraction(point, ev);\n    };\n    RDDraw.prototype.mouseUp = function (ev) {\n        this.setPrevXY(ev.offsetX, ev.offsetY);\n        var point = this.getPointer();\n        var state = this.interactionState;\n        this.interactionState = { type: \"idle\" };\n        this.panDragLast = undefined;\n        if (state.type === \"potentialClick\") {\n            this.selectionRect = undefined;\n            this.handleCanvasClick(point, ev);\n            return;\n        }\n        if (!this.dragSession) {\n            this.selectionRect = undefined;\n            return;\n        }\n        if (this.dragSession.type === \"handle\") {\n            var session = this.dragSession;\n            this.dragSession = undefined;\n            var line = session.line;\n            var initial = session.initial;\n            var finalOrigin = line.origin.copy();\n            var finalTo = line.to.copy();\n            var finalControl = line.control ? line.control.copy() : null;\n            line.origin.moveAbsolute(initial.origin);\n            line.to.moveAbsolute(initial.to);\n            line.control = initial.control ? initial.control.copy() : null;\n            if (session.handle === \"origin\" && !session.detachMode) {\n                var snap = this.repository.findNearestVertex(finalOrigin, this.worldTolerance(12), line.startVertexId);\n                if (snap) {\n                    finalOrigin = snap;\n                }\n            }\n            if (session.handle === \"to\" && !session.detachMode) {\n                var snap = this.repository.findNearestVertex(finalTo, this.worldTolerance(12), line.endVertexId);\n                if (snap) {\n                    finalTo = snap;\n                }\n            }\n            if (session.handle === \"control\" &&\n                session.createdControl &&\n                !finalControl &&\n                !this.vectorsAlmostEqual(session.lastPointer, session.startPointer)) {\n                finalControl = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(session.lastPointer.x, session.lastPointer.y);\n            }\n            if (session.handle === \"origin\" &&\n                !this.vectorsAlmostEqual(finalOrigin, initial.origin)) {\n                this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLineEndpoint(line, \"origin\", finalOrigin));\n            }\n            if (session.handle === \"to\" &&\n                !this.vectorsAlmostEqual(finalTo, initial.to)) {\n                this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLineEndpoint(line, \"to\", finalTo));\n            }\n            var initialControl = initial.control;\n            var controlChanged = (initialControl && !finalControl) ||\n                (!initialControl && finalControl) ||\n                (initialControl && finalControl && !this.vectorsAlmostEqual(finalControl, initialControl));\n            if (session.handle === \"control\") {\n                if (controlChanged) {\n                    this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLineControlPoint(line, finalControl));\n                }\n                else if (session.createdControl && !finalControl) {\n                    line.control = null;\n                }\n            }\n            this.drawAll();\n            return;\n        }\n        if (this.dragSession.type === \"loop-handle\") {\n            var session = this.dragSession;\n            this.dragSession = undefined;\n            var loop = session.loop;\n            var radius = Math.max(1, point.minus(loop.origin).length());\n            if (Math.abs(radius - session.startRadius) > 1e-6) {\n                this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLoopRadius(loop, radius));\n            }\n            this.drawAll();\n            return;\n        }\n        if (this.dragSession.type === \"move\") {\n            var total = this.dragSession.totalDelta;\n            var elements = this.dragSession.elements;\n            this.dragSession = undefined;\n            if (Math.abs(total.x) > 0 || Math.abs(total.y) > 0) {\n                var revert_1 = total.multi(-1);\n                elements.forEach(function (elem) { return elem.move(revert_1); });\n                var commitDelta = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(total.x, total.y);\n                this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.MoveGroup(elements, commitDelta));\n            }\n            this.drawAll();\n            return;\n        }\n        if (this.dragSession.type === \"rect\") {\n            var rect = this.dragSession;\n            var area = Math.abs((rect.current.x - rect.start.x) * (rect.current.y - rect.start.y));\n            this.dragSession = undefined;\n            var additive = rect.additive;\n            this.selectionRect = undefined;\n            if (area > 0.01) {\n                this.repository.selectInRect({ x1: rect.start.x, y1: rect.start.y, x2: rect.current.x, y2: rect.current.y }, additive);\n                this.drawAll();\n            }\n            return;\n        }\n    };\n    RDDraw.prototype.move = function (ev) {\n        var _a, _b, _c, _d;\n        // loggerVer(`offset ${ev.offsetX}  ${ev.offsetY}`);\n        // loggerVer(`screen ${ev.screenX}  ${ev.screenY}`);\n        this.setPrevXY(ev.offsetX, ev.offsetY);\n        var pointer = this.getPointer();\n        if (this.panDragLast) {\n            var currentRaw = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(ev.offsetX, ev.offsetY);\n            var deltaRaw = currentRaw.minus(this.panDragLast);\n            this.panDragLast = currentRaw;\n            var offset = this.drawContext.getViewOffset();\n            this.drawContext.setViewOffset(offset.add(new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(deltaRaw.x / _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale, deltaRaw.y / _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale)));\n            this.drawAll();\n            return;\n        }\n        if (this.drawMode === \"line\" && this.lineDraftStart) {\n            this.linePreviewEnd = this.resolveLineHoverPoint(pointer);\n            var nearVertex = this.findNearestVertex(pointer, this.worldTolerance(12));\n            this.hoveredSnapVertex = nearVertex ? nearVertex.copy() : undefined;\n            this.hoveredSnapGrid = nearVertex ? undefined : this.snapToGrid(pointer);\n        }\n        else {\n            this.linePreviewEnd = undefined;\n            this.hoveredSnapVertex = undefined;\n            this.hoveredSnapGrid = undefined;\n        }\n        if (this.interactionState.type === \"potentialClick\") {\n            var delta = pointer.minus(this.interactionState.startPointer);\n            if (delta.length() > this.dragThresholdCanvas()) {\n                var hit = this.interactionState.hit;\n                var additive = this.interactionState.additive;\n                var forceRect = this.interactionState.forceRect;\n                var selected = this.repository.getSelectedElements();\n                var hitSelected = hit ? this.repository.isSelected(hit) : false;\n                if (hit &&\n                    hitSelected &&\n                    !forceRect) {\n                    var elements = selected.length > 0 ? selected : [hit];\n                    this.dragSession = {\n                        type: \"move\",\n                        elements: elements,\n                        startPointer: this.interactionState.startPointer,\n                        lastPointer: this.interactionState.startPointer,\n                        totalDelta: new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(0, 0),\n                    };\n                    this.interactionState = { type: \"dragging\" };\n                    this.performMoveDrag(pointer);\n                }\n                else {\n                    var rectAdditive = additive;\n                    this.dragSession = {\n                        type: \"rect\",\n                        start: this.interactionState.startPointer,\n                        current: pointer,\n                        additive: rectAdditive,\n                    };\n                    this.selectionRect = {\n                        x1: this.interactionState.startPointer.x,\n                        y1: this.interactionState.startPointer.y,\n                        x2: pointer.x,\n                        y2: pointer.y,\n                    };\n                    this.interactionState = { type: \"dragging\" };\n                    this.drawAll();\n                    return;\n                }\n            }\n        }\n        if (((_a = this.dragSession) === null || _a === void 0 ? void 0 : _a.type) === \"rect\") {\n            this.dragSession.current = pointer;\n            this.selectionRect = {\n                x1: this.dragSession.start.x,\n                y1: this.dragSession.start.y,\n                x2: pointer.x,\n                y2: pointer.y,\n            };\n            this.drawAll();\n            return;\n        }\n        if (((_b = this.dragSession) === null || _b === void 0 ? void 0 : _b.type) === \"handle\") {\n            this.performHandleDrag(pointer);\n            return;\n        }\n        if (((_c = this.dragSession) === null || _c === void 0 ? void 0 : _c.type) === \"loop-handle\") {\n            var loop = this.dragSession.loop;\n            var previewRadius = Math.max(1, pointer.minus(loop.origin).length());\n            loop.setRadius(previewRadius);\n            this.drawAll();\n            return;\n        }\n        if (((_d = this.dragSession) === null || _d === void 0 ? void 0 : _d.type) === \"move\") {\n            this.performMoveDrag(pointer);\n            return;\n        }\n        if (this.drawMode === \"line\" && this.lineDraftStart) {\n            this.drawAll();\n        }\n    };\n    RDDraw.prototype.onKeyDown = function (ev) {\n        var isMeta = ev.ctrlKey || ev.metaKey;\n        var key = ev.key.toLowerCase();\n        if (isMeta && key === \"s\") {\n            ev.preventDefault();\n            this.quickSaveSnapshot();\n            return;\n        }\n        if (this.isTextInput(ev)) {\n            return;\n        }\n        if (ev.key === \"Escape\") {\n            if (this.drawMode === \"line\") {\n                this.cancelLineDraft();\n            }\n            this.resetLoopPreview();\n            this.setDrawMode(\"normal\");\n            return;\n        }\n        if (ev.code === \"Space\") {\n            ev.preventDefault();\n            this.spacePanActive = true;\n            return;\n        }\n        if (isMeta && key === \"z\") {\n            ev.preventDefault();\n            if (ev.shiftKey) {\n                this.redo();\n            }\n            else {\n                this.undo();\n            }\n            return;\n        }\n        if (isMeta && (key === \"y\" || (key === \"z\" && ev.shiftKey))) {\n            ev.preventDefault();\n            this.redo();\n            return;\n        }\n        if ((ev.key === \"Delete\" || ev.key === \"Backspace\") && !ev.altKey && !ev.metaKey) {\n            ev.preventDefault();\n            this.delete();\n            return;\n        }\n        if (isMeta && key === \"c\") {\n            ev.preventDefault();\n            this.copy();\n            return;\n        }\n        if (isMeta && key === \"x\") {\n            ev.preventDefault();\n            this.cutSelection();\n            return;\n        }\n        if (isMeta && key === \"v\") {\n            ev.preventDefault();\n            this.pasteSelection();\n            return;\n        }\n        if (isMeta && key === \"a\") {\n            ev.preventDefault();\n            this.selectAll();\n            return;\n        }\n        if (isMeta && key === \"g\") {\n            ev.preventDefault();\n            if (ev.shiftKey) {\n                this.ungroupSelection();\n            }\n            else {\n                this.groupSelection();\n            }\n            return;\n        }\n        if (isMeta && key === \"e\") {\n            ev.preventDefault();\n            this.drawAll(\"svg\");\n            return;\n        }\n        if (isMeta && key === \"p\") {\n            ev.preventDefault();\n            this.drawAll(\"tikz\");\n            return;\n        }\n        if (ev.key === \"ArrowUp\") {\n            ev.preventDefault();\n            this.keyUp();\n            return;\n        }\n        if (ev.key === \"ArrowRight\") {\n            ev.preventDefault();\n            this.keyRight();\n            return;\n        }\n        if (ev.key === \"ArrowLeft\") {\n            ev.preventDefault();\n            this.keyLeft();\n            return;\n        }\n        if (ev.key === \"ArrowDown\") {\n            ev.preventDefault();\n            this.keyDown();\n            return;\n        }\n    };\n    RDDraw.prototype.onKeyUp = function (ev) {\n        if (ev.code === \"Space\") {\n            this.spacePanActive = false;\n            this.panDragLast = undefined;\n        }\n    };\n    RDDraw.prototype.quickSaveSnapshot = function () {\n        try {\n            var payload = {\n                savedAt: new Date().toISOString(),\n                data: this.repository.save(),\n            };\n            localStorage.setItem(\"quantumSketch.quickSave.latest\", JSON.stringify(payload));\n            this.setDslStatus(\"Quick save completed (browser local storage).\", \"ok\");\n            this.appendDslLog(\"Quick save: quantumSketch.quickSave.latest\", \"ok\");\n        }\n        catch (error) {\n            this.setDslStatus(\"Quick save failed.\", \"error\");\n            this.appendDslLog(\"Quick save failed: \".concat(error), \"error\");\n        }\n    };\n    RDDraw.prototype.isTextInput = function (ev) {\n        var target = ev.target;\n        if (!target) {\n            return false;\n        }\n        var tag = target.tagName;\n        return tag === \"INPUT\" || tag === \"TEXTAREA\" || target.isContentEditable;\n    };\n    RDDraw.prototype.keyUp = function () {\n        (0,_looger__WEBPACK_IMPORTED_MODULE_7__.loggerVer)(\"keyUp\");\n        var selected = this.repository.getSelectedElements();\n        if (selected.length === 0) {\n            return;\n        }\n        var delta = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(0, -1).multi(1 / _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale);\n        if (selected.length === 1) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.Move(selected[0], delta));\n        }\n        else {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.MoveGroup(selected, delta));\n        }\n        this.drawAll();\n    };\n    RDDraw.prototype.keyRight = function () {\n        (0,_looger__WEBPACK_IMPORTED_MODULE_7__.loggerVer)(\"keyRight\");\n        var selected = this.repository.getSelectedElements();\n        if (selected.length === 0) {\n            return;\n        }\n        var delta = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(1, 0).multi(1 / _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale);\n        if (selected.length === 1) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.Move(selected[0], delta));\n        }\n        else {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.MoveGroup(selected, delta));\n        }\n        this.drawAll();\n    };\n    RDDraw.prototype.keyLeft = function () {\n        (0,_looger__WEBPACK_IMPORTED_MODULE_7__.loggerVer)(\"keyLeft\");\n        var selected = this.repository.getSelectedElements();\n        if (selected.length === 0) {\n            return;\n        }\n        var delta = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(-1, 0).multi(1 / _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale);\n        if (selected.length === 1) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.Move(selected[0], delta));\n        }\n        else {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.MoveGroup(selected, delta));\n        }\n        this.drawAll();\n    };\n    RDDraw.prototype.keyDown = function () {\n        (0,_looger__WEBPACK_IMPORTED_MODULE_7__.loggerVer)(\"keyDown\");\n        var selected = this.repository.getSelectedElements();\n        if (selected.length === 0) {\n            return;\n        }\n        var delta = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(0, 1).multi(1 / _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale);\n        if (selected.length === 1) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.Move(selected[0], delta));\n        }\n        else {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.MoveGroup(selected, delta));\n        }\n        this.drawAll();\n    };\n    RDDraw.prototype.noSelectMode = function () {\n        this.isNoSelectMode = !this.isNoSelectMode;\n        if (this.isNoSelectMode) {\n            this.repository.clearSelectMode();\n        }\n        this.drawAll();\n    };\n    RDDraw.prototype.nextElem = function () {\n        this.repository.nextElem();\n        this.drawAll();\n    };\n    RDDraw.prototype.nextSubElem = function () {\n        this.repository.nextSubElem();\n        this.drawAll();\n    };\n    RDDraw.prototype.preElem = function () {\n        this.repository.preElem();\n        this.drawAll();\n    };\n    RDDraw.prototype.preSubElem = function () {\n        this.repository.preSubElem();\n        this.drawAll();\n    };\n    RDDraw.prototype.fill = function (x, y) {\n        var current = this.repository.currentElement();\n        if (current && (0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(current)) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.Fill(current));\n            this.drawAll();\n            return;\n        }\n        return;\n    };\n    RDDraw.prototype.setString = function (x, y) {\n        var current = this.repository.currentElement();\n        var defult = \"\";\n        if (current && (0,_Core_MyString__WEBPACK_IMPORTED_MODULE_3__.isString)(current)) {\n            defult = current.label;\n        }\n        var text = window.prompt(\"input text( ex. \\\\int e^x dx)\", defult);\n        if (text == null) {\n            this.setDrawMode(\"normal\");\n            return;\n        }\n        if (current && (0,_Core_MyString__WEBPACK_IMPORTED_MODULE_3__.isString)(current)) {\n            current.label = text;\n            this.setDrawMode(\"normal\");\n            return;\n        }\n        var str = new _Core_MyString__WEBPACK_IMPORTED_MODULE_3__.MyString(text);\n        str.origin = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(x, y);\n        var command = new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetString(str);\n        this.repository.doCommand(command);\n        this.setDrawMode(\"normal\");\n    };\n    RDDraw.prototype.putVertex = function (vertex) {\n        (0,_looger__WEBPACK_IMPORTED_MODULE_7__.loggerVer)(\"put vertex..\");\n        this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetVertex(vertex));\n        this.drawAll();\n    };\n    RDDraw.prototype.putLoop = function (x, y) {\n        (0,_looger__WEBPACK_IMPORTED_MODULE_7__.loggerVer)(\"put Loop..\");\n        var loop = new _Core_Loop__WEBPACK_IMPORTED_MODULE_2__.Loop();\n        loop.origin = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(x, y);\n        this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLoop(loop));\n        this.setDrawMode(\"normal\");\n    };\n    /**\n     * Redraws every element according to the requested export target. The method\n     * also maintains the side-panel widgets (current selection, mode indicator)\n     * so that the UI always reflects repository state.\n     */\n    RDDraw.prototype.drawAll = function (exportType) {\n        var _this = this;\n        var _a;\n        if (exportType === void 0) { exportType = \"canvas\"; }\n        this.drawContext.setExportType(exportType);\n        // clear\n        this.drawContext.clearRect();\n        this.drawContext.startExport();\n        var elms = this.repository.getAllElements();\n        this.drawContext.beginPath();\n        elms.forEach(function (elm, index) {\n            // loggerVer(\"draw..\");\n            (0,_draw__WEBPACK_IMPORTED_MODULE_9__.draw)(_this.drawContext, elm, exportType);\n        });\n        if (exportType === \"svg\") {\n            this.drawContext.insertsavedata(this.repository.save());\n        }\n        this.drawContext.endExport();\n        this.updateModeButtons();\n        var current = this.repository.currentElement();\n        this.updateLoopControlsUI(current);\n        if (this.isNoSelectMode) {\n            return;\n        }\n        if (exportType != \"canvas\") {\n            return;\n        }\n        if (this.drawMode === \"line\" && this.lineDraftStart) {\n            (0,_draw__WEBPACK_IMPORTED_MODULE_9__.draw)(this.drawContext, this.lineDraftStart, \"canvas\", \"sub\");\n            var pointer = (_a = this.linePreviewEnd) !== null && _a !== void 0 ? _a : this.resolveLineHoverPoint(this.getPointer());\n            this.drawContext.beginPath();\n            this.drawContext.setStrokeColor(\"sub\");\n            this.drawContext.moveTo(this.lineDraftStart.x, this.lineDraftStart.y);\n            this.drawContext.lineTo(pointer.x, pointer.y, \"dash\");\n            this.drawContext.stroke();\n            this.drawContext.closePath();\n        }\n        if (this.hoveredSnapGrid) {\n            (0,_draw__WEBPACK_IMPORTED_MODULE_9__.draw)(this.drawContext, this.hoveredSnapGrid, \"canvas\", \"sub\");\n        }\n        if (this.hoveredSnapVertex) {\n            (0,_draw__WEBPACK_IMPORTED_MODULE_9__.draw)(this.drawContext, this.hoveredSnapVertex, \"canvas\", \"sub\");\n        }\n        var selected = this.repository.getSelectedElements();\n        selected.forEach(function (elem) {\n            if (current && elem.id === current.id) {\n                return;\n            }\n            (0,_draw__WEBPACK_IMPORTED_MODULE_9__.draw)(_this.drawContext, elem, \"canvas\", \"select\");\n        });\n        var sub = this.repository.currentSubElement();\n        if (sub) {\n            (0,_draw__WEBPACK_IMPORTED_MODULE_9__.draw)(this.drawContext, sub, \"canvas\", \"sub\");\n            this.drawContext.output(\"sub:   \" + sub.description(), \"html\", \"sub\");\n        }\n        if (current) {\n            (0,_draw__WEBPACK_IMPORTED_MODULE_9__.draw)(this.drawContext, current, \"canvas\", \"select\");\n            this.drawContext.output(\"current: \" +\n                current.description() +\n                \" \".concat(current.formalDistance(this.getPointer())), \"html\", \"current\");\n        }\n        this.drawContext.output(this.describeMode(), \"html\", \"mode\");\n        var lineHandleTargets = [];\n        if (current && (0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(current)) {\n            lineHandleTargets.push(current);\n        }\n        selected.forEach(function (elem) {\n            if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(elem) && !lineHandleTargets.includes(elem)) {\n                lineHandleTargets.push(elem);\n            }\n        });\n        this.drawLineHandles(lineHandleTargets);\n        this.drawLoopHandles(this.activeLoop());\n        this.drawContext.closePath();\n        if (this.selectionRect) {\n            var scale = _Config__WEBPACK_IMPORTED_MODULE_0__.config.scale;\n            var offset = this.drawContext.getViewOffset();\n            var left = (Math.min(this.selectionRect.x1, this.selectionRect.x2) + offset.x) * scale;\n            var top_1 = (Math.min(this.selectionRect.y1, this.selectionRect.y2) + offset.y) * scale;\n            var width = Math.abs(this.selectionRect.x2 - this.selectionRect.x1) * scale;\n            var height = Math.abs(this.selectionRect.y2 - this.selectionRect.y1) * scale;\n            this.context.save();\n            this.context.strokeStyle = \"rgba(30, 144, 255, 0.9)\";\n            this.context.fillStyle = \"rgba(30, 144, 255, 0.2)\";\n            this.context.setLineDash([6, 4]);\n            this.context.strokeRect(left, top_1, width, height);\n            this.context.setLineDash([]);\n            this.context.fillRect(left, top_1, width, height);\n            this.context.restore();\n        }\n    };\n    RDDraw.prototype.describeMode = function () {\n        switch (this.drawMode) {\n            case \"normal\":\n                return \"Select\";\n            case \"point\":\n                return \"Vertex tool\";\n            case \"line\":\n                return this.lineDraftStart ? \"Propagator: pick end\" : \"Propagator: pick start\";\n            case \"loop\":\n                return \"Loop tool\";\n            case \"string\":\n                return \"Text tool\";\n        }\n        return \"\";\n    };\n    RDDraw.prototype.updateLoopControlsUI = function (current) {\n        var controls = this.loopControls;\n        if (!controls.container) {\n            return;\n        }\n        var loop = current && (0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(current) ? current : undefined;\n        this.resetLoopPreview(loop === null || loop === void 0 ? void 0 : loop.id);\n        if (!loop) {\n            controls.container.classList.add(\"d-none\");\n            return;\n        }\n        controls.container.classList.remove(\"d-none\");\n        var radius = loop.radius;\n        if (controls.radiusSlider) {\n            var slider = controls.radiusSlider;\n            slider.min = \"1\";\n            slider.step = \"0.5\";\n            var dynamicMax = Math.max(50, Math.ceil(radius + 20));\n            if (Number(slider.max) !== dynamicMax) {\n                slider.max = dynamicMax.toString();\n            }\n            slider.value = radius.toFixed(2);\n        }\n        if (controls.radiusValue) {\n            controls.radiusValue.textContent = radius.toFixed(1);\n        }\n        var startDeg = this.normalizeDegrees(this.radToDeg(loop.loopBeginAngle));\n        var endDegNormalized = this.normalizeDegrees(this.radToDeg(loop.loopEndAngle));\n        var drawnDeg = this.arcLengthDegrees(loop);\n        var gapDeg = Math.max(0, 360 - drawnDeg);\n        var isFullLoop = Math.abs(drawnDeg - 360) < 0.01;\n        var endDeg = isFullLoop ? 360 : endDegNormalized;\n        if (controls.startSlider) {\n            var slider = controls.startSlider;\n            slider.min = \"0\";\n            slider.max = \"360\";\n            slider.step = \"1\";\n            slider.value = Math.round(startDeg).toString();\n        }\n        if (controls.endSlider) {\n            var slider = controls.endSlider;\n            slider.min = \"0\";\n            slider.max = \"360\";\n            slider.step = \"1\";\n            slider.value = Math.round(endDeg).toString();\n        }\n        if (controls.startValue) {\n            controls.startValue.textContent = this.formatDegrees(startDeg);\n        }\n        if (controls.endValue) {\n            controls.endValue.textContent = this.formatDegrees(endDeg);\n        }\n        if (controls.arcValue) {\n            controls.arcValue.textContent = this.formatDegrees(drawnDeg);\n        }\n        if (controls.gapValue) {\n            controls.gapValue.textContent = this.formatDegrees(gapDeg);\n        }\n    };\n    RDDraw.prototype.currentLoop = function () {\n        var current = this.repository.currentElement();\n        if (current && (0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(current)) {\n            return current;\n        }\n        return undefined;\n    };\n    RDDraw.prototype.previewLoopRadius = function (value) {\n        var loop = this.currentLoop();\n        if (!loop) {\n            return;\n        }\n        if (!this.loopPreview || this.loopPreview.loopId !== loop.id) {\n            this.loopPreview = { loopId: loop.id, radius: { original: loop.radius } };\n        }\n        else if (!this.loopPreview.radius) {\n            this.loopPreview.radius = { original: loop.radius };\n        }\n        loop.setRadius(value);\n        this.drawAll();\n    };\n    RDDraw.prototype.commitLoopRadius = function (value) {\n        var loop = this.currentLoop();\n        if (!loop) {\n            this.finalizeLoopPreview(\"radius\");\n            return;\n        }\n        var preview = this.loopPreview;\n        if ((preview === null || preview === void 0 ? void 0 : preview.loopId) === loop.id && preview.radius) {\n            var original = preview.radius.original;\n            if (Math.abs(original - value) < 1e-6) {\n                this.finalizeLoopPreview(\"radius\");\n                this.drawAll();\n                return;\n            }\n            loop.setRadius(original);\n            this.finalizeLoopPreview(\"radius\");\n        }\n        this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLoopRadius(loop, value));\n        this.drawAll();\n    };\n    RDDraw.prototype.previewLoopStart = function (value) {\n        var loop = this.currentLoop();\n        if (!loop) {\n            return;\n        }\n        var radians = this.degToRad(value);\n        if (!this.loopPreview || this.loopPreview.loopId !== loop.id) {\n            this.loopPreview = { loopId: loop.id, start: { original: loop.loopBeginAngle } };\n        }\n        else if (!this.loopPreview.start) {\n            this.loopPreview.start = { original: loop.loopBeginAngle };\n        }\n        loop.setLoopBeginAngle(radians);\n        this.drawAll();\n    };\n    RDDraw.prototype.commitLoopStart = function (value) {\n        var loop = this.currentLoop();\n        if (!loop) {\n            this.finalizeLoopPreview(\"start\");\n            return;\n        }\n        var preview = this.loopPreview;\n        var radians = this.degToRad(value);\n        if ((preview === null || preview === void 0 ? void 0 : preview.loopId) === loop.id && preview.start) {\n            var original = preview.start.original;\n            if (Math.abs(original - radians) < 1e-6) {\n                this.finalizeLoopPreview(\"start\");\n                this.drawAll();\n                return;\n            }\n            loop.setLoopBeginAngle(original);\n            this.finalizeLoopPreview(\"start\");\n        }\n        this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLoopBeginAngle(loop, radians));\n        this.drawAll();\n    };\n    RDDraw.prototype.previewLoopEnd = function (value) {\n        var loop = this.currentLoop();\n        if (!loop) {\n            return;\n        }\n        var radians = this.degToRad(value);\n        if (!this.loopPreview || this.loopPreview.loopId !== loop.id) {\n            this.loopPreview = { loopId: loop.id, end: { original: loop.loopEndAngle } };\n        }\n        else if (!this.loopPreview.end) {\n            this.loopPreview.end = { original: loop.loopEndAngle };\n        }\n        loop.setLoopEndAngle(radians);\n        this.drawAll();\n    };\n    RDDraw.prototype.commitLoopEnd = function (value) {\n        var loop = this.currentLoop();\n        if (!loop) {\n            this.finalizeLoopPreview(\"end\");\n            return;\n        }\n        var preview = this.loopPreview;\n        var radians = this.degToRad(value);\n        if ((preview === null || preview === void 0 ? void 0 : preview.loopId) === loop.id && preview.end) {\n            var original = preview.end.original;\n            if (Math.abs(original - radians) < 1e-6) {\n                this.finalizeLoopPreview(\"end\");\n                this.drawAll();\n                return;\n            }\n            loop.setLoopEndAngle(original);\n            this.finalizeLoopPreview(\"end\");\n        }\n        this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLoopEndAngle(loop, radians));\n        this.drawAll();\n    };\n    RDDraw.prototype.adjustLoop = function (property, step) {\n        this.resetLoopPreview();\n        var loop = this.currentLoop();\n        if (!loop) {\n            return;\n        }\n        if (property === \"radius\") {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.ChangeScale(loop, step));\n        }\n        else if (property === \"start\") {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.ChangeArcAngle(loop, this.degToRad(step)));\n        }\n        else if (property === \"end\") {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.ChangeArcEndAngle(loop, this.degToRad(step)));\n        }\n        this.drawAll();\n    };\n    RDDraw.prototype.handleLoopAction = function (action) {\n        this.resetLoopPreview();\n        var loop = this.currentLoop();\n        if (!loop) {\n            return;\n        }\n        switch (action) {\n            case \"full\":\n                this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLoopAngles(loop, 0, Math.PI * 2));\n                break;\n            case \"gap60\": {\n                var start = this.degToRad(-30);\n                var end = this.degToRad(30);\n                this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLoopAngles(loop, start, end));\n                break;\n            }\n            case \"gap180\": {\n                var start = this.degToRad(-90);\n                var end = this.degToRad(90);\n                this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLoopAngles(loop, start, end));\n                break;\n            }\n            default:\n                return;\n        }\n        this.drawAll();\n    };\n    RDDraw.prototype.degToRad = function (value) {\n        return (value * Math.PI) / 180;\n    };\n    RDDraw.prototype.radToDeg = function (value) {\n        return (value * 180) / Math.PI;\n    };\n    RDDraw.prototype.normalizeDegrees = function (value) {\n        var result = value % 360;\n        if (result < 0) {\n            result += 360;\n        }\n        return result;\n    };\n    RDDraw.prototype.formatDegrees = function (value) {\n        return \"\".concat(Math.round(value), \"\\u00B0\");\n    };\n    RDDraw.prototype.arcLengthDegrees = function (loop) {\n        var diff = loop.loopEndAngle - loop.loopBeginAngle;\n        if (diff <= 0) {\n            diff += 2 * Math.PI;\n        }\n        return this.radToDeg(diff);\n    };\n    RDDraw.prototype.resetLoopPreview = function (exceptLoopId) {\n        var preview = this.loopPreview;\n        if (!preview) {\n            return;\n        }\n        if (exceptLoopId && preview.loopId === exceptLoopId) {\n            return;\n        }\n        var element = this.repository.getElement(preview.loopId);\n        if (element && (0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(element)) {\n            if (preview.radius) {\n                element.setRadius(preview.radius.original);\n            }\n            if (preview.start) {\n                element.setLoopBeginAngle(preview.start.original);\n            }\n            if (preview.end) {\n                element.setLoopEndAngle(preview.end.original);\n            }\n        }\n        this.loopPreview = undefined;\n    };\n    RDDraw.prototype.finalizeLoopPreview = function (part) {\n        var preview = this.loopPreview;\n        if (!preview) {\n            return;\n        }\n        if (part === \"radius\") {\n            delete preview.radius;\n        }\n        else if (part === \"start\") {\n            delete preview.start;\n        }\n        else {\n            delete preview.end;\n        }\n        if (!preview.radius && !preview.start && !preview.end) {\n            this.loopPreview = undefined;\n        }\n    };\n    RDDraw.prototype.putLine = function (point, isReverse) {\n        var current = this.repository.currentElement();\n        var sub = this.repository.currentSubElement();\n        if (point) {\n            sub = current;\n            current = point;\n        }\n        if (!current) {\n            return;\n        }\n        if (!sub) {\n            return;\n        }\n        if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(current) && (0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(sub)) {\n            if (current.x == sub.x && current.y == sub.y) {\n                return;\n            }\n            var line = new _Core_Line__WEBPACK_IMPORTED_MODULE_1__.Line();\n            line.origin = sub;\n            line.to = current;\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLine(line));\n            this.repository.select(current);\n            this.drawAll();\n            return;\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(current) && (0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(sub)) {\n            if (current.origin.x == sub.origin.x &&\n                current.origin.y == sub.origin.y) {\n                return;\n            }\n            var line = new _Core_Line__WEBPACK_IMPORTED_MODULE_1__.Line();\n            line.between(current, sub);\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLine(line));\n            this.drawAll();\n            return;\n        }\n        if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(current) && (0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(sub)) {\n            var line = new _Core_Line__WEBPACK_IMPORTED_MODULE_1__.Line();\n            line.origin = current;\n            if (isReverse) {\n                sub.addLineTo(line);\n            }\n            else {\n                sub.addLineOrigin(line);\n            }\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLine(line));\n            this.drawAll();\n            return;\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(current) && (0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(sub)) {\n            var line = new _Core_Line__WEBPACK_IMPORTED_MODULE_1__.Line();\n            line.origin = sub;\n            current.addLineTo(line);\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLine(line));\n            this.drawAll();\n            return;\n        }\n        if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(current) && (0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(sub)) {\n            var line = new _Core_Line__WEBPACK_IMPORTED_MODULE_1__.Line();\n            if (isReverse) {\n                line.origin = sub.to;\n            }\n            else {\n                line.origin = sub.origin;\n            }\n            line.to = current;\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLine(line));\n            this.drawAll();\n            return;\n        }\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(current) && (0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(sub)) {\n            var line = new _Core_Line__WEBPACK_IMPORTED_MODULE_1__.Line();\n            if (isReverse) {\n                line.to = current.to;\n            }\n            else {\n                line.to = current.origin;\n            }\n            line.origin = sub;\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLine(line));\n            this.drawAll();\n            return;\n        }\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(current) && (0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(sub)) {\n            var line = new _Core_Line__WEBPACK_IMPORTED_MODULE_1__.Line();\n            if (isReverse) {\n                line.to = current.to;\n            }\n            else {\n                line.to = current.origin;\n            }\n            line.origin = sub.to;\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLine(line));\n            this.drawAll();\n            return;\n        }\n    };\n    RDDraw.prototype.copy = function () {\n        this.copySelection();\n    };\n    RDDraw.prototype.setDslStatus = function (message, type) {\n        if (type === void 0) { type = \"neutral\"; }\n        if (!this.dslStatusElement) {\n            return;\n        }\n        this.dslStatusElement.textContent = message;\n        this.dslStatusElement.classList.remove(\"text-secondary\", \"text-success\", \"text-danger\");\n        if (type === \"ok\") {\n            this.dslStatusElement.classList.add(\"text-success\");\n            return;\n        }\n        if (type === \"error\") {\n            this.dslStatusElement.classList.add(\"text-danger\");\n            return;\n        }\n        this.dslStatusElement.classList.add(\"text-secondary\");\n    };\n    RDDraw.prototype.appendDslLog = function (text, kind) {\n        if (kind === void 0) { kind = \"info\"; }\n        if (!this.dslLogElement) {\n            return;\n        }\n        var stamp = new Date().toLocaleTimeString();\n        var prefix = kind === \"ok\" ? \"OK\" : kind === \"error\" ? \"ERR\" : \"INFO\";\n        var line = \"[\".concat(stamp, \"] \").concat(prefix, \" \").concat(text);\n        var previous = this.dslLogElement.textContent;\n        if (!previous || previous === \"Execution log is empty.\") {\n            this.dslLogElement.textContent = line;\n            return;\n        }\n        this.dslLogElement.textContent = \"\".concat(line, \"\\n\").concat(previous);\n    };\n    RDDraw.prototype.openSelectionMacroEditor = function () {\n        var selected = this.repository.getSelectedElements();\n        if (selected.length === 0) {\n            this.selectionMacroEditMode = false;\n            this.setDslStatus(\"Select elements before editing as macro.\", \"neutral\");\n            return;\n        }\n        var script = this.buildSelectionMacroScript(selected);\n        if (!script) {\n            this.selectionMacroEditMode = false;\n            this.setDslStatus(\"Selection contains no macro-exportable geometry.\", \"error\");\n            return;\n        }\n        if (this.dslScriptElement) {\n            this.dslScriptElement.value = script;\n            this.dslScriptElement.focus();\n            this.dslScriptElement.setSelectionRange(0, this.dslScriptElement.value.length);\n        }\n        this.selectionMacroEditMode = true;\n        this.setDslStatus(\"Selection macro loaded. Edit and run script to replace selection.\", \"ok\");\n        this.appendDslLog(\"Selection macro exported to script editor.\", \"info\");\n    };\n    RDDraw.prototype.buildSelectionMacroScript = function (selected) {\n        var lines = selected.filter(function (elem) { return (0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(elem); });\n        var loops = selected.filter(function (elem) { return (0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(elem); });\n        if (lines.length === 0 && loops.length === 0) {\n            return null;\n        }\n        var commands = [\n            \"# Selection macro (editable)\",\n            \"# Run Script will replace current selection with this script output.\",\n            \"# line x1 y1 x2 y2 [style]\",\n            \"# loop x y radius [style] [beginAngle] [endAngle]\",\n        ];\n        var format = function (value) { return Number(value.toFixed(3)).toString(); };\n        lines\n            .slice()\n            .sort(function (a, b) { return Number(a.id) - Number(b.id); })\n            .forEach(function (line) {\n            commands.push(\"line \".concat(format(line.origin.x), \" \").concat(format(line.origin.y), \" \").concat(format(line.to.x), \" \").concat(format(line.to.y), \" \").concat(line.style));\n        });\n        loops\n            .slice()\n            .sort(function (a, b) { return Number(a.id) - Number(b.id); })\n            .forEach(function (loop) {\n            commands.push(\"loop \".concat(format(loop.origin.x), \" \").concat(format(loop.origin.y), \" \").concat(format(loop.radius), \" \").concat(loop.style, \" \").concat(format(loop.loopBeginAngle), \" \").concat(format(loop.loopEndAngle)));\n        });\n        return commands.join(\"\\n\");\n    };\n    RDDraw.prototype.applySelectionMacroScript = function (script) {\n        var selected = this.repository.getSelectedElements();\n        if (selected.length === 0) {\n            this.selectionMacroEditMode = false;\n            this.setDslStatus(\"Macro edit mode ended because selection was cleared.\", \"neutral\");\n            return false;\n        }\n        var text = script.trim();\n        if (!text) {\n            this.setDslStatus(\"Script is empty.\", \"error\");\n            return false;\n        }\n        var historyHeadBefore = this.repository.historyHead;\n        var idsBefore = new Set(this.repository.getAllElements().map(function (elem) { return elem.id; }));\n        if (selected.length === 1) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.Delete(selected[0]));\n        }\n        else {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.DeleteGroup(selected));\n        }\n        this.repository.clearSelectMode();\n        var batch = this.scriptEngine.executeScript(text, true);\n        if (!batch.success) {\n            while (this.repository.historyHead > historyHeadBefore) {\n                this.repository.undo();\n            }\n            this.drawAll();\n            this.setDslStatus(batch.message, \"error\");\n            this.appendDslLog(batch.message, \"error\");\n            return false;\n        }\n        var inserted = this.repository.getAllElements().filter(function (elem) { return !idsBefore.has(elem.id); });\n        if (inserted.length > 0) {\n            this.repository.setSelection(inserted);\n        }\n        this.drawAll();\n        return true;\n    };\n    RDDraw.prototype.cutSelection = function () {\n        var selected = this.repository.getSelectedElements();\n        if (selected.length === 0) {\n            return;\n        }\n        this.copySelection();\n        this.delete();\n    };\n    RDDraw.prototype.groupSelection = function () {\n        var selected = this.repository.getSelectedElements();\n        if (selected.length < 2) {\n            return;\n        }\n        this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.GroupSelection(selected));\n        this.drawAll();\n    };\n    RDDraw.prototype.ungroupSelection = function () {\n        var selected = this.repository.getSelectedElements();\n        if (selected.length !== 1 || !(0,_Core_Group__WEBPACK_IMPORTED_MODULE_6__.isGroup)(selected[0])) {\n            return;\n        }\n        this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.UngroupSelection(selected[0]));\n        this.drawAll();\n    };\n    RDDraw.prototype.copySelection = function () {\n        var selectedRaw = this.repository.getSelectedElements();\n        var selected = selectedRaw.length > 0\n            ? selectedRaw\n            : (this.repository.currentElement() ? [this.repository.currentElement()] : []);\n        if (selected.length === 0) {\n            return;\n        }\n        var vertexMap = new Map();\n        var lines = [];\n        var loops = [];\n        var strings = [];\n        var ensureVertex = function (vertex) {\n            if (!vertexMap.has(vertex.id)) {\n                vertexMap.set(vertex.id, new _Core_Vertex__WEBPACK_IMPORTED_MODULE_5__.Vertex(vertex.x, vertex.y));\n            }\n        };\n        var flatten = function (elem) {\n            if (!(0,_Core_Group__WEBPACK_IMPORTED_MODULE_6__.isGroup)(elem)) {\n                return [elem];\n            }\n            return elem.elements.flatMap(function (child) { return flatten(child); });\n        };\n        selected.flatMap(function (elem) { return flatten(elem); }).forEach(function (elem) {\n            var _a;\n            if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(elem)) {\n                ensureVertex(elem);\n                return;\n            }\n            if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(elem)) {\n                ensureVertex(elem.origin);\n                ensureVertex(elem.to);\n                lines.push({\n                    startId: elem.origin.id,\n                    endId: elem.to.id,\n                    style: elem.style,\n                    label: elem.label,\n                    labelDiff: elem.labelDiff,\n                    allow: elem.allow,\n                    arrowRotation: (_a = elem.arrowRotation) !== null && _a !== void 0 ? _a : 0,\n                    control: elem.control ? elem.control.copy() : null,\n                });\n                return;\n            }\n            if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(elem)) {\n                ensureVertex(elem.origin);\n                loops.push({\n                    centerId: elem.origin.id,\n                    radius: elem.radius,\n                    style: elem.style,\n                    allow: elem.allow,\n                    fill: elem.fill,\n                    label: elem.label,\n                    loopBeginAngle: elem.loopBeginAngle,\n                    loopEndAngle: elem.loopEndAngle,\n                });\n                return;\n            }\n            if ((0,_Core_MyString__WEBPACK_IMPORTED_MODULE_3__.isString)(elem)) {\n                strings.push({ x: elem.origin.x, y: elem.origin.y, label: elem.label });\n            }\n        });\n        this.clipboardSnapshot = {\n            vertices: Array.from(vertexMap.entries()).map(function (_a) {\n                var id = _a[0], vertex = _a[1];\n                return ({\n                    id: id,\n                    x: vertex.x,\n                    y: vertex.y,\n                });\n            }),\n            lines: lines,\n            loops: loops,\n            strings: strings,\n        };\n    };\n    RDDraw.prototype.pasteSelection = function () {\n        var _this = this;\n        var snapshot = this.clipboardSnapshot;\n        if (!snapshot) {\n            return;\n        }\n        var offset = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(1.2, 1.2);\n        var idMap = new Map();\n        snapshot.vertices.forEach(function (data) {\n            var vertex = new _Core_Vertex__WEBPACK_IMPORTED_MODULE_5__.Vertex(data.x + offset.x, data.y + offset.y);\n            _this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetVertex(vertex));\n            var created = _this.repository.currentElement();\n            if (created && (0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(created)) {\n                idMap.set(data.id, created);\n            }\n            else {\n                idMap.set(data.id, vertex);\n            }\n        });\n        snapshot.lines.forEach(function (data) {\n            var start = idMap.get(data.startId);\n            var end = idMap.get(data.endId);\n            if (!start || !end) {\n                return;\n            }\n            var line = new _Core_Line__WEBPACK_IMPORTED_MODULE_1__.Line();\n            line.style = data.style;\n            line.label = data.label;\n            line.labelDiff = data.labelDiff;\n            line.allow = data.allow;\n            line.arrowRotation = data.arrowRotation;\n            line.control = data.control ? data.control.add(offset) : null;\n            line.origin = start;\n            line.to = end;\n            _this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLine(line));\n        });\n        snapshot.loops.forEach(function (data) {\n            var center = idMap.get(data.centerId);\n            if (!center) {\n                return;\n            }\n            var loop = new _Core_Loop__WEBPACK_IMPORTED_MODULE_2__.Loop();\n            loop.origin = center;\n            loop.setRadius(data.radius);\n            loop.style = data.style;\n            loop.allow = data.allow;\n            loop.fill = data.fill;\n            loop.label = data.label;\n            loop.loopBeginAngle = data.loopBeginAngle;\n            loop.loopEndAngle = data.loopEndAngle;\n            _this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetLoop(loop));\n        });\n        snapshot.strings.forEach(function (data) {\n            var str = new _Core_MyString__WEBPACK_IMPORTED_MODULE_3__.MyString(data.label);\n            str.origin = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(data.x + offset.x, data.y + offset.y);\n            _this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetString(str));\n        });\n        this.drawAll();\n    };\n    RDDraw.prototype.selectAll = function () {\n        var all = this.repository.getAllElements();\n        if (all.length === 0) {\n            return;\n        }\n        this.repository.setSelection(all);\n        this.drawAll();\n    };\n    RDDraw.prototype.rotation = function () {\n        var elem = this.repository.currentElement();\n        if (!elem) {\n            return;\n        }\n        if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(elem)) {\n            return;\n        }\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(elem)) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.Rotation(elem, (2 * Math.PI) / 72));\n            this.drawAll();\n            return;\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(elem)) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.Rotation(elem, (2 * Math.PI) / 72));\n            this.drawAll();\n            return;\n        }\n    };\n    RDDraw.prototype.antiRotation = function () {\n        var elem = this.repository.currentElement();\n        if (!elem) {\n            return;\n        }\n        if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(elem)) {\n            return;\n        }\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(elem)) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.Rotation(elem, -(2 * Math.PI) / 72));\n            this.drawAll();\n            return;\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(elem)) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.Rotation(elem, -(2 * Math.PI) / 72));\n            this.drawAll();\n            return;\n        }\n    };\n    RDDraw.prototype.allowToggle = function () {\n        var elem = this.repository.currentElement();\n        if (!elem) {\n            return;\n        }\n        if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(elem)) {\n            return;\n        }\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(elem)) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.ArrowToggle(elem));\n            this.drawAll();\n            return;\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(elem)) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.ArrowToggle(elem));\n            this.drawAll();\n            return;\n        }\n    };\n    RDDraw.prototype.changeSelect = function () {\n        this.repository.changeSelect();\n        this.drawAll();\n        return;\n    };\n    RDDraw.prototype.changeType = function () {\n        var elem = this.repository.currentElement();\n        if (!elem) {\n            return;\n        }\n        if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(elem)) {\n            return;\n        }\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(elem)) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.ChangeType(elem));\n            this.drawAll();\n            return;\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(elem)) {\n            return;\n        }\n    };\n    RDDraw.prototype.changeArcAngle = function () {\n        (0,_looger__WEBPACK_IMPORTED_MODULE_7__.loggerVer)(\"changeArcAngle..\");\n        var elem = this.repository.currentElement();\n        if (!elem) {\n            return;\n        }\n        if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(elem)) {\n            return;\n        }\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(elem)) {\n            return;\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(elem)) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.ChangeArcAngle(elem, (2 * Math.PI) / 72));\n            this.drawAll();\n            return;\n        }\n    };\n    RDDraw.prototype.changeArcAngleMinus = function () {\n        var elem = this.repository.currentElement();\n        if (!elem) {\n            return;\n        }\n        if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(elem)) {\n            return;\n        }\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(elem)) {\n            return;\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(elem)) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.ChangeArcAngle(elem, -(2 * Math.PI) / 72));\n            this.drawAll();\n            return;\n        }\n    };\n    RDDraw.prototype.changeArcEndAngle = function () {\n        var elem = this.repository.currentElement();\n        if (!elem) {\n            return;\n        }\n        if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(elem)) {\n            return;\n        }\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(elem)) {\n            return;\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(elem)) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.ChangeArcEndAngle(elem, (2 * Math.PI) / 72));\n            this.drawAll();\n            return;\n        }\n    };\n    RDDraw.prototype.changeArcEndAngleMinus = function () {\n        var elem = this.repository.currentElement();\n        if (!elem) {\n            return;\n        }\n        if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(elem)) {\n            return;\n        }\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(elem)) {\n            return;\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(elem)) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.ChangeArcEndAngle(elem, -(2 * Math.PI) / 72));\n            this.drawAll();\n            return;\n        }\n    };\n    RDDraw.prototype.changeScale = function () {\n        var elem = this.repository.currentElement();\n        if (!elem) {\n            return;\n        }\n        if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(elem)) {\n            return;\n        }\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(elem)) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.ChangeScale(elem, 1.0));\n            this.drawAll();\n            return;\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(elem)) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.ChangeScale(elem, 1.0));\n            this.drawAll();\n            return;\n        }\n    };\n    RDDraw.prototype.changeScaleDown = function () {\n        var elem = this.repository.currentElement();\n        if (!elem) {\n            return;\n        }\n        if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(elem)) {\n            return;\n        }\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(elem)) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.ChangeScale(elem, -1.0));\n            this.drawAll();\n            return;\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(elem)) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.ChangeScale(elem, -1.0));\n            this.drawAll();\n            return;\n        }\n    };\n    RDDraw.prototype.changeStyle = function () {\n        var elem = this.repository.currentElement();\n        if (!elem) {\n            return;\n        }\n        if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(elem)) {\n            return;\n        }\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(elem)) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.ChangeStyle(elem));\n            this.drawAll();\n            return;\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(elem)) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.ChangeStyle(elem));\n            this.drawAll();\n            return;\n        }\n    };\n    RDDraw.prototype.activeLines = function () {\n        var selectedLines = this.repository\n            .getSelectedElements()\n            .filter(function (elem) { return (0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(elem); });\n        if (selectedLines.length > 0) {\n            return selectedLines;\n        }\n        var current = this.repository.currentElement();\n        if (current && (0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(current)) {\n            return [current];\n        }\n        return [];\n    };\n    RDDraw.prototype.rotateArrow = function (delta) {\n        var lines = this.activeLines();\n        if (lines.length === 0) {\n            return;\n        }\n        this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.RotateArrow(lines, delta));\n        this.drawAll();\n    };\n    RDDraw.prototype.resetArrowRotation = function () {\n        var lines = this.activeLines();\n        if (lines.length === 0) {\n            return;\n        }\n        this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.SetArrowRotation(lines, 0));\n        this.drawAll();\n    };\n    RDDraw.prototype.delete = function () {\n        var selected = this.repository.getSelectedElements();\n        if (selected.length === 0) {\n            return;\n        }\n        if (selected.length === 1) {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.Delete(selected[0]));\n        }\n        else {\n            this.repository.doCommand(new _RepositoryCommand__WEBPACK_IMPORTED_MODULE_11__.DeleteGroup(selected));\n        }\n        this.repository.clearSelectMode();\n        this.drawAll();\n    };\n    RDDraw.prototype.select = function (point) {\n        this.selectAt(point, false);\n    };\n    RDDraw.prototype.subSelect = function (point) {\n        this.selectAt(point, true);\n    };\n    RDDraw.prototype.undo = function () {\n        (0,_looger__WEBPACK_IMPORTED_MODULE_7__.loggerVer)(\"undo\");\n        this.repository.undo();\n        this.drawAll();\n    };\n    RDDraw.prototype.redo = function () {\n        (0,_looger__WEBPACK_IMPORTED_MODULE_7__.loggerVer)(\"redo\");\n        this.repository.redo();\n        this.drawAll();\n    };\n    return RDDraw;\n}());\n\n\n\n//# sourceURL=webpack://rdfeyn/./src/UI/RDDraw.ts?");

/***/ }),

/***/ "./src/UI/RDRepository.ts":
/*!********************************!*\
  !*** ./src/UI/RDRepository.ts ***!
  \********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"RDRepository\": () => (/* binding */ RDRepository)\n/* harmony export */ });\n/* harmony import */ var _Core_Elem__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../Core/Elem */ \"./src/Core/Elem.ts\");\n/* harmony import */ var _Core_Line__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../Core/Line */ \"./src/Core/Line.ts\");\n/* harmony import */ var _Core_Loop__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../Core/Loop */ \"./src/Core/Loop.ts\");\n/* harmony import */ var _Core_MyString__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../Core/MyString */ \"./src/Core/MyString.ts\");\n/* harmony import */ var _Core_Vector__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../Core/Vector */ \"./src/Core/Vector.ts\");\n/* harmony import */ var _Core_Vertex__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../Core/Vertex */ \"./src/Core/Vertex.ts\");\n/* harmony import */ var _Core_Group__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ../Core/Group */ \"./src/Core/Group.ts\");\n/* harmony import */ var _looger__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ../looger */ \"./src/looger.ts\");\nvar __spreadArray = (undefined && undefined.__spreadArray) || function (to, from, pack) {\n    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {\n        if (ar || !(i in from)) {\n            if (!ar) ar = Array.prototype.slice.call(from, 0, i);\n            ar[i] = from[i];\n        }\n    }\n    return to.concat(ar || Array.prototype.slice.call(from));\n};\n\n\n\n\n\n\n\n\nvar RDRepository = /** @class */ (function () {\n    function RDRepository() {\n        this.vertexList = [];\n        this.loopList = [];\n        this.lineList = [];\n        this.vertexMap = new Map();\n        this.currentIndex = undefined;\n        this.currentSubIndex = undefined;\n        this.elements = [];\n        this.selectedIds = new Set();\n        this.idCount = 0;\n        this.history = [];\n        this.historyHead = 0;\n        this.selectionOrder = [];\n    }\n    RDRepository.prototype.save = function () {\n        return JSON.stringify({\n            elements: this.elements.map(function (e) { return e.save(); }),\n        });\n    };\n    RDRepository.prototype.load = function (saveData) {\n        var saveJson = JSON.parse(saveData);\n        this.idCount = 0;\n        this.selectedIds.clear();\n        this.selectionOrder = [];\n        this.currentSubId = undefined;\n        this.elements = this.loadElements(saveJson[\"elements\"]);\n        this.reindexElements();\n        this.rebindGraphReferences();\n        this.syncSelectionState();\n        var ids = this.elements\n            .map(function (e) { return Number.parseFloat(e.id); })\n            .filter(function (value) { return Number.isFinite(value); });\n        this.idCount = ids.length > 0 ? Math.max.apply(Math, ids.map(function (n) { return Math.floor(n); })) : 0;\n        (0,_Core_Elem__WEBPACK_IMPORTED_MODULE_0__.setElemIDCounter)(this.idCount + 1);\n    };\n    RDRepository.prototype.loadElements = function (saveJsonElements) {\n        return saveJsonElements\n            .flatMap(function (raw) {\n            var json = JSON.parse(raw);\n            var shape = json[\"shape\"];\n            if (!shape) {\n                return undefined;\n            }\n            switch (shape) {\n                case \"Line\":\n                    return (0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.makeLine)(json);\n                case \"Loop\":\n                    return (0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.makeLoop)(json);\n                case \"Point\":\n                    return (0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.makeVector)(json);\n                case \"String\":\n                    return (0,_Core_MyString__WEBPACK_IMPORTED_MODULE_3__.makeMyString)(json);\n                default:\n                    return undefined;\n            }\n        })\n            .flatMap(function (e) { return (e ? [e] : []); });\n    };\n    RDRepository.prototype.getElement = function (id) {\n        return this.elements.find(function (elem) { return elem.id === id; });\n    };\n    RDRepository.prototype.setCurrentElement = function (elem, additive) {\n        if (additive === void 0) { additive = false; }\n        var index = this.elements.findIndex(function (e) { return e.id === elem.id; });\n        if (index === -1) {\n            return;\n        }\n        if (!additive) {\n            this.selectedIds.clear();\n            this.selectionOrder = [];\n        }\n        this.selectedIds.add(elem.id);\n        this.pushSelectionOrder(elem.id);\n        this.syncSelectionState();\n    };\n    RDRepository.prototype.setSubCurrentElement = function (elem) {\n        if (!this.elements.some(function (e) { return e.id === elem.id; })) {\n            return;\n        }\n        this.currentSubId = elem.id;\n        this.currentSubIndex = this.elements.findIndex(function (e) { return e.id === elem.id; });\n    };\n    RDRepository.prototype.currentElement = function () {\n        if (this.selectionOrder.length === 0) {\n            return undefined;\n        }\n        var id = this.selectionOrder[this.selectionOrder.length - 1];\n        return this.getElement(id);\n    };\n    RDRepository.prototype.currentSubElement = function () {\n        if (!this.currentSubId) {\n            return undefined;\n        }\n        return this.getElement(this.currentSubId);\n    };\n    RDRepository.prototype.getAllVertex = function () {\n        return this.vertexList;\n    };\n    RDRepository.prototype.getVertex = function (id) {\n        return this.vertexMap.get(id);\n    };\n    RDRepository.prototype.getAllLoop = function () {\n        return this.loopList;\n    };\n    RDRepository.prototype.getAllLine = function () {\n        return this.lineList;\n    };\n    RDRepository.prototype.getAllElements = function () {\n        return this.elements;\n    };\n    RDRepository.prototype.getSelectedElements = function () {\n        var _this = this;\n        if (this.selectedIds.size === 0) {\n            return [];\n        }\n        return this.elements.filter(function (elem) { return _this.selectedIds.has(elem.id); });\n    };\n    RDRepository.prototype.isSelected = function (elem) {\n        return this.selectedIds.has(elem.id);\n    };\n    RDRepository.prototype.deleteCurrentEelemnt = function () {\n        var current = this.currentElement();\n        if (!current) {\n            return;\n        }\n        var index = this.elements.indexOf(current);\n        if (index >= 0) {\n            this.elements.splice(index, 1);\n        }\n        this.selectedIds.delete(current.id);\n        this.selectionOrder = this.selectionOrder.filter(function (id) { return id !== current.id; });\n        this.syncSelectionState();\n    };\n    RDRepository.prototype.doCommand = function (command) {\n        this.history[this.historyHead++] = command;\n        this.history.splice(this.historyHead);\n        command.action(this);\n        this.reindexElements();\n        this.rebindGraphReferences();\n        this.syncSelectionState();\n    };\n    RDRepository.prototype.nextElem = function () {\n        (0,_looger__WEBPACK_IMPORTED_MODULE_7__.loggerVer)(\"nextElem\");\n        if (this.elements.length === 0) {\n            return;\n        }\n        var current = this.currentElement();\n        var currentIndex = current ? this.elements.findIndex(function (e) { return e.id === current.id; }) : -1;\n        var nextIndex = currentIndex < 0 ? 0 : (currentIndex + 1) % this.elements.length;\n        this.setCurrentElement(this.elements[nextIndex], false);\n    };\n    RDRepository.prototype.nextSubElem = function () {\n        if (this.elements.length === 0) {\n            return;\n        }\n        var currentSub = this.currentSubElement();\n        var currentIndex = currentSub ? this.elements.findIndex(function (e) { return e.id === currentSub.id; }) : -1;\n        var nextIndex = currentIndex < 0 ? 0 : (currentIndex + 1) % this.elements.length;\n        this.setSubCurrentElement(this.elements[nextIndex]);\n    };\n    RDRepository.prototype.preElem = function () {\n        if (this.elements.length === 0) {\n            return;\n        }\n        var current = this.currentElement();\n        var currentIndex = current ? this.elements.findIndex(function (e) { return e.id === current.id; }) : 0;\n        var prevIndex = currentIndex <= 0 ? this.elements.length - 1 : currentIndex - 1;\n        this.setCurrentElement(this.elements[prevIndex], false);\n    };\n    RDRepository.prototype.preSubElem = function () {\n        if (this.elements.length === 0) {\n            return;\n        }\n        var currentSub = this.currentSubElement();\n        var currentIndex = currentSub ? this.elements.findIndex(function (e) { return e.id === currentSub.id; }) : 0;\n        var prevIndex = currentIndex <= 0 ? this.elements.length - 1 : currentIndex - 1;\n        this.setSubCurrentElement(this.elements[prevIndex]);\n    };\n    RDRepository.prototype.findMostNearElements = function (point, elements, tolerance) {\n        var _this = this;\n        if (tolerance === void 0) { tolerance = 2; }\n        var nearByBounds = elements.filter(function (elem) {\n            var box = _this.elementBounds(elem);\n            var inflate = tolerance;\n            return !(point.x < box.x1 - inflate ||\n                point.x > box.x2 + inflate ||\n                point.y < box.y1 - inflate ||\n                point.y > box.y2 + inflate);\n        });\n        var sorted = __spreadArray([], nearByBounds, true).map(function (elem) { return ({ elem: elem, distance: elem.formalDistance(point) }); })\n            .filter(function (_a) {\n            var distance = _a.distance;\n            return Number.isFinite(distance);\n        })\n            .sort(function (a, b) { return a.distance - b.distance; });\n        if (sorted.length === 0) {\n            return [];\n        }\n        var minDistance = sorted[0].distance;\n        if (!Number.isFinite(minDistance) || minDistance > tolerance) {\n            return [];\n        }\n        return sorted\n            .filter(function (_a) {\n            var distance = _a.distance;\n            return Math.abs(distance - minDistance) < 1e-6;\n        })\n            .map(function (_a) {\n            var elem = _a.elem;\n            return elem;\n        });\n    };\n    RDRepository.prototype.select = function (point) {\n        var _a;\n        var elem = this.findElement(point, (_a = this.currentElement()) === null || _a === void 0 ? void 0 : _a.id);\n        if (elem) {\n            this.setCurrentElement(elem);\n        }\n    };\n    RDRepository.prototype.subSelect = function (point) {\n        var _a;\n        var elem = this.findElement(point, (_a = this.currentSubElement()) === null || _a === void 0 ? void 0 : _a.id);\n        if (elem) {\n            this.setSubCurrentElement(elem);\n        }\n    };\n    RDRepository.prototype.findElement = function (point, currentId, tolerance) {\n        if (tolerance === void 0) { tolerance = 2; }\n        var nearElements = this.findMostNearElements(point, this.elements, tolerance);\n        if (nearElements.length === 0) {\n            return undefined;\n        }\n        if (!currentId) {\n            return nearElements[0];\n        }\n        var currentIndex = nearElements.findIndex(function (e) { return e.id === currentId; });\n        if (currentIndex < 0) {\n            return nearElements[0];\n        }\n        return nearElements[(currentIndex + 1) % nearElements.length];\n    };\n    RDRepository.prototype.findNearest = function (point, tolerance) {\n        if (tolerance === void 0) { tolerance = 2; }\n        var nearElements = this.findMostNearElements(point, this.elements, tolerance);\n        return nearElements.length > 0 ? nearElements[0] : undefined;\n    };\n    RDRepository.prototype.findAllNear = function (point, tolerance) {\n        if (tolerance === void 0) { tolerance = 2; }\n        return this.findMostNearElements(point, this.elements, tolerance);\n    };\n    RDRepository.prototype.clearSelectMode = function () {\n        this.selectedIds.clear();\n        this.selectionOrder = [];\n        this.currentIndex = undefined;\n        this.currentSubIndex = undefined;\n        this.currentSubId = undefined;\n    };\n    RDRepository.prototype.changeSelect = function () {\n        var current = this.currentElement();\n        var sub = this.currentSubElement();\n        if (!sub) {\n            return;\n        }\n        this.setCurrentElement(sub, false);\n        if (current) {\n            this.setSubCurrentElement(current);\n        }\n        else {\n            this.currentSubId = undefined;\n            this.currentSubIndex = undefined;\n        }\n    };\n    RDRepository.prototype.undo = function () {\n        if (this.historyHead <= 0) {\n            return;\n        }\n        this.history[--this.historyHead].unaction(this);\n        this.reindexElements();\n        this.rebindGraphReferences();\n        this.syncSelectionState();\n    };\n    RDRepository.prototype.redo = function () {\n        if (this.historyHead >= this.history.length) {\n            return;\n        }\n        this.history[this.historyHead++].action(this);\n        this.reindexElements();\n        this.rebindGraphReferences();\n        this.syncSelectionState();\n    };\n    RDRepository.prototype.ensureVertex = function (point, tolerance) {\n        if (tolerance === void 0) { tolerance = 0.15; }\n        var near = this.findNearestVertex(point, tolerance);\n        if (near) {\n            return near;\n        }\n        var vertex = new _Core_Vertex__WEBPACK_IMPORTED_MODULE_5__.Vertex(point.x, point.y);\n        this.vertexList.push(vertex);\n        this.elements.push(vertex);\n        this.vertexMap.set(vertex.id, vertex);\n        this.currentIndex = this.elements.length - 1;\n        return vertex;\n    };\n    RDRepository.prototype.findNearestVertex = function (point, tolerance, skipId) {\n        if (tolerance === void 0) { tolerance = 1.0; }\n        var nearest = undefined;\n        var minDistance = Number.POSITIVE_INFINITY;\n        this.vertexList.forEach(function (vertex) {\n            if (skipId && vertex.id === skipId) {\n                return;\n            }\n            var distance = vertex.minus(point).length();\n            if (distance < minDistance) {\n                minDistance = distance;\n                nearest = vertex;\n            }\n        });\n        if (nearest && minDistance <= tolerance) {\n            return nearest;\n        }\n        return undefined;\n    };\n    RDRepository.prototype.bindLineToVertices = function (line, start, end) {\n        var previousStart = line.startVertexId ? this.vertexMap.get(line.startVertexId) : undefined;\n        var previousEnd = line.endVertexId ? this.vertexMap.get(line.endVertexId) : undefined;\n        if (previousStart && previousStart.id !== start.id) {\n            previousStart.detachLine(line.id);\n        }\n        if (previousEnd && previousEnd.id !== end.id) {\n            previousEnd.detachLine(line.id);\n        }\n        line.bindVertices(start, end);\n        start.attachLine(line.id);\n        end.attachLine(line.id);\n    };\n    RDRepository.prototype.bindLineEndpoint = function (line, endpoint, vertex) {\n        if (endpoint === \"origin\") {\n            var previous_1 = line.startVertexId ? this.vertexMap.get(line.startVertexId) : undefined;\n            if (previous_1 && previous_1.id !== vertex.id) {\n                previous_1.detachLine(line.id);\n            }\n            line.bindStartVertex(vertex);\n            vertex.attachLine(line.id);\n            return;\n        }\n        var previous = line.endVertexId ? this.vertexMap.get(line.endVertexId) : undefined;\n        if (previous && previous.id !== vertex.id) {\n            previous.detachLine(line.id);\n        }\n        line.bindEndVertex(vertex);\n        vertex.attachLine(line.id);\n    };\n    RDRepository.prototype.bindLoopCenter = function (loop, vertex) {\n        var previous = loop.centerVertexId ? this.vertexMap.get(loop.centerVertexId) : undefined;\n        if (previous && previous.id !== vertex.id) {\n            previous.detachLoop(loop.id);\n        }\n        loop.bindCenterVertex(vertex);\n        vertex.attachLoop(loop.id);\n    };\n    RDRepository.prototype.mergeVertexInto = function (source, target) {\n        var _this = this;\n        if (source.id === target.id) {\n            return;\n        }\n        this.lineList.forEach(function (line) {\n            if (line.startVertexId === source.id) {\n                _this.bindLineEndpoint(line, \"origin\", target);\n            }\n            if (line.endVertexId === source.id) {\n                _this.bindLineEndpoint(line, \"to\", target);\n            }\n        });\n        this.loopList.forEach(function (loop) {\n            if (loop.centerVertexId === source.id) {\n                _this.bindLoopCenter(loop, target);\n            }\n        });\n        this.vertexList = this.vertexList.filter(function (vertex) { return vertex.id !== source.id; });\n        this.elements = this.elements.filter(function (elem) { return elem.id !== source.id; });\n        this.vertexMap.delete(source.id);\n        this.selectedIds.delete(source.id);\n        this.selectionOrder = this.selectionOrder.filter(function (id) { return id !== source.id; });\n        this.syncSelectionState();\n    };\n    RDRepository.prototype.cleanupDanglingVertices = function () {\n        var _this = this;\n        var used = new Set();\n        this.lineList.forEach(function (line) {\n            if (line.startVertexId) {\n                used.add(line.startVertexId);\n            }\n            if (line.endVertexId) {\n                used.add(line.endVertexId);\n            }\n        });\n        this.loopList.forEach(function (loop) {\n            if (loop.centerVertexId) {\n                used.add(loop.centerVertexId);\n            }\n        });\n        this.vertexList = this.vertexList.filter(function (vertex) { return used.has(vertex.id) || _this.selectedIds.has(vertex.id); });\n        var vertexIds = new Set(this.vertexList.map(function (vertex) { return vertex.id; }));\n        this.elements = this.elements.filter(function (elem) { return !(0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(elem) || vertexIds.has(elem.id); });\n        this.reindexElements();\n        this.syncSelectionState();\n    };\n    RDRepository.prototype.setSelection = function (elements) {\n        var _this = this;\n        this.selectedIds.clear();\n        this.selectionOrder = [];\n        elements.forEach(function (elem) {\n            if (_this.elements.some(function (e) { return e.id === elem.id; })) {\n                _this.selectedIds.add(elem.id);\n                _this.pushSelectionOrder(elem.id);\n            }\n        });\n        this.syncSelectionState();\n    };\n    RDRepository.prototype.toggleSelection = function (elem) {\n        if (this.selectedIds.has(elem.id)) {\n            this.selectedIds.delete(elem.id);\n            this.selectionOrder = this.selectionOrder.filter(function (id) { return id !== elem.id; });\n        }\n        else {\n            this.selectedIds.add(elem.id);\n            this.pushSelectionOrder(elem.id);\n        }\n        this.syncSelectionState();\n    };\n    RDRepository.prototype.selectInRect = function (rect, additive) {\n        var _this = this;\n        var normalized = this.normalizeRect(rect);\n        var matching = this.elements.filter(function (elem) { return _this.intersectsRect(elem, normalized); });\n        if (!additive) {\n            this.selectedIds.clear();\n            this.selectionOrder = [];\n        }\n        matching.forEach(function (elem) {\n            _this.selectedIds.add(elem.id);\n            _this.pushSelectionOrder(elem.id);\n        });\n        this.syncSelectionState();\n    };\n    RDRepository.prototype.normalizeRect = function (rect) {\n        return {\n            x1: Math.min(rect.x1, rect.x2),\n            y1: Math.min(rect.y1, rect.y2),\n            x2: Math.max(rect.x1, rect.x2),\n            y2: Math.max(rect.y1, rect.y2),\n        };\n    };\n    RDRepository.prototype.intersectsRect = function (elem, rect) {\n        var box = this.elementBounds(elem);\n        return !(box.x2 < rect.x1 || box.x1 > rect.x2 || box.y2 < rect.y1 || box.y1 > rect.y2);\n    };\n    RDRepository.prototype.elementBounds = function (elem) {\n        var _this = this;\n        if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(elem)) {\n            return { x1: elem.x, y1: elem.y, x2: elem.x, y2: elem.y };\n        }\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(elem)) {\n            var xs = [elem.origin.x, elem.to.x];\n            var ys = [elem.origin.y, elem.to.y];\n            if (elem.control) {\n                xs.push(elem.control.x);\n                ys.push(elem.control.y);\n            }\n            return {\n                x1: Math.min.apply(Math, xs),\n                y1: Math.min.apply(Math, ys),\n                x2: Math.max.apply(Math, xs),\n                y2: Math.max.apply(Math, ys),\n            };\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(elem)) {\n            return {\n                x1: elem.origin.x - elem.radius,\n                y1: elem.origin.y - elem.radius,\n                x2: elem.origin.x + elem.radius,\n                y2: elem.origin.y + elem.radius,\n            };\n        }\n        if ((0,_Core_MyString__WEBPACK_IMPORTED_MODULE_3__.isString)(elem)) {\n            return { x1: elem.origin.x, y1: elem.origin.y, x2: elem.origin.x, y2: elem.origin.y };\n        }\n        if ((0,_Core_Group__WEBPACK_IMPORTED_MODULE_6__.isGroup)(elem)) {\n            if (elem.elements.length === 0) {\n                return { x1: 0, y1: 0, x2: 0, y2: 0 };\n            }\n            return elem.elements\n                .map(function (child) { return _this.elementBounds(child); })\n                .reduce(function (acc, box) { return ({\n                x1: Math.min(acc.x1, box.x1),\n                y1: Math.min(acc.y1, box.y1),\n                x2: Math.max(acc.x2, box.x2),\n                y2: Math.max(acc.y2, box.y2),\n            }); });\n        }\n        return { x1: -Infinity, y1: -Infinity, x2: Infinity, y2: Infinity };\n    };\n    RDRepository.prototype.pushSelectionOrder = function (id) {\n        this.selectionOrder = this.selectionOrder.filter(function (item) { return item !== id; });\n        this.selectionOrder.push(id);\n    };\n    RDRepository.prototype.syncSelectionState = function () {\n        var _this = this;\n        var elementIds = new Set(this.elements.map(function (e) { return e.id; }));\n        this.selectedIds.forEach(function (id) {\n            if (!elementIds.has(id)) {\n                _this.selectedIds.delete(id);\n            }\n        });\n        this.selectionOrder = this.selectionOrder.filter(function (id) { return _this.selectedIds.has(id) && elementIds.has(id); });\n        var current = this.currentElement();\n        this.currentIndex = current ? this.elements.findIndex(function (e) { return e.id === current.id; }) : undefined;\n        if (this.currentSubId && !elementIds.has(this.currentSubId)) {\n            this.currentSubId = undefined;\n        }\n        var sub = this.currentSubElement();\n        this.currentSubIndex = sub ? this.elements.findIndex(function (e) { return e.id === sub.id; }) : undefined;\n    };\n    RDRepository.prototype.reindexElements = function () {\n        var _this = this;\n        this.vertexList = this.elements.filter(function (elem) {\n            if (!(0,_Core_Vector__WEBPACK_IMPORTED_MODULE_4__.isVector)(elem)) {\n                return false;\n            }\n            if (!(elem instanceof _Core_Vertex__WEBPACK_IMPORTED_MODULE_5__.Vertex)) {\n                Object.setPrototypeOf(elem, _Core_Vertex__WEBPACK_IMPORTED_MODULE_5__.Vertex.prototype);\n                var vertex = elem;\n                if (!vertex.connectedLineIds) {\n                    vertex.connectedLineIds = new Set();\n                }\n                if (!vertex.connectedLoopIds) {\n                    vertex.connectedLoopIds = new Set();\n                }\n            }\n            return true;\n        });\n        this.lineList = this.elements.filter(function (elem) { return (0,_Core_Line__WEBPACK_IMPORTED_MODULE_1__.isLine)(elem); });\n        this.loopList = this.elements.filter(function (elem) { return (0,_Core_Loop__WEBPACK_IMPORTED_MODULE_2__.isLoop)(elem); });\n        this.vertexMap.clear();\n        this.vertexList.forEach(function (vertex) { return _this.vertexMap.set(vertex.id, vertex); });\n    };\n    RDRepository.prototype.rebindGraphReferences = function () {\n        var _this = this;\n        this.vertexList.forEach(function (vertex) {\n            vertex.connectedLineIds.clear();\n            vertex.connectedLoopIds.clear();\n        });\n        this.lineList.forEach(function (line) {\n            var start = line.startVertexId ? _this.vertexMap.get(line.startVertexId) : undefined;\n            var end = line.endVertexId ? _this.vertexMap.get(line.endVertexId) : undefined;\n            if (!start) {\n                start = _this.ensureVertex(line.origin, 0.0);\n            }\n            if (!end) {\n                end = _this.ensureVertex(line.to, 0.0);\n            }\n            _this.bindLineToVertices(line, start, end);\n        });\n        this.loopList.forEach(function (loop) {\n            var center = loop.centerVertexId ? _this.vertexMap.get(loop.centerVertexId) : undefined;\n            if (!center) {\n                center = _this.ensureVertex(loop.origin, 0.0);\n            }\n            _this.bindLoopCenter(loop, center);\n        });\n    };\n    return RDRepository;\n}());\n\n\n\n//# sourceURL=webpack://rdfeyn/./src/UI/RDRepository.ts?");

/***/ }),

/***/ "./src/UI/RepositoryCommand.ts":
/*!*************************************!*\
  !*** ./src/UI/RepositoryCommand.ts ***!
  \*************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"ArrowToggle\": () => (/* binding */ ArrowToggle),\n/* harmony export */   \"ChangeArcAngle\": () => (/* binding */ ChangeArcAngle),\n/* harmony export */   \"ChangeArcEndAngle\": () => (/* binding */ ChangeArcEndAngle),\n/* harmony export */   \"ChangeScale\": () => (/* binding */ ChangeScale),\n/* harmony export */   \"ChangeStyle\": () => (/* binding */ ChangeStyle),\n/* harmony export */   \"ChangeType\": () => (/* binding */ ChangeType),\n/* harmony export */   \"Delete\": () => (/* binding */ Delete),\n/* harmony export */   \"DeleteGroup\": () => (/* binding */ DeleteGroup),\n/* harmony export */   \"Fill\": () => (/* binding */ Fill),\n/* harmony export */   \"GroupSelection\": () => (/* binding */ GroupSelection),\n/* harmony export */   \"Move\": () => (/* binding */ Move),\n/* harmony export */   \"MoveAbsolute\": () => (/* binding */ MoveAbsolute),\n/* harmony export */   \"MoveGroup\": () => (/* binding */ MoveGroup),\n/* harmony export */   \"RotateArrow\": () => (/* binding */ RotateArrow),\n/* harmony export */   \"Rotation\": () => (/* binding */ Rotation),\n/* harmony export */   \"SetArrowRotation\": () => (/* binding */ SetArrowRotation),\n/* harmony export */   \"SetLine\": () => (/* binding */ SetLine),\n/* harmony export */   \"SetLineControlPoint\": () => (/* binding */ SetLineControlPoint),\n/* harmony export */   \"SetLineEndpoint\": () => (/* binding */ SetLineEndpoint),\n/* harmony export */   \"SetLoop\": () => (/* binding */ SetLoop),\n/* harmony export */   \"SetLoopAngles\": () => (/* binding */ SetLoopAngles),\n/* harmony export */   \"SetLoopBeginAngle\": () => (/* binding */ SetLoopBeginAngle),\n/* harmony export */   \"SetLoopEndAngle\": () => (/* binding */ SetLoopEndAngle),\n/* harmony export */   \"SetLoopRadius\": () => (/* binding */ SetLoopRadius),\n/* harmony export */   \"SetString\": () => (/* binding */ SetString),\n/* harmony export */   \"SetVertex\": () => (/* binding */ SetVertex),\n/* harmony export */   \"UngroupSelection\": () => (/* binding */ UngroupSelection)\n/* harmony export */ });\n/* harmony import */ var _Core_Line__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../Core/Line */ \"./src/Core/Line.ts\");\n/* harmony import */ var _Core_Loop__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../Core/Loop */ \"./src/Core/Loop.ts\");\n/* harmony import */ var _Core_MyString__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../Core/MyString */ \"./src/Core/MyString.ts\");\n/* harmony import */ var _Core_Vector__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../Core/Vector */ \"./src/Core/Vector.ts\");\n/* harmony import */ var _Core_Vertex__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../Core/Vertex */ \"./src/Core/Vertex.ts\");\n/* harmony import */ var _Core_Group__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../Core/Group */ \"./src/Core/Group.ts\");\nvar __spreadArray = (undefined && undefined.__spreadArray) || function (to, from, pack) {\n    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {\n        if (ar || !(i in from)) {\n            if (!ar) ar = Array.prototype.slice.call(from, 0, i);\n            ar[i] = from[i];\n        }\n    }\n    return to.concat(ar || Array.prototype.slice.call(from));\n};\n\n\n\n\n\n\nfunction moveTargetTo(target, point) {\n    if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_0__.isLine)(target)) {\n        target.moveAbsolute(point);\n        return;\n    }\n    if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_1__.isLoop)(target)) {\n        target.moveAbsolute(point);\n        return;\n    }\n    if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_3__.isVector)(target)) {\n        target.moveAbsolute(point);\n        return;\n    }\n    if (target instanceof _Core_MyString__WEBPACK_IMPORTED_MODULE_2__.MyString) {\n        target.origin.moveAbsolute(point);\n    }\n}\nfunction anchorPoint(target) {\n    if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_0__.isLine)(target)) {\n        return target.center();\n    }\n    if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_1__.isLoop)(target)) {\n        return target.origin.copy();\n    }\n    if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_3__.isVector)(target)) {\n        return target.copy();\n    }\n    if (target instanceof _Core_MyString__WEBPACK_IMPORTED_MODULE_2__.MyString) {\n        return target.origin.copy();\n    }\n    return new _Core_Vector__WEBPACK_IMPORTED_MODULE_3__.Vector(0, 0);\n}\nvar SetVertex = /** @class */ (function () {\n    function SetVertex(vertex) {\n        if (vertex instanceof _Core_Vertex__WEBPACK_IMPORTED_MODULE_4__.Vertex) {\n            this.vertex = vertex;\n            this.copyVertex = vertex.copy();\n            return;\n        }\n        this.vertex = new _Core_Vertex__WEBPACK_IMPORTED_MODULE_4__.Vertex(vertex.x, vertex.y);\n        this.vertex.id = vertex.id;\n        this.copyVertex = this.vertex.copy();\n    }\n    SetVertex.prototype.action = function (repo) {\n        repo.vertexList.push(this.copyVertex);\n        repo.elements.push(this.copyVertex);\n        repo.currentIndex = repo.elements.length - 1;\n    };\n    SetVertex.prototype.unaction = function (repo) {\n        repo.vertexList.splice(repo.vertexList.indexOf(this.copyVertex), 1);\n        repo.elements.splice(repo.elements.indexOf(this.copyVertex), 1);\n    };\n    return SetVertex;\n}());\n\nvar SetLine = /** @class */ (function () {\n    function SetLine(line) {\n        this.line = line;\n        this.copyLine = line.copy();\n    }\n    SetLine.prototype.action = function (repo) {\n        repo.lineList.push(this.copyLine);\n        repo.elements.push(this.copyLine);\n        repo.currentIndex = repo.elements.length - 1;\n    };\n    SetLine.prototype.unaction = function (repo) {\n        repo.lineList.splice(repo.lineList.indexOf(this.copyLine), 1);\n        repo.elements.splice(repo.elements.indexOf(this.copyLine), 1);\n    };\n    return SetLine;\n}());\n\nvar SetString = /** @class */ (function () {\n    function SetString(str) {\n        this.mystring = str;\n        this.copyMyString = str.copy();\n    }\n    SetString.prototype.action = function (repo) {\n        repo.elements.push(this.copyMyString);\n        repo.currentIndex = repo.elements.length - 1;\n    };\n    SetString.prototype.unaction = function (repo) {\n        repo.elements.splice(repo.elements.indexOf(this.copyMyString), 1);\n    };\n    return SetString;\n}());\n\nvar SetLoop = /** @class */ (function () {\n    function SetLoop(loop) {\n        this.loop = loop;\n        this.copyLoop = loop.copy();\n    }\n    SetLoop.prototype.action = function (repo) {\n        repo.loopList.push(this.copyLoop);\n        repo.elements.push(this.copyLoop);\n        repo.currentIndex = repo.elements.length - 1;\n    };\n    SetLoop.prototype.unaction = function (repo) {\n        repo.loopList.splice(repo.loopList.indexOf(this.copyLoop), 1);\n        repo.elements.splice(repo.elements.indexOf(this.copyLoop), 1);\n    };\n    return SetLoop;\n}());\n\nvar Delete = /** @class */ (function () {\n    function Delete(target) {\n        this.index = -1;\n        this.target = target;\n    }\n    Delete.prototype.action = function (repo) {\n        this.index = repo.elements.indexOf(this.target);\n        if (this.index === -1) {\n            return;\n        }\n        repo.elements.splice(this.index, 1);\n        if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_3__.isVector)(this.target)) {\n            var idx = repo.vertexList.indexOf(this.target);\n            if (idx !== -1) {\n                repo.vertexList.splice(idx, 1);\n            }\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_1__.isLoop)(this.target)) {\n            var idx = repo.loopList.indexOf(this.target);\n            if (idx !== -1) {\n                repo.loopList.splice(idx, 1);\n            }\n        }\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_0__.isLine)(this.target)) {\n            var idx = repo.lineList.indexOf(this.target);\n            if (idx !== -1) {\n                repo.lineList.splice(idx, 1);\n            }\n        }\n    };\n    Delete.prototype.unaction = function (repo) {\n        var insertIndex = this.index >= 0 ? Math.min(this.index, repo.elements.length) : repo.elements.length;\n        repo.elements.splice(insertIndex, 0, this.target);\n        if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_3__.isVector)(this.target)) {\n            if (!repo.vertexList.includes(this.target)) {\n                repo.vertexList.push(this.target);\n            }\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_1__.isLoop)(this.target)) {\n            if (!repo.loopList.includes(this.target)) {\n                repo.loopList.push(this.target);\n            }\n        }\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_0__.isLine)(this.target)) {\n            if (!repo.lineList.includes(this.target)) {\n                repo.lineList.push(this.target);\n            }\n        }\n    };\n    return Delete;\n}());\n\nvar Move = /** @class */ (function () {\n    function Move(target, delta) {\n        this.target = target;\n        this.delta = delta;\n    }\n    Move.prototype.action = function (repo) {\n        this.target.move(this.delta);\n    };\n    Move.prototype.unaction = function (repo) {\n        this.target.move(this.delta.multi(-1));\n    };\n    return Move;\n}());\n\nvar MoveAbsolute = /** @class */ (function () {\n    function MoveAbsolute(target, location) {\n        this.target = target;\n        this.location = location;\n        this.before = anchorPoint(target);\n    }\n    MoveAbsolute.prototype.action = function (repo) {\n        moveTargetTo(this.target, this.location);\n    };\n    MoveAbsolute.prototype.unaction = function (repo) {\n        moveTargetTo(this.target, this.before);\n    };\n    return MoveAbsolute;\n}());\n\nvar Rotation = /** @class */ (function () {\n    function Rotation(target, delta) {\n        this.target = target;\n        this.delta = delta;\n    }\n    Rotation.prototype.action = function (repo) {\n        this.target.rotation(this.delta);\n    };\n    Rotation.prototype.unaction = function (repo) {\n        this.target.rotation(-this.delta);\n    };\n    return Rotation;\n}());\n\nvar ChangeScale = /** @class */ (function () {\n    function ChangeScale(target, delta) {\n        this.target = target;\n        this.delta = delta;\n    }\n    ChangeScale.prototype.action = function (repo) {\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_0__.isLine)(this.target)) {\n            this.target.to = this.target.to.add(this.target.directionUnit().multi(this.delta));\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_1__.isLoop)(this.target)) {\n            this.target.setRadius(this.target.radius + this.delta * 1);\n        }\n    };\n    ChangeScale.prototype.unaction = function (repo) {\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_0__.isLine)(this.target)) {\n            this.target.to = this.target.to.add(this.target.directionUnit().multi(-this.delta));\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_1__.isLoop)(this.target)) {\n            this.target.setRadius(this.target.radius - this.delta * 1);\n        }\n    };\n    return ChangeScale;\n}());\n\nvar ChangeArcAngle = /** @class */ (function () {\n    function ChangeArcAngle(target, delta) {\n        this.target = target;\n        this.delta = delta;\n        this.angleBefore = target.loopBeginAngle;\n    }\n    ChangeArcAngle.prototype.action = function (repo) {\n        this.target.setLoopBeginAngle(this.target.loopBeginAngle + this.delta);\n    };\n    ChangeArcAngle.prototype.unaction = function (repo) {\n        // this.target.setLoopBeginAngle(this.target.loopBeginAngle - this.delta);\n        this.target.setLoopBeginAngle(this.angleBefore);\n    };\n    return ChangeArcAngle;\n}());\n\nvar ChangeArcEndAngle = /** @class */ (function () {\n    function ChangeArcEndAngle(target, delta) {\n        this.target = target;\n        this.delta = delta;\n        this.angleBefore = target.loopEndAngle;\n    }\n    ChangeArcEndAngle.prototype.action = function (repo) {\n        this.target.setLoopEndAngle(this.target.loopEndAngle + this.delta);\n    };\n    ChangeArcEndAngle.prototype.unaction = function (repo) {\n        // this.target.setLoopEndAngle(this.target.loopEndAngle - this.delta);\n        this.target.setLoopEndAngle(this.angleBefore);\n    };\n    return ChangeArcEndAngle;\n}());\n\nvar Fill = /** @class */ (function () {\n    function Fill(target) {\n        this.target = target;\n    }\n    Fill.prototype.action = function (repo) {\n        this.target.fill = !this.target.fill;\n    };\n    Fill.prototype.unaction = function (repo) {\n        this.action(repo);\n    };\n    return Fill;\n}());\n\nvar ArrowToggle = /** @class */ (function () {\n    function ArrowToggle(target) {\n        this.target = target;\n    }\n    ArrowToggle.prototype.action = function (repo) {\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_0__.isLine)(this.target)) {\n            this.target.allow = !this.target.allow;\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_1__.isLoop)(this.target)) {\n            this.target.allow = !this.target.allow;\n        }\n    };\n    ArrowToggle.prototype.unaction = function (repo) {\n        this.action(repo);\n    };\n    return ArrowToggle;\n}());\n\nvar ChangeType = /** @class */ (function () {\n    function ChangeType(target) {\n        this.target = target;\n    }\n    ChangeType.prototype.action = function (repo) {\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_0__.isLine)(this.target)) {\n            this.target.toggle();\n        }\n    };\n    ChangeType.prototype.unaction = function (repo) {\n        this.action(repo);\n    };\n    return ChangeType;\n}());\n\nvar RotateArrow = /** @class */ (function () {\n    function RotateArrow(targets, delta) {\n        this.targets = targets;\n        this.before = targets.map(function (line) { var _a; return (_a = line.arrowRotation) !== null && _a !== void 0 ? _a : 0; });\n        this.delta = delta;\n    }\n    RotateArrow.prototype.action = function (repo) {\n        var _this = this;\n        this.targets.forEach(function (line, index) {\n            line.arrowRotation = _this.before[index] + _this.delta;\n        });\n    };\n    RotateArrow.prototype.unaction = function (repo) {\n        var _this = this;\n        this.targets.forEach(function (line, index) {\n            line.arrowRotation = _this.before[index];\n        });\n    };\n    return RotateArrow;\n}());\n\nvar SetArrowRotation = /** @class */ (function () {\n    function SetArrowRotation(targets, after) {\n        this.targets = targets;\n        this.before = targets.map(function (line) { var _a; return (_a = line.arrowRotation) !== null && _a !== void 0 ? _a : 0; });\n        if (Array.isArray(after)) {\n            this.after = after;\n        }\n        else {\n            this.after = targets.map(function () { return after; });\n        }\n    }\n    SetArrowRotation.prototype.action = function (repo) {\n        var _this = this;\n        this.targets.forEach(function (line, index) {\n            line.arrowRotation = _this.after[index];\n        });\n    };\n    SetArrowRotation.prototype.unaction = function (repo) {\n        var _this = this;\n        this.targets.forEach(function (line, index) {\n            line.arrowRotation = _this.before[index];\n        });\n    };\n    return SetArrowRotation;\n}());\n\nvar ChangeStyle = /** @class */ (function () {\n    function ChangeStyle(target) {\n        this.styleBefore = \"normal\";\n        this.styleAfter = \"normal\";\n        this.target = target;\n        this.styleBefore = target.style;\n        if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_0__.isLine)(target)) {\n            if (this.styleBefore == \"normal\") {\n                this.styleAfter = \"dash\";\n            }\n            if (this.styleBefore == \"dash\") {\n                this.styleAfter = \"wave\";\n            }\n            if (this.styleBefore == \"wave\") {\n                this.styleAfter = \"coil\";\n            }\n            if (this.styleBefore == \"coil\") {\n                this.styleAfter = \"double\";\n            }\n            if (this.styleBefore == \"double\") {\n                this.styleAfter = \"normal\";\n            }\n        }\n        if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_1__.isLoop)(target)) {\n            if (this.styleBefore == \"normal\") {\n                this.styleAfter = \"dash\";\n            }\n            if (this.styleBefore == \"dash\") {\n                this.styleAfter = \"wave\";\n            }\n            if (this.styleBefore == \"wave\") {\n                this.styleAfter = \"coil\";\n            }\n            if (this.styleBefore == \"coil\") {\n                this.styleAfter = \"normal\";\n            }\n        }\n    }\n    ChangeStyle.prototype.action = function (repo) {\n        this.target.style = this.styleAfter;\n    };\n    ChangeStyle.prototype.unaction = function (repo) {\n        this.target.style = this.styleBefore;\n    };\n    return ChangeStyle;\n}());\n\nvar MoveGroup = /** @class */ (function () {\n    function MoveGroup(targets, delta) {\n        this.targets = targets;\n        this.delta = delta;\n    }\n    MoveGroup.prototype.action = function (repo) {\n        var _this = this;\n        this.targets.forEach(function (target) {\n            target.move(_this.delta);\n        });\n    };\n    MoveGroup.prototype.unaction = function (repo) {\n        var _this = this;\n        this.targets.forEach(function (target) {\n            target.move(_this.delta.multi(-1));\n        });\n    };\n    return MoveGroup;\n}());\n\nvar DeleteGroup = /** @class */ (function () {\n    function DeleteGroup(targets) {\n        this.snapshots = [];\n        this.targets = targets;\n    }\n    DeleteGroup.prototype.action = function (repo) {\n        this.snapshots = this.targets\n            .map(function (target) { return ({ elem: target, index: repo.elements.indexOf(target) }); })\n            .filter(function (snapshot) { return snapshot.index !== -1; })\n            .sort(function (a, b) { return a.index - b.index; });\n        __spreadArray([], this.snapshots, true).sort(function (a, b) { return b.index - a.index; })\n            .forEach(function (_a) {\n            var elem = _a.elem, index = _a.index;\n            repo.elements.splice(index, 1);\n            if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_3__.isVector)(elem)) {\n                var idx = repo.vertexList.indexOf(elem);\n                if (idx !== -1) {\n                    repo.vertexList.splice(idx, 1);\n                }\n            }\n            if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_1__.isLoop)(elem)) {\n                var idx = repo.loopList.indexOf(elem);\n                if (idx !== -1) {\n                    repo.loopList.splice(idx, 1);\n                }\n            }\n            if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_0__.isLine)(elem)) {\n                var idx = repo.lineList.indexOf(elem);\n                if (idx !== -1) {\n                    repo.lineList.splice(idx, 1);\n                }\n            }\n        });\n    };\n    DeleteGroup.prototype.unaction = function (repo) {\n        this.snapshots\n            .sort(function (a, b) { return a.index - b.index; })\n            .forEach(function (_a) {\n            var elem = _a.elem, index = _a.index;\n            repo.elements.splice(index, 0, elem);\n            if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_3__.isVector)(elem) && !repo.vertexList.includes(elem)) {\n                repo.vertexList.push(elem);\n            }\n            if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_1__.isLoop)(elem) && !repo.loopList.includes(elem)) {\n                repo.loopList.push(elem);\n            }\n            if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_0__.isLine)(elem) && !repo.lineList.includes(elem)) {\n                repo.lineList.push(elem);\n            }\n        });\n    };\n    return DeleteGroup;\n}());\n\nvar GroupSelection = /** @class */ (function () {\n    function GroupSelection(targets) {\n        this.snapshots = [];\n        this.targets = targets;\n    }\n    GroupSelection.prototype.action = function (repo) {\n        var _a;\n        this.snapshots = this.targets\n            .map(function (target) { return ({ elem: target, index: repo.elements.indexOf(target) }); })\n            .filter(function (snapshot) { return snapshot.index !== -1; })\n            .sort(function (a, b) { return a.index - b.index; });\n        if (this.snapshots.length < 2) {\n            return;\n        }\n        var groupedElements = this.snapshots.map(function (snapshot) { return snapshot.elem; });\n        this.group = (_a = this.group) !== null && _a !== void 0 ? _a : new _Core_Group__WEBPACK_IMPORTED_MODULE_5__.Group(groupedElements);\n        this.group.elements = groupedElements;\n        __spreadArray([], this.snapshots, true).sort(function (a, b) { return b.index - a.index; })\n            .forEach(function (_a) {\n            var elem = _a.elem, index = _a.index;\n            repo.elements.splice(index, 1);\n            if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_3__.isVector)(elem)) {\n                var idx = repo.vertexList.indexOf(elem);\n                if (idx !== -1) {\n                    repo.vertexList.splice(idx, 1);\n                }\n            }\n            if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_1__.isLoop)(elem)) {\n                var idx = repo.loopList.indexOf(elem);\n                if (idx !== -1) {\n                    repo.loopList.splice(idx, 1);\n                }\n            }\n            if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_0__.isLine)(elem)) {\n                var idx = repo.lineList.indexOf(elem);\n                if (idx !== -1) {\n                    repo.lineList.splice(idx, 1);\n                }\n            }\n        });\n        repo.elements.splice(this.snapshots[0].index, 0, this.group);\n        repo.setSelection([this.group]);\n    };\n    GroupSelection.prototype.unaction = function (repo) {\n        if (!this.group) {\n            return;\n        }\n        var groupIndex = repo.elements.indexOf(this.group);\n        if (groupIndex !== -1) {\n            repo.elements.splice(groupIndex, 1);\n        }\n        this.snapshots\n            .sort(function (a, b) { return a.index - b.index; })\n            .forEach(function (_a) {\n            var elem = _a.elem, index = _a.index;\n            var insertIndex = Math.min(index, repo.elements.length);\n            repo.elements.splice(insertIndex, 0, elem);\n            if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_3__.isVector)(elem) && !repo.vertexList.includes(elem)) {\n                repo.vertexList.push(elem);\n            }\n            if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_1__.isLoop)(elem) && !repo.loopList.includes(elem)) {\n                repo.loopList.push(elem);\n            }\n            if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_0__.isLine)(elem) && !repo.lineList.includes(elem)) {\n                repo.lineList.push(elem);\n            }\n        });\n        repo.setSelection(this.snapshots.map(function (snapshot) { return snapshot.elem; }));\n    };\n    return GroupSelection;\n}());\n\nvar UngroupSelection = /** @class */ (function () {\n    function UngroupSelection(group) {\n        this.index = -1;\n        this.elements = [];\n        this.group = group;\n        this.elements = __spreadArray([], group.elements, true);\n    }\n    UngroupSelection.prototype.action = function (repo) {\n        var _a;\n        this.index = repo.elements.indexOf(this.group);\n        if (this.index === -1) {\n            return;\n        }\n        (_a = repo.elements).splice.apply(_a, __spreadArray([this.index, 1], this.elements, false));\n        this.elements.forEach(function (elem) {\n            if ((0,_Core_Group__WEBPACK_IMPORTED_MODULE_5__.isGroup)(elem)) {\n                return;\n            }\n            if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_3__.isVector)(elem) && !repo.vertexList.includes(elem)) {\n                repo.vertexList.push(elem);\n            }\n            if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_1__.isLoop)(elem) && !repo.loopList.includes(elem)) {\n                repo.loopList.push(elem);\n            }\n            if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_0__.isLine)(elem) && !repo.lineList.includes(elem)) {\n                repo.lineList.push(elem);\n            }\n        });\n        repo.setSelection(this.elements);\n    };\n    UngroupSelection.prototype.unaction = function (repo) {\n        if (this.index === -1) {\n            return;\n        }\n        var firstIndex = repo.elements.indexOf(this.elements[0]);\n        if (firstIndex === -1) {\n            return;\n        }\n        repo.elements.splice(firstIndex, this.elements.length, this.group);\n        this.elements.forEach(function (elem) {\n            if ((0,_Core_Vector__WEBPACK_IMPORTED_MODULE_3__.isVector)(elem)) {\n                var idx = repo.vertexList.indexOf(elem);\n                if (idx !== -1) {\n                    repo.vertexList.splice(idx, 1);\n                }\n            }\n            if ((0,_Core_Loop__WEBPACK_IMPORTED_MODULE_1__.isLoop)(elem)) {\n                var idx = repo.loopList.indexOf(elem);\n                if (idx !== -1) {\n                    repo.loopList.splice(idx, 1);\n                }\n            }\n            if ((0,_Core_Line__WEBPACK_IMPORTED_MODULE_0__.isLine)(elem)) {\n                var idx = repo.lineList.indexOf(elem);\n                if (idx !== -1) {\n                    repo.lineList.splice(idx, 1);\n                }\n            }\n        });\n        repo.setSelection([this.group]);\n    };\n    return UngroupSelection;\n}());\n\nvar SetLoopRadius = /** @class */ (function () {\n    function SetLoopRadius(target, after) {\n        this.target = target;\n        this.before = target.radius;\n        this.after = after;\n    }\n    SetLoopRadius.prototype.action = function (repo) {\n        this.target.setRadius(this.after);\n    };\n    SetLoopRadius.prototype.unaction = function (repo) {\n        this.target.setRadius(this.before);\n    };\n    return SetLoopRadius;\n}());\n\nvar SetLoopBeginAngle = /** @class */ (function () {\n    function SetLoopBeginAngle(target, after) {\n        this.target = target;\n        this.before = target.loopBeginAngle;\n        this.after = after;\n    }\n    SetLoopBeginAngle.prototype.action = function (repo) {\n        this.target.setLoopBeginAngle(this.after);\n    };\n    SetLoopBeginAngle.prototype.unaction = function (repo) {\n        this.target.setLoopBeginAngle(this.before);\n    };\n    return SetLoopBeginAngle;\n}());\n\nvar SetLoopEndAngle = /** @class */ (function () {\n    function SetLoopEndAngle(target, after) {\n        this.target = target;\n        this.before = target.loopEndAngle;\n        this.after = after;\n    }\n    SetLoopEndAngle.prototype.action = function (repo) {\n        this.target.setLoopEndAngle(this.after);\n    };\n    SetLoopEndAngle.prototype.unaction = function (repo) {\n        this.target.setLoopEndAngle(this.before);\n    };\n    return SetLoopEndAngle;\n}());\n\nvar SetLoopAngles = /** @class */ (function () {\n    function SetLoopAngles(target, afterStart, afterEnd) {\n        this.target = target;\n        this.beforeStart = target.loopBeginAngle;\n        this.beforeEnd = target.loopEndAngle;\n        this.afterStart = afterStart;\n        this.afterEnd = afterEnd;\n    }\n    SetLoopAngles.prototype.action = function (repo) {\n        this.target.setLoopBeginAngle(this.afterStart);\n        this.target.setLoopEndAngle(this.afterEnd);\n    };\n    SetLoopAngles.prototype.unaction = function (repo) {\n        this.target.setLoopBeginAngle(this.beforeStart);\n        this.target.setLoopEndAngle(this.beforeEnd);\n    };\n    return SetLoopAngles;\n}());\n\nvar SetLineEndpoint = /** @class */ (function () {\n    function SetLineEndpoint(line, endpoint, after) {\n        this.line = line;\n        this.endpoint = endpoint;\n        this.before = line[endpoint].copy();\n        this.after = after.copy();\n        this.beforeVertexId = endpoint === \"origin\" ? line.startVertexId : line.endVertexId;\n        this.afterVertexId = after.id;\n    }\n    SetLineEndpoint.prototype.action = function (repo) {\n        if (this.afterVertexId) {\n            var vertex = repo.getVertex(this.afterVertexId);\n            if (vertex) {\n                repo.bindLineEndpoint(this.line, this.endpoint, vertex);\n                return;\n            }\n        }\n        this.line[this.endpoint].moveAbsolute(this.after);\n    };\n    SetLineEndpoint.prototype.unaction = function (repo) {\n        if (this.beforeVertexId) {\n            var vertex = repo.getVertex(this.beforeVertexId);\n            if (vertex) {\n                repo.bindLineEndpoint(this.line, this.endpoint, vertex);\n                return;\n            }\n        }\n        this.line[this.endpoint].moveAbsolute(this.before);\n    };\n    return SetLineEndpoint;\n}());\n\nvar SetLineControlPoint = /** @class */ (function () {\n    function SetLineControlPoint(line, after) {\n        this.line = line;\n        this.before = line.control ? line.control.copy() : null;\n        this.after = after ? after.copy() : null;\n    }\n    SetLineControlPoint.prototype.action = function (repo) {\n        this.line.control = this.after ? this.after.copy() : null;\n    };\n    SetLineControlPoint.prototype.unaction = function (repo) {\n        this.line.control = this.before ? this.before.copy() : null;\n    };\n    return SetLineControlPoint;\n}());\n\n\n\n//# sourceURL=webpack://rdfeyn/./src/UI/RepositoryCommand.ts?");

/***/ }),

/***/ "./src/UI/UIColor.ts":
/*!***************************!*\
  !*** ./src/UI/UIColor.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"getColor\": () => (/* binding */ getColor)\n/* harmony export */ });\nfunction getColor(color) {\n    if (color == \"normal\") {\n        return \"rgb(0,0,0)\";\n    }\n    if (color == \"select\") {\n        return \"rgb(255,0,0)\";\n    }\n    if (color == \"sub\") {\n        return \"rgb(0,255,0)\";\n    }\n    return \"rgb(0,0,0)\";\n}\n\n\n//# sourceURL=webpack://rdfeyn/./src/UI/UIColor.ts?");

/***/ }),

/***/ "./src/UI/draw.ts":
/*!************************!*\
  !*** ./src/UI/draw.ts ***!
  \************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"draw\": () => (/* binding */ draw),\n/* harmony export */   \"drawAllow\": () => (/* binding */ drawAllow),\n/* harmony export */   \"drawCoilLine\": () => (/* binding */ drawCoilLine),\n/* harmony export */   \"drawCoilLoop\": () => (/* binding */ drawCoilLoop),\n/* harmony export */   \"drawDoubleLine\": () => (/* binding */ drawDoubleLine),\n/* harmony export */   \"drawLine\": () => (/* binding */ drawLine),\n/* harmony export */   \"drawLoop\": () => (/* binding */ drawLoop),\n/* harmony export */   \"drawNormalLine\": () => (/* binding */ drawNormalLine),\n/* harmony export */   \"drawPoint\": () => (/* binding */ drawPoint),\n/* harmony export */   \"drawWaveLine\": () => (/* binding */ drawWaveLine),\n/* harmony export */   \"drawWaveLoop\": () => (/* binding */ drawWaveLoop)\n/* harmony export */ });\n/* harmony import */ var _Config__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../Config */ \"./src/Config.ts\");\n/* harmony import */ var _Core_Group__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../Core/Group */ \"./src/Core/Group.ts\");\n/* harmony import */ var _Core_Line__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../Core/Line */ \"./src/Core/Line.ts\");\n/* harmony import */ var _Core_TextPosition__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../Core/TextPosition */ \"./src/Core/TextPosition.ts\");\n/* harmony import */ var _Core_Vector__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../Core/Vector */ \"./src/Core/Vector.ts\");\n\n\n\n\n\nvar CURVED_LINE_SEGMENTS = 48;\nvar EPSILON = 1e-6;\nfunction lineDirectionAt(line, t) {\n    var tangent = line.tangentAt(t);\n    if (tangent.length() < EPSILON) {\n        tangent = line.direction();\n    }\n    var length = tangent.length();\n    if (length < EPSILON) {\n        return new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(1, 0);\n    }\n    return tangent.multi(1 / length);\n}\nfunction lineNormalAt(line, t) {\n    var direction = lineDirectionAt(line, t);\n    return direction.rotation(Math.PI / 2);\n}\nfunction sampleLinePoints(line, segments) {\n    if (segments === void 0) { segments = line.control ? CURVED_LINE_SEGMENTS : 1; }\n    var count = Math.max(1, segments);\n    var points = [];\n    for (var i = 0; i <= count; i++) {\n        var t = count === 0 ? 0 : i / count;\n        points.push(line.pointAt(t));\n    }\n    return points;\n}\nfunction computeCumulativeLengths(points) {\n    var cumulative = new Array(points.length).fill(0);\n    var total = 0;\n    for (var i = 1; i < points.length; i++) {\n        var segmentLength = points[i].minus(points[i - 1]).length();\n        total += segmentLength;\n        cumulative[i] = total;\n    }\n    return { cumulative: cumulative, total: total };\n}\nfunction sampleOffsetLinePoints(line, offset, segments) {\n    if (segments === void 0) { segments = line.control ? CURVED_LINE_SEGMENTS : 1; }\n    var count = Math.max(1, segments);\n    var points = [];\n    for (var i = 0; i <= count; i++) {\n        var t = count === 0 ? 0 : i / count;\n        var basePoint = line.pointAt(t);\n        var normal = lineNormalAt(line, t);\n        var offsetVector = normal.multi(offset);\n        points.push(basePoint.add(offsetVector));\n    }\n    return points;\n}\nfunction tracePolyline(drawContext, points, style) {\n    if (points.length < 2) {\n        return;\n    }\n    drawContext.moveTo(points[0].x, points[0].y);\n    for (var i = 1; i < points.length; i++) {\n        drawContext.lineTo(points[i].x, points[i].y, style);\n    }\n}\nfunction lineMidDirection(line) {\n    return lineDirectionAt(line, 0.5);\n}\nfunction sampleCoilPoints(line) {\n    var segmentLength = 1.0;\n    var aspect = 0.9;\n    var amplitude = 0.5;\n    var segments = line.control ? CURVED_LINE_SEGMENTS * 4 : Math.max(32, Math.ceil(line.length() * 18));\n    var basePoints = sampleLinePoints(line, segments);\n    var _a = computeCumulativeLengths(basePoints), cumulative = _a.cumulative, total = _a.total;\n    if (total < segmentLength) {\n        return basePoints;\n    }\n    var turns = Math.max(1, Math.floor(total / segmentLength));\n    var coilPoints = [];\n    for (var i = 0; i < basePoints.length; i++) {\n        var s = cumulative[i];\n        var tNorm = segments === 0 ? 0 : i / segments;\n        var tangent = lineDirectionAt(line, tNorm);\n        var normal = lineNormalAt(line, tNorm);\n        var phase = (s / total) * (turns - 0.5) * 2 * Math.PI;\n        var u = aspect * amplitude * Math.cos(Math.PI - phase) - aspect * amplitude * ((2 * s) / total - 1);\n        var v = amplitude * Math.sin(Math.PI - phase);\n        coilPoints.push(basePoints[i]\n            .add(tangent.multi(u))\n            .add(normal.multi(v)));\n    }\n    return coilPoints;\n}\n/**\n * draw is the main function to draw an element.\n * @param drawContext the draw context\n * @param elem the element to draw\n * @param exportType the export type\n * @param color the color\n */\nfunction draw(drawContext, elem, exportType, color) {\n    if (color === void 0) { color = \"normal\"; }\n    if (elem.shape == \"Line\") {\n        drawLine(drawContext, elem, exportType, color);\n        return;\n    }\n    if (elem.shape == \"Loop\") {\n        drawLoop(drawContext, elem, exportType, color);\n        return;\n    }\n    if (elem.shape == \"Point\") {\n        drawPoint(drawContext, elem, exportType, color);\n        return;\n    }\n    if (elem.shape == \"String\") {\n        drawText(drawContext, elem, exportType, color);\n        return;\n    }\n    if ((0,_Core_Group__WEBPACK_IMPORTED_MODULE_1__.isGroup)(elem)) {\n        elem.elements.forEach(function (elem) {\n            draw(drawContext, elem, exportType, color);\n        });\n        return;\n    }\n}\n/**\n * draw DoubleLine\n */\nfunction drawDoubleLine(drawContext, line, exportType, color) {\n    if (color === void 0) { color = \"normal\"; }\n    var offset = 0.1;\n    var segments = line.control ? CURVED_LINE_SEGMENTS : 1;\n    var outer = sampleOffsetLinePoints(line, offset, segments);\n    var inner = sampleOffsetLinePoints(line, -offset, segments);\n    drawContext.beginPath();\n    drawContext.setStrokeColor(color);\n    tracePolyline(drawContext, outer, line.style);\n    drawContext.stroke();\n    drawContext.closePath();\n    drawContext.beginPath();\n    drawContext.setStrokeColor(color);\n    tracePolyline(drawContext, inner, line.style);\n    drawContext.stroke();\n    drawContext.closePath();\n    if (line.allow) {\n        drawAllow(drawContext, line, exportType);\n    }\n    if (line.label) {\n        var diff = 1.0 + line.labelDiff;\n        var midDirection = lineMidDirection(line);\n        var labelNormal = midDirection.rotation(Math.PI / 2);\n        var pos = line.center().add(labelNormal.multi(diff));\n        var position = (0,_Core_TextPosition__WEBPACK_IMPORTED_MODULE_3__.textPosition)(line.label, pos, _Config__WEBPACK_IMPORTED_MODULE_0__.config);\n        drawContext.fillText(line.label, position.x, position.y);\n    }\n    drawContext.closePath();\n    // drawContext.setLineDash([])\n}\n/**\n * draw a line\n */\nfunction drawNormalLine(drawContext, line, exportType, color) {\n    if (color === void 0) { color = \"normal\"; }\n    drawContext.beginPath();\n    drawContext.setStrokeColor(color);\n    var linestyle = line.style;\n    var segments = line.control ? CURVED_LINE_SEGMENTS : 1;\n    var points = sampleLinePoints(line, segments);\n    tracePolyline(drawContext, points, linestyle);\n    drawContext.stroke();\n    if (line.allow) {\n        drawAllow(drawContext, line, exportType);\n    }\n    if (line.label) {\n        var diff = 1.0 + line.labelDiff;\n        var midDirection = lineMidDirection(line);\n        var labelNormal = midDirection.rotation(Math.PI / 2);\n        var pos = line.center().add(labelNormal.multi(diff));\n        var position = (0,_Core_TextPosition__WEBPACK_IMPORTED_MODULE_3__.textPosition)(line.label, pos, _Config__WEBPACK_IMPORTED_MODULE_0__.config);\n        drawContext.fillText(line.label, position.x, position.y);\n    }\n    drawContext.closePath();\n    // drawContext.setLineDash([])\n}\nfunction drawWaveLine(drawContext, line, exportType, color) {\n    if (color === void 0) { color = \"normal\"; }\n    if (!line.control) {\n        drawContext.beginPath();\n        var origin_1 = line.origin;\n        var unitVec = line.directionUnit();\n        var perpVec = unitVec.rotation(Math.PI / 2);\n        drawContext.setStrokeColor(color);\n        var lineStyle = \"normal\";\n        if (line.style == \"dash\") {\n            lineStyle = \"dash\";\n        }\n        drawContext.moveTo(origin_1.x, origin_1.y);\n        for (var l = 0; l < line.length(); l += 0.1) {\n            var offset = Math.sin(l * 5) * 3 / 15;\n            var x = origin_1.x + unitVec.x * l + perpVec.x * offset;\n            var y = origin_1.y + unitVec.y * l + perpVec.y * offset;\n            drawContext.lineTo(x, y, lineStyle);\n            drawContext.moveTo(x, y);\n            drawContext.stroke();\n        }\n        if (line.allow) {\n            drawAllow(drawContext, line, exportType);\n        }\n        if (line.label) {\n            var diff = 1.0 + line.labelDiff;\n            var midDirection = lineMidDirection(line);\n            var pos = line.center().add(midDirection.rotation(Math.PI / 2).multi(diff));\n            var position = (0,_Core_TextPosition__WEBPACK_IMPORTED_MODULE_3__.textPosition)(line.label, pos, _Config__WEBPACK_IMPORTED_MODULE_0__.config);\n            drawContext.fillText(line.label, position.x, position.y);\n        }\n        drawContext.closePath();\n        return;\n    }\n    var baseSegments = CURVED_LINE_SEGMENTS * 3;\n    var basePoints = sampleLinePoints(line, baseSegments);\n    var _a = computeCumulativeLengths(basePoints), cumulative = _a.cumulative, total = _a.total;\n    var amplitude = 0.2;\n    var frequency = 5;\n    var wavePoints = basePoints.map(function (point, index) {\n        if (total < EPSILON) {\n            return point.copy();\n        }\n        var t = baseSegments === 0 ? 0 : index / baseSegments;\n        var normal = lineNormalAt(line, t);\n        var offset = Math.sin(cumulative[index] * frequency) * amplitude;\n        return point.add(normal.multi(offset));\n    });\n    drawContext.beginPath();\n    drawContext.setStrokeColor(color);\n    tracePolyline(drawContext, wavePoints, \"normal\");\n    drawContext.stroke();\n    if (line.allow) {\n        drawAllow(drawContext, line, exportType);\n    }\n    if (line.label) {\n        var diff = 1.0 + line.labelDiff;\n        var midDirection = lineMidDirection(line);\n        var pos = line.center().add(midDirection.rotation(Math.PI / 2).multi(diff));\n        var position = (0,_Core_TextPosition__WEBPACK_IMPORTED_MODULE_3__.textPosition)(line.label, pos, _Config__WEBPACK_IMPORTED_MODULE_0__.config);\n        drawContext.fillText(line.label, position.x, position.y);\n    }\n    drawContext.closePath();\n}\n/**\n * draw a coil line\n */\nfunction drawCoilLine(drawContext, line, exportType, color) {\n    if (color === void 0) { color = \"normal\"; }\n    var coilPoints = sampleCoilPoints(line);\n    drawContext.beginPath();\n    drawContext.setStrokeColor(color);\n    tracePolyline(drawContext, coilPoints, \"normal\");\n    drawContext.stroke();\n    if (line.allow) {\n        drawAllow(drawContext, line, exportType);\n    }\n    if (line.label) {\n        var diff = 1.0 + line.labelDiff;\n        var midDirection = lineMidDirection(line);\n        var pos = line.center().add(midDirection.rotation(Math.PI / 2).multi(diff));\n        var position = (0,_Core_TextPosition__WEBPACK_IMPORTED_MODULE_3__.textPosition)(line.label, pos, _Config__WEBPACK_IMPORTED_MODULE_0__.config);\n        drawContext.fillText(line.label, position.x, position.y);\n    }\n    drawContext.closePath();\n}\n/**\n * draw line\n */\nfunction drawLine(drawContext, line, exportType, color) {\n    if (color === void 0) { color = \"normal\"; }\n    if (line.style == \"wave\") {\n        ///MARK: not good\n        if (exportType == \"canvas\" || exportType == \"svg\") {\n            drawWaveLine(drawContext, line, exportType, color);\n            return;\n        }\n    }\n    if (line.style == \"coil\") {\n        ///MARK: not good\n        if (exportType == \"canvas\" || exportType == \"svg\") {\n            drawCoilLine(drawContext, line, exportType, color);\n            return;\n        }\n    }\n    if (line.style == \"double\") {\n        drawDoubleLine(drawContext, line, exportType, color);\n        return;\n    }\n    drawNormalLine(drawContext, line, exportType, color);\n}\n/**\n * draw allow\n */\nfunction drawAllow(drawContext, line, exportType, color) {\n    var _a;\n    if (color === void 0) { color = \"normal\"; }\n    var center = line.pointAt(0.5);\n    var baseDirection = lineMidDirection(line);\n    var direction = baseDirection.rotation((_a = line.arrowRotation) !== null && _a !== void 0 ? _a : 0);\n    var forward = direction.multi(0.4);\n    var normal = direction.rotation(Math.PI / 2).multi(0.35);\n    var tip = center.add(forward);\n    var tail = center.minus(forward);\n    var tail1 = tail.add(normal);\n    var tail2 = tail.minus(normal);\n    drawContext.beginPath();\n    drawContext.setStrokeColor(color);\n    drawContext.moveTo(tip.x, tip.y);\n    drawContext.lineTo(tail1.x, tail1.y, \"normal\");\n    drawContext.lineTo(tail2.x, tail2.y, \"normal\");\n    drawContext.closePath();\n    // context.arc(100, 10, 50, 0, Math.PI * 2)\n    drawContext.stroke();\n}\n/**\n * draw wave loop\n */\nfunction drawWaveLoop(drawContext, loop, exportType, color) {\n    // drawContext.beginPath()\n    if (color === void 0) { color = \"normal\"; }\n    var origin = loop.origin;\n    var radius = loop.radius;\n    var beginAngle = loop.loopBeginAngle;\n    var endAngle = loop.loopEndAngle;\n    var segmentNum = 360 * (radius / 2);\n    var segmentAngleWith = (Math.PI * 2) / segmentNum;\n    var snakeNum = 12;\n    var amplitude = 0.1 * radius;\n    if (beginAngle < 0) {\n        beginAngle += Math.PI * 2;\n    }\n    if (beginAngle > Math.PI * 2) {\n        beginAngle -= Math.PI * 2;\n    }\n    if (endAngle < 0) {\n        endAngle += Math.PI * 2;\n    }\n    if (endAngle > Math.PI * 2) {\n        endAngle -= Math.PI * 2;\n    }\n    if (beginAngle > endAngle) {\n        endAngle += Math.PI * 2;\n    }\n    for (var angle = beginAngle; angle < endAngle; angle = angle + segmentAngleWith) {\n        var unitVec = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(1, 0).rotation(angle);\n        var unitVec2 = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(1, 0).rotation(angle + segmentAngleWith);\n        var snake = amplitude * Math.sin(angle * snakeNum);\n        // let perpVec = unitVec.rotation(Math.PI / 2)\n        var startPoint = origin.add(unitVec.multi(radius + snake));\n        var endPoint = origin.add(unitVec2.multi(radius + snake));\n        var line = new _Core_Line__WEBPACK_IMPORTED_MODULE_2__.Line();\n        line.style = \"normal\";\n        line.origin = startPoint;\n        line.to = endPoint;\n        line.allow = false;\n        drawLine(drawContext, line, exportType, color);\n    }\n    // drawContext.setStrokeColor(color)\n    // // context.arc(100, 10, 50, 0, Math.PI * 2)\n    // let lineSyle: LineStyle = \"normal\"\n    // if (line.style == \"dash\") {\n    //     lineSyle = \"dash\"\n    // }\n    // drawContext.moveTo(origin.x, origin.y)\n    // for (let l = 0; l < line.length(); l += 0.1) {\n    //     let x = origin.x + unitVec.x * l + perpVec.x * Math.sin(l * 5) * 3 / 15\n    //     let y = origin.y + unitVec.y * l + perpVec.y * Math.sin(l * 5) * 3 / 15\n    //     loggerVer(`draw ${l} ${x} ${y}`)\n    //     drawContext.lineTo(x, y, lineSyle)\n    //     drawContext.moveTo(x, y)\n    //     drawContext.stroke()\n    // }\n    // if (line.allow) {\n    //     drawAllow(line, exportType)\n    // }\n    // drawContext.closePath()\n    // drawContext.setLineDash([])\n}\n/**\n * draw coil loop\n */\nfunction drawCoilLoop(drawContext, loop, exportType, color) {\n    if (color === void 0) { color = \"normal\"; }\n    var beginAngle = loop.loopBeginAngle;\n    var endAngle = loop.loopEndAngle;\n    if (beginAngle < 0) {\n        beginAngle += Math.PI * 2;\n    }\n    if (beginAngle > Math.PI * 2) {\n        beginAngle -= Math.PI * 2;\n    }\n    if (endAngle < 0) {\n        endAngle += Math.PI * 2;\n    }\n    if (endAngle > Math.PI * 2) {\n        endAngle -= Math.PI * 2;\n    }\n    if (beginAngle > endAngle) {\n        endAngle += Math.PI * 2;\n    }\n    drawContext.setStrokeColor(color);\n    var lineSyle = \"normal\";\n    if (loop.style == \"dash\") {\n        lineSyle = \"dash\";\n    }\n    var pathLength = loop.radius * (endAngle - beginAngle);\n    // 経路とその接線ベクトルの媒介変数表示\n    // 要素の種類によって決まる関数\n    var x;\n    var y;\n    var dx;\n    var dy;\n    {\n        // 弧長sから中心角angleへ\n        var angle_1 = function (s) {\n            return s / loop.radius + beginAngle;\n        };\n        x = function (s) {\n            return loop.radius * Math.cos(angle_1(s)) + loop.origin.x;\n        };\n        y = function (s) {\n            return loop.radius * Math.sin(angle_1(s)) + loop.origin.y;\n        };\n        dx = function (s) {\n            return Math.cos(angle_1(s) + Math.PI / 2);\n        };\n        dy = function (s) {\n            return Math.sin(angle_1(s) + Math.PI / 2);\n        };\n    }\n    // 線のスタイルとpathLengthによって決まる関数\n    var u;\n    var v;\n    {\n        // コイル線のパラメータ\n        var segmentLength = 1.0;\n        var aspect_1 = 0.9;\n        var amplitude_1 = 0.5;\n        // 経路の長さが1波長(segmentLength)よりも短い場合、線の装飾をしない。\n        if (pathLength < segmentLength) {\n            u = v = function (s) {\n                return 0;\n            };\n        }\n        else {\n            // コイルの巻き数\n            var n_1 = Math.floor(pathLength / segmentLength);\n            // 弧長sから位相tへ\n            var t_1 = function (s) {\n                return (s / pathLength) * (n_1 - 1 / 2) * 2 * Math.PI;\n            };\n            u = function (s) {\n                // 第2項は両端を閉じるための補正。経路の中間点で0。\n                return (aspect_1 * amplitude_1 * Math.cos(Math.PI - t_1(s)) -\n                    aspect_1 * amplitude_1 * ((2 * s) / pathLength - 1));\n            };\n            v = function (s) {\n                return amplitude_1 * Math.sin(Math.PI - t_1(s));\n            };\n        }\n    }\n    var resolution = 32; // 1巻きのコイルを32本の線分で描く程度\n    var ds, begin, end;\n    var f;\n    var g;\n    f = function (s) {\n        return x(s) + (u(s) * dx(s) - v(s) * dy(s));\n    };\n    g = function (s) {\n        return y(s) + (u(s) * dy(s) + v(s) * dx(s));\n    };\n    ds = (2 * Math.PI * 0.5) /*amplitude*/ / resolution;\n    begin = 0;\n    end = pathLength;\n    drawContext.beginPath();\n    {\n        var x_1, y_1, s = void 0;\n        (x_1 = f(begin)), (y_1 = g(begin));\n        drawContext.moveTo(x_1, y_1);\n        for (s = begin; s < end; s += ds) {\n            (x_1 = f(s)), (y_1 = g(s));\n            drawContext.lineTo(x_1, y_1, lineSyle);\n            drawContext.moveTo(x_1, y_1);\n        }\n        (x_1 = f(end)), (y_1 = g(end));\n        drawContext.lineTo(x_1, y_1, lineSyle);\n    }\n    drawContext.stroke();\n    drawContext.closePath();\n    /*\n      // 基準線\n      f = x\n      g = y\n      drawContext.beginPath()\n      {\n          let x: number, y: number, s: number\n  \n          x = f(begin), y = g(begin)\n          drawContext.moveTo(x, y)\n          for (s = begin; s < end; s += ds) {\n              x = f(s), y = g(s)\n              drawContext.lineTo(x, y, lineSyle)\n              drawContext.moveTo(x, y)\n          }\n          x = f(end), y = g(end)\n          drawContext.lineTo(x, y, lineSyle)\n      }\n      drawContext.stroke()\n      drawContext.closePath()\n  */\n}\n/**\n * draw a loop\n */\nfunction drawLoop(drawContext, loop, exportType, color) {\n    if (color === void 0) { color = \"normal\"; }\n    if (loop.style == \"wave\") {\n        ///MARK: not good\n        if (exportType == \"canvas\" || exportType == \"svg\") {\n            drawWaveLoop(drawContext, loop, exportType, color);\n            return;\n        }\n    }\n    if (loop.style == \"coil\") {\n        ///MARK: not good\n        if (exportType == \"canvas\" || exportType == \"svg\") {\n            drawCoilLoop(drawContext, loop, exportType, color);\n            return;\n        }\n    }\n    drawContext.beginPath();\n    drawContext.setStrokeColor(color);\n    drawContext.setFillColor(color);\n    var lineStyle = \"normal\";\n    if (loop.style == \"dash\") {\n        lineStyle = \"dash\";\n    }\n    if (loop.style == \"wave\") {\n        lineStyle = \"wave\";\n    }\n    if (loop.style == \"coil\") {\n        lineStyle = \"coil\";\n    }\n    drawContext.arc(loop.origin.x, loop.origin.y, loop.radius, loop.loopBeginAngle, loop.loopEndAngle, lineStyle, loop.fill);\n    drawContext.stroke();\n    if (loop.allow) {\n        drawLoopAllow(drawContext, loop, exportType, color);\n    }\n    if (loop.label) {\n        var position = (0,_Core_TextPosition__WEBPACK_IMPORTED_MODULE_3__.textPosition)(loop.label, loop.origin, _Config__WEBPACK_IMPORTED_MODULE_0__.config);\n        drawContext.fillText(loop.label, position.x, position.y);\n    }\n    if (loop.labels) {\n        loop.labels.forEach(function (lab) {\n            var diff = 0.5 + lab.diff;\n            var pos = loop.origin.add(new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(0, -1).multi(loop.radius + diff).rotation(lab.angle));\n            var position = (0,_Core_TextPosition__WEBPACK_IMPORTED_MODULE_3__.textPosition)(lab.label, pos, _Config__WEBPACK_IMPORTED_MODULE_0__.config);\n            drawContext.fillText(lab.label, position.x, position.y);\n        });\n    }\n    drawContext.closePath();\n    // drawContext.setLineDash([])\n}\nfunction drawLoopAllow(drawContext, loop, exportType, color) {\n    var diff = loop.loopEndAngle - loop.loopBeginAngle;\n    if (diff <= 0) {\n        diff += Math.PI * 2;\n    }\n    if (diff < 0.01) {\n        return;\n    }\n    var mid = loop.loopBeginAngle + diff / 2;\n    var radial = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(Math.cos(mid), Math.sin(mid));\n    var tangentUnit = new _Core_Vector__WEBPACK_IMPORTED_MODULE_4__.Vector(-Math.sin(mid), Math.cos(mid));\n    var anchor = loop.origin.add(radial.multi(loop.radius));\n    var arrowLength = Math.max(0.35, Math.min(loop.radius * 0.4, 1.0));\n    var arrowWidth = arrowLength * 0.8;\n    var front = anchor.add(tangentUnit.multi(arrowLength));\n    var perp = tangentUnit.rotation(Math.PI / 2).multi(arrowWidth);\n    var tail1 = anchor.minus(perp);\n    var tail2 = anchor.add(perp);\n    drawContext.beginPath();\n    drawContext.setStrokeColor(color);\n    drawContext.moveTo(front.x, front.y);\n    drawContext.lineTo(tail1.x, tail1.y, \"normal\");\n    drawContext.lineTo(tail2.x, tail2.y, \"normal\");\n    drawContext.closePath();\n    drawContext.stroke();\n}\n/**\n * draw point\n */\nfunction drawPoint(drawContext, point, exportType, color) {\n    if (color === void 0) { color = \"normal\"; }\n    var x = point.x;\n    var y = point.y;\n    drawContext.beginPath();\n    drawContext.setFillColor(color);\n    // loggerVer(`drawPoint ${x}_${y}`);\n    drawContext.fillRect(x - 1 / 15, y - 1 / 15, 3 / 15, 3 / 15);\n    drawContext.closePath();\n}\nfunction drawText(drawContext, str, exportType, color) {\n    if (color === void 0) { color = \"normal\"; }\n    var x = str.origin.x;\n    var y = str.origin.y;\n    drawContext.beginPath();\n    drawContext.setFillColor(color);\n    drawContext.fillText(str.label, x, y);\n    // loggerVer(`drawText ${x}_${y}`);\n    drawContext.closePath();\n}\n// function drawVertex(loop: Vertex) {\n//     const scale = config.scale\n//     context.beginPath()\n//     context.arc(loop.origin.x * scale,\n//         loop.origin.y * scale,\n//         loop.radius * scale, 0, Math.PI * 2)\n//     context.stroke()\n//     if (loop.fill) {\n//         context.fill()\n//     }\n//     if (loop.label) {\n//         let position = textPosition(loop.label, loop.origin, config)\n//         context.fillText(loop.label, position.x * scale, position.y * scale)\n//     }\n//     if (loop.labels) {\n//         loop.labels.forEach((lab) => {\n//             const diff = 0.5 + lab.diff\n//             let pos = loop.origin.add(new Vector(0, -1).multi(loop.radius + diff).rotation(lab.angle))\n//             let position = textPosition(lab.label, pos, config)\n//             context.fillText(lab.label, position.x * scale, position.y * scale)\n//         })\n//     }\n// }\n\n\n//# sourceURL=webpack://rdfeyn/./src/UI/draw.ts?");

/***/ }),

/***/ "./src/looger.ts":
/*!***********************!*\
  !*** ./src/looger.ts ***!
  \***********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"loggerOn\": () => (/* binding */ loggerOn),\n/* harmony export */   \"loggerVer\": () => (/* binding */ loggerVer)\n/* harmony export */ });\n/* harmony import */ var _Config__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./Config */ \"./src/Config.ts\");\n\nfunction loggerVer(text) {\n    if (_Config__WEBPACK_IMPORTED_MODULE_0__.config.log == \"VER\") {\n        console.log(text);\n    }\n}\nfunction loggerOn(text) {\n    if (_Config__WEBPACK_IMPORTED_MODULE_0__.config.log == \"ON\" || _Config__WEBPACK_IMPORTED_MODULE_0__.config.log == \"VER\") {\n        console.log(text);\n    }\n}\n\n\n//# sourceURL=webpack://rdfeyn/./src/looger.ts?");

/***/ }),

/***/ "./src/quantumSketch.ts":
/*!******************************!*\
  !*** ./src/quantumSketch.ts ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _UI_DrawContext__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./UI/DrawContext */ \"./src/UI/DrawContext.ts\");\n/* harmony import */ var _UI_RDDraw__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./UI/RDDraw */ \"./src/UI/RDDraw.ts\");\n// \"QuantumSketch  So Katagiri\"\n\n\nvar canvas = document.getElementById(\"canvas\");\nvar context_ = canvas.getContext(\"2d\");\nvar drawContext = new _UI_DrawContext__WEBPACK_IMPORTED_MODULE_0__.DrawContext(context_);\nnew _UI_RDDraw__WEBPACK_IMPORTED_MODULE_1__.RDDraw(canvas, drawContext);\n\n\n//# sourceURL=webpack://rdfeyn/./src/quantumSketch.ts?");

/***/ })

/******/ 	});
/************************************************************************/
/******/ 	// The module cache
/******/ 	var __webpack_module_cache__ = {};
/******/ 	
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/ 		// Check if module is in cache
/******/ 		var cachedModule = __webpack_module_cache__[moduleId];
/******/ 		if (cachedModule !== undefined) {
/******/ 			return cachedModule.exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = __webpack_module_cache__[moduleId] = {
/******/ 			// no module.id needed
/******/ 			// no module.loaded needed
/******/ 			exports: {}
/******/ 		};
/******/ 	
/******/ 		// Execute the module function
/******/ 		__webpack_modules__[moduleId](module, module.exports, __webpack_require__);
/******/ 	
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/ 	
/************************************************************************/
/******/ 	/* webpack/runtime/define property getters */
/******/ 	(() => {
/******/ 		// define getter functions for harmony exports
/******/ 		__webpack_require__.d = (exports, definition) => {
/******/ 			for(var key in definition) {
/******/ 				if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {
/******/ 					Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });
/******/ 				}
/******/ 			}
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/hasOwnProperty shorthand */
/******/ 	(() => {
/******/ 		__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/make namespace object */
/******/ 	(() => {
/******/ 		// define __esModule on exports
/******/ 		__webpack_require__.r = (exports) => {
/******/ 			if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 				Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 			}
/******/ 			Object.defineProperty(exports, '__esModule', { value: true });
/******/ 		};
/******/ 	})();
/******/ 	
/************************************************************************/
/******/ 	
/******/ 	// startup
/******/ 	// Load entry module and return exports
/******/ 	// This entry module can't be inlined because the eval devtool is used.
/******/ 	var __webpack_exports__ = __webpack_require__("./src/quantumSketch.ts");
/******/ 	
/******/ })()
;